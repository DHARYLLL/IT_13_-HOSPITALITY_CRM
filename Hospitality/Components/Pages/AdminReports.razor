@page "/admin/reports"
@inject NavigationManager Navigation
@inject Hospitality.Services.BookingService BookingService
@inject Hospitality.Services.RoomService RoomService
@using System.Globalization

<link rel="stylesheet" href="css/admin.css" />
<link rel="stylesheet" href="css/admin-reports.css" />

<div class="admin-page">
	<!-- Sidebar -->
	<aside class="admin-sidebar">
		<div class="sidebar-header">
			<img src="images/InnSight.png" alt="InnSight" class="sidebar-logo" />
			<div class="admin-console-text">
				<h4>InnSight Hotels</h4>
				<span>Admin console</span>
			</div>
		</div>
		<nav class="sidebar-nav">
			<a href="/admin" class="nav-item"><span class="nav-icon"><i class="icon icon-users"></i></span><span>EMPLOYEES</span></a>
			<a href="/admin/dashboard" class="nav-item"><span class="nav-icon"><i class="icon icon-dashboard"></i></span><span>DASHBOARD</span></a>
			<a href="/admin/rooms" class="nav-item"><span class="nav-icon"><i class="icon icon-rooms"></i></span><span>ROOMS</span></a>
			<a href="/admin/rewards" class="nav-item"><span class="nav-icon"><i class="icon icon-gift"></i></span><span>REWARDS</span></a>
			<a href="/admin/messages" class="nav-item"><span class="nav-icon"><i class="icon icon-messages"></i></span><span>MESSAGES</span></a>
			<a href="/admin/reports" class="nav-item active"><span class="nav-icon"><i class="icon icon-reports"></i></span><span>REPORTS & ANALYTICS</span></a>
			<a href="/admin/analytics" class="nav-item"><span class="nav-icon"><i class="icon icon-analytics"></i></span><span>SALES & MARKETING</span></a>
		</nav>
	</aside>

	<!-- Main Content -->
	<main class="admin-main">
		<header class="admin-header">
			<div class="header-left">
				<h1 class="page-title">Bookings & revenue reports</h1>
				<p class="page-subtitle">
					@if (dateRangeDays >= 3650)
					{
						<text>Showing all-time data across your InnSight properties.</text>
					}
					else if (dateRangeDays >= 365)
					{
						<text>Showing last @(dateRangeDays / 365) year of data across your InnSight properties.</text>
					}
					else
					{
						<text>Showing last @dateRangeDays days of data across your InnSight properties.</text>
					}
				</p>
			</div>
			<div class="header-actions">
				<button class="btn-filter" @onclick="() => ChangeDateRange(30)">
					<span class="filter-icon"><i class="icon icon-calendar"></i></span> Last @dateRangeDays days
				</button>
				<select class="btn-filter" style="padding: 8px 16px; cursor: pointer; font-size: 14px; min-width: 150px;" @onchange="OnDateRangeChanged">
					<option value="7" selected="@(dateRangeDays == 7)">Last 7 days</option>
					<option value="30" selected="@(dateRangeDays == 30)">Last 30 days</option>
					<option value="90" selected="@(dateRangeDays == 90)">Last 90 days</option>
					<option value="365" selected="@(dateRangeDays == 365)">Last Year</option>
					<option value="3650" selected="@(dateRangeDays == 3650)">All Time</option>
				</select>
				<button class="btn-filter">
					<span class="filter-icon"><i class="icon icon-filter"></i></span> All properties
				</button>
				<button class="btn-export" @onclick="ExportCSV">
					<span class="export-icon"><i class="icon icon-export"></i></span> Export CSV
				</button>
			</div>
		</header>

		@if (loading)
		{
			<div class="loading-container">
				<div class="spinner"></div>
				<p>Loading reports...</p>
			</div>
		}
		else
		{
			<!-- Key Metrics Cards -->
			<div class="metrics-grid">
				<div class="metric-card">
					<div class="metric-header">
						<span class="metric-label">Total revenue</span>
						@if (revenueGrowth > 0)
						{
							<span class="metric-change positive">+$@revenueGrowth.ToString("N0") <small>Earned</small></span>
						}
					</div>
					<div class="metric-value">$@totalRevenue.ToString("N0")</div>
					<div class="metric-footer">From booked nights, fees, and taxes.</div>
				</div>

				<div class="metric-card">
					<div class="metric-header">
						<span class="metric-label">Bookings</span>
					</div>
					<div class="metric-value">@totalBookings</div>
					<div class="metric-footer">Confirmed reservations across all locations.</div>
				</div>

				<div class="metric-card">
					<div class="metric-header">
						<span class="metric-label">Occupancy rate</span>
						@if (occupancyRate >= 80)
						{
							<span class="metric-badge high">High this week</span>
						}
						else if (occupancyRate >= 60)
						{
							<span class="metric-badge medium">Moderate</span>
						}
						else
						{
							<span class="metric-badge low">Low occupancy</span>
						}
					</div>
					<div class="metric-value">@occupancyRate%</div>
					<div class="metric-footer">Weighted across all room types.</div>
				</div>

				<div class="metric-card">
					<div class="metric-header">
						<span class="metric-label">Average daily rate</span>
					</div>
					<div class="metric-value">$@averageDailyRate.ToString("N0")</div>
					<div class="metric-footer">Reflects discounts and loyalty promotions.</div>
					<div class="metric-adr">ADR</div>
				</div>
			</div>

			<!-- Charts Section -->
			<div class="charts-grid">
				<!-- Revenue by Day Chart -->
				<div class="chart-card">
					<div class="chart-header">
						<div>
							<h3 class="chart-title">?? Revenue by day</h3>
							<p class="chart-subtitle">Total revenue by date for the selected period (Last @dateRangeDays days).</p>
						</div>
						<div class="chart-legend">
							<span class="legend-item">
								<span class="legend-dot room-revenue"></span> Room revenue
							</span>
							<span class="legend-item">
								<span class="legend-dot cancellation"></span> Cancellation fees
							</span>
						</div>
					</div>
					<div class="chart-content">
						<div class="chart-placeholder">
							<div class="chart-bars">
								@foreach (var day in revenueByDay.TakeLast(14))
								{
									<div class="chart-bar-group">
										<div class="chart-bar" style="height: @(GetBarHeight(day.Revenue))%">
											<div class="bar-tooltip">$@day.Revenue.ToString("N0")</div>
										</div>
										<span class="chart-label">@day.DayLabel</span>
									</div>
								}
							</div>
						</div>
						<div class="chart-footer">
							<span class="chart-note">Peak revenue: <strong>$@peakRevenue.ToString("N0")</strong></span>
							<span class="chart-note-right">Avg per day: <strong>$@avgPerDay.ToString("N0")</strong></span>
						</div>
					</div>
				</div>

				<!-- Key Performance Chart -->
				<div class="chart-card">
					<div class="chart-header">
						<div>
							<h3 class="chart-title">?? Key performance</h3>
							<p class="chart-subtitle">Insights on guest occupancy and loyalty.</p>
						</div>
					</div>
					<div class="kpi-grid">
						<div class="kpi-item">
							<div class="kpi-label">RevPAR</div>
							<div class="kpi-value">$@revPAR.ToString("N0")</div>
							<div class="kpi-change positive">+@((revPAR / (averageDailyRate > 0 ? averageDailyRate : 1) * 100 - 100).ToString("N1"))%</div>
							<div class="kpi-note">Revenue per available room</div>
						</div>
						<div class="kpi-item">
							<div class="kpi-label">Cancellation rate</div>
							<div class="kpi-value">@cancellationRate.ToString("N1")%</div>
							@if (cancellationRate > 10)
							{
								<div class="kpi-change negative">+@((cancellationRate - 6.6m).ToString("N1")) pts</div>
							}
							else
							{
								<div class="kpi-change positive">-@((6.6m - cancellationRate).ToString("N1")) pts</div>
							}
							<div class="kpi-note">Share of cancelled bookings</div>
						</div>
						<div class="kpi-item">
							<div class="kpi-label">Avg stay duration</div>
							<div class="kpi-value">@avgStayDuration.ToString("N1")</div>
							<div class="kpi-change positive">+0.5 nights</div>
							<div class="kpi-note">Average nights per booking</div>
						</div>
						<div class="kpi-item">
							<div class="kpi-label">Total guests</div>
							<div class="kpi-value">@totalGuests</div>
							<div class="kpi-change positive">+@((totalGuests * 0.12).ToString("N0"))</div>
							<div class="kpi-note">Unique guests served</div>
						</div>
					</div>
					<button class="btn-export-report" @onclick="ExportPerformanceReport">
						<span>??</span> Export report
					</button>
				</div>
			</div>

			<!-- Recent Bookings Detail -->
			<div class="bookings-detail-card">
				<div class="detail-header">
					<div>
						<h3 class="detail-title">?? Recent bookings detail</h3>
						<p class="detail-subtitle">All reservations in the system (not limited by date range)</p>
					</div>
					<div class="detail-filters">
						<button class="filter-btn @(statusFilter == "All" ? "active" : "")" @onclick='() => SetStatusFilter("All")'>Status: @statusFilter</button>
						<button class="filter-btn @(channelFilter == "All" ? "active" : "")" @onclick='() => SetChannelFilter("All")'>Channel: @channelFilter</button>
					</div>
				</div>
				<div class="bookings-table-wrapper">
					<table class="bookings-table">
						<thead>
							<tr>
								<th>Booking ID</th>
								<th>Guest</th>
								<th>Room</th>
								<th>Check-in</th>
								<th>Nights</th>
								<th>Status</th>
								<th>Total</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var booking in GetFilteredBookings())
							{
								<tr>
									<td class="booking-id">#@booking.BookingId.ToString("D7")</td>
									<td>
										<div class="guest-info">
											<div class="guest-avatar">@GetInitials(booking.GuestName)</div>
											<div>
												<div class="guest-name">@booking.GuestName</div>
												<div class="guest-email">@booking.GuestEmail</div>
											</div>
										</div>
									</td>
									<td>@booking.RoomType</td>
									<td>@booking.CheckInDate.ToString("MMM dd, yyyy")</td>
									<td>@booking.Nights</td>
									<td><span class="status-badge status-@booking.Status.ToLower().Replace(" ", "-")">@booking.Status</span></td>
									<td class="total-amount">$@booking.Total.ToString("N2")</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
				<div class="table-footer">
					<span class="table-info">Showing @GetFilteredBookings().Count() of @recentBookings.Count bookings</span>
					<div class="pagination-controls">
						<button class="page-btn" disabled>? Previous</button>
						<button class="page-btn active">1</button>
						<button class="page-btn">2</button>
						<button class="page-btn">3</button>
						<button class="page-btn">Next ?</button>
					</div>
				</div>
			</div>
		}
	</main>
</div>

@code {
	bool loading = true;
	int dateRangeDays = 3650; // Changed from 30 to 3650 (All Time) as default
	string statusFilter = "All";
	string channelFilter = "All";

	// Metrics
	decimal totalRevenue = 0;
	decimal revenueGrowth = 0;
	int totalBookings = 0;
	int occupancyRate = 0;
	decimal averageDailyRate = 0;
	decimal revPAR = 0;
	decimal cancellationRate = 0;
	decimal avgStayDuration = 0;
	int totalGuests = 0;
	decimal peakRevenue = 0;
	decimal avgPerDay = 0;

	List<DayRevenue> revenueByDay = new();
	List<RecentBooking> recentBookings = new();

	protected override async Task OnInitializedAsync()
	{
		await LoadReportData();
	}

	async Task LoadReportData()
	{
		loading = true;
		StateHasChanged();

		try
		{
			Console.WriteLine("?? Starting to load report data...");
			Console.WriteLine($"?? Date range: Last {dateRangeDays} days (from {DateTime.Today.AddDays(-dateRangeDays):yyyy-MM-dd} to {DateTime.Today:yyyy-MM-dd})");
			
			// Load real booking and room data
			var rooms = await RoomService.GetRoomsAsync();
			Console.WriteLine($"? Loaded {rooms.Count} rooms");
			
			if (rooms.Count == 0)
			{
				Console.WriteLine("?? WARNING: No rooms found in database!");
			}
			else
			{
				Console.WriteLine($"?? Room statuses: {string.Join(", ", rooms.Select(r => $"{r.room_number}={r.room_status}"))}");
			}
			
			var metrics = await BookingService.GetBookingMetricsAsync(dateRangeDays);
			Console.WriteLine($"? Loaded metrics - Bookings: {metrics.TotalBookings}, Revenue: ${metrics.TotalRevenue}");
			
			if (metrics.TotalBookings == 0)
			{
				Console.WriteLine("?? No bookings found in the specified date range - trying to load ALL bookings...");
				
				// Try loading ALL bookings (no date filter)
				var allBookings = await BookingService.GetAllBookingsWithClientsAsync(null, null);
				Console.WriteLine($"?? Found {allBookings.Count} total bookings in database");
				
				if (allBookings.Count > 0)
				{
					Console.WriteLine($"?? Bookings exist but are outside the {dateRangeDays}-day range");
					Console.WriteLine($"?? First booking date: {allBookings.Min(b => b.check_in_date):yyyy-MM-dd}");
					Console.WriteLine($"?? Last booking date: {allBookings.Max(b => b.check_in_date):yyyy-MM-dd}");
				}
			}
			
			var dailyRevenues = await BookingService.GetDailyRevenueAsync(dateRangeDays);
			Console.WriteLine($"? Loaded {dailyRevenues.Count} days of revenue data");
			
			// Load ALL bookings for the table (not filtered by date range)
			var bookings = await BookingService.GetAllBookingsWithClientsAsync(null, null);
			Console.WriteLine($"? Loaded {bookings.Count} bookings with client data (showing ALL bookings)");

			// Set metrics from real data (will be 0 if no data exists in date range)
			totalBookings = metrics.TotalBookings;
			totalRevenue = metrics.TotalRevenue;
			totalGuests = metrics.TotalGuests;
			avgStayDuration = metrics.AvgStayDuration;
			averageDailyRate = metrics.AverageDailyRate;

			Console.WriteLine($"?? Metrics set - Total Bookings: {totalBookings}, Total Revenue: ${totalRevenue}, Guests: {totalGuests}");
			Console.WriteLine($"?? Avg Stay: {avgStayDuration} nights, Avg Daily Rate: ${averageDailyRate}");

			// Calculate occupancy rate from rooms
			if (rooms.Any())
			{
				var occupiedRooms = rooms.Count(r => r.room_status == "Occupied" || r.room_status == "Reserved");
				var totalRooms = rooms.Count;
				occupancyRate = totalRooms > 0 ? (int)((double)occupiedRooms / totalRooms * 100) : 0;
				Console.WriteLine($"?? Occupancy: {occupiedRooms}/{totalRooms} = {occupancyRate}%");
			}
			else
			{
				occupancyRate = 0;
				Console.WriteLine("?? No rooms found - occupancy set to 0%");
			}

			// Calculate RevPAR (Revenue Per Available Room)
			if (rooms.Any() && dateRangeDays > 0)
			{
				var totalRoomNights = rooms.Count * dateRangeDays;
				revPAR = totalRoomNights > 0 ? totalRevenue / totalRoomNights : 0;
				Console.WriteLine($"?? RevPAR: ${revPAR:F2} (Total revenue: ${totalRevenue} / {totalRoomNights} room-nights)");
			}
			else
			{
				revPAR = 0;
			}

			// Calculate revenue growth (compare to previous period)
			var previousPeriodStart = DateTime.Today.AddDays(-dateRangeDays * 2);
			var previousPeriodEnd = DateTime.Today.AddDays(-dateRangeDays);
			var previousMetrics = await BookingService.GetBookingMetricsAsync(dateRangeDays);
			revenueGrowth = totalRevenue - previousMetrics.TotalRevenue;
			Console.WriteLine($"?? Revenue growth: ${revenueGrowth} (Current: ${totalRevenue} vs Previous: ${previousMetrics.TotalRevenue})");

			// Generate revenue by day chart data
			revenueByDay.Clear();
			
			// Fill in all days in range, including days with no bookings
			for (int i = dateRangeDays; i >= 0; i--)
			{
				var date = DateTime.Today.AddDays(-i);
				var dayRevenue = dailyRevenues.FirstOrDefault(d => d.Date.Date == date.Date);
				
				revenueByDay.Add(new DayRevenue
				{
					Date = date,
					DayLabel = date.ToString("MMM dd"),
					Revenue = dayRevenue?.Revenue ?? 0
				});
			}

			// Calculate peak and average revenue per day
			if (revenueByDay.Any())
			{
				peakRevenue = revenueByDay.Max(d => d.Revenue);
				avgPerDay = revenueByDay.Average(d => d.Revenue);
				Console.WriteLine($"?? Daily revenue - Peak: ${peakRevenue}, Avg: ${avgPerDay:F2}");
			}

			// Calculate cancellation rate (placeholder - need to add cancelled_bookings tracking)
			cancellationRate = 0; // TODO: Implement cancellation tracking

			// Load ALL recent bookings for table (not filtered by date range)
			recentBookings = bookings.Select(b => new RecentBooking
			{
				BookingId = b.booking_id,
				GuestName = $"{b.client_first_name} {b.client_last_name}",
				GuestEmail = b.client_email ?? "",
				RoomType = b.room_name ?? "N/A",
				CheckInDate = b.check_in_date,
				Nights = (b.check_out_date - b.check_in_date).Days,
				Status = GetBookingStatus(b),
				Total = b.total_amount ?? 0,
				Channel = "Website" // TODO: Add channel tracking to database
			}).OrderByDescending(b => b.CheckInDate).ToList();

			Console.WriteLine($"? Successfully loaded {recentBookings.Count} recent bookings for display");
			Console.WriteLine("? Report data loaded successfully from DATABASE!");
			Console.WriteLine($"?? SUMMARY: {totalBookings} bookings in last {dateRangeDays} days, ${totalRevenue} revenue, {totalGuests} guests, {occupancyRate}% occupancy");
			Console.WriteLine($"?? Showing ALL {recentBookings.Count} bookings in Recent Bookings table");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"? Error loading report data: {ex.Message}");
			Console.WriteLine($"? Stack trace: {ex.StackTrace}");
			if (ex.InnerException != null)
			{
				Console.WriteLine($"? Inner exception: {ex.InnerException.Message}");
			}
			// Even on error, keep values at 0 instead of loading sample data
			Console.WriteLine("?? Error occurred - displaying zero values");
		}
		finally
		{
			loading = false;
			StateHasChanged();
		}
	}

	string GetBookingStatus(Hospitality.Models.Booking booking)
	{
		if (!string.IsNullOrEmpty(booking.booking_status))
		{
			return booking.booking_status switch
			{
				"completed" => "Completed",
				"cancelled" => "Cancelled",
				_ => "Confirmed"
			};
		}

		// Determine status based on dates
		var today = DateTime.Today;
		if (booking.check_out_date < today)
			return "Completed";
		else if (booking.check_in_date <= today && booking.check_out_date >= today)
			return "Checked in";
		else
			return "Confirmed";
	}

	double GetBarHeight(decimal revenue)
	{
		var maxRevenue = revenueByDay.Any() ? revenueByDay.Max(d => d.Revenue) : 1;
		return maxRevenue > 0 ? (double)(revenue / maxRevenue * 100) : 0;
	}

	string GetInitials(string name)
	{
		if (string.IsNullOrWhiteSpace(name)) return "G";
		var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
		return parts.Length >= 2 ? $"{parts[0][0]}{parts[1][0]}" : name.Substring(0, Math.Min(2, name.Length));
	}

	IEnumerable<RecentBooking> GetFilteredBookings()
	{
		var filtered = recentBookings.AsEnumerable();
		
		if (statusFilter != "All")
		{
			filtered = filtered.Where(b => b.Status == statusFilter);
		}
		
		if (channelFilter != "All")
		{
			filtered = filtered.Where(b => b.Channel == channelFilter);
		}
		
		return filtered.Take(10);
	}

	void SetStatusFilter(string status)
	{
		statusFilter = status;
		StateHasChanged();
	}

	void SetChannelFilter(string channel)
	{
		channelFilter = channel;
		StateHasChanged();
	}

	void ChangeDateRange(int days)
	{
		dateRangeDays = days;
		_ = LoadReportData();
	}

	void OnDateRangeChanged(ChangeEventArgs e)
	{
		if (int.TryParse(e.Value?.ToString(), out var days))
		{
			dateRangeDays = days;
			_ = LoadReportData();
		}
	}

	void ExportCSV()
	{
		Console.WriteLine("?? Exporting CSV report...");
		// Implement CSV export logic
	}

	void ExportPerformanceReport()
	{
		Console.WriteLine("?? Exporting performance report...");
		// Implement PDF export logic
	}

	// Models
	class DayRevenue
	{
		public DateTime Date { get; set; }
		public string DayLabel { get; set; } = "";
		public decimal Revenue { get; set; }
	}

	class RecentBooking
	{
		public int BookingId { get; set; }
		public string GuestName { get; set; } = "";
		public string GuestEmail { get; set; } = "";
		public string RoomType { get; set; } = "";
		public DateTime CheckInDate { get; set; }
		public int Nights { get; set; }
		public string Status { get; set; } = "";
		public decimal Total { get; set; }
		public string Channel { get; set; } = "";
	}
}
