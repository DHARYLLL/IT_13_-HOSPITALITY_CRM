@page "/admin"
@inject NavigationManager Navigation
@inject Hospitality.Services.UserService UserService

<link rel="stylesheet" href="css/admin.css" />
<link rel="stylesheet" href="css/admin-employees-modern.css" />

<div class="admin-page">
	<!-- Sidebar -->
	<aside class="admin-sidebar">
		<div class="sidebar-header">
			<img src="images/InnSight.png" alt="InnSight" class="sidebar-logo" />
			<div class="admin-console-text">
				<h4>InnSight Hotels</h4>
				<span>Admin console</span>
			</div>
		</div>
		<nav class="sidebar-nav">
			<a href="/admin/dashboard" class="nav-item">
				<span class="nav-icon"><i class="icon icon-dashboard"></i></span>
				<span>DASHBOARD</span>
			</a>
			<a href="/admin" class="nav-item active">
				<span class="nav-icon"><i class="icon icon-users"></i></span>
				<span>EMPLOYEES</span>
			</a>
			<a href="/admin/rooms" class="nav-item">
				<span class="nav-icon"><i class="icon icon-rooms"></i></span>
				<span>ROOMS</span>
			</a>
			<a href="/admin/walkin" class="nav-item">
				<span class="nav-icon"><i class="icon icon-bookings-detail"></i></span>
				<span>WALK-IN</span>
			</a>
			<a href="/admin/rewards" class="nav-item">
				<span class="nav-icon"><i class="icon icon-gift"></i></span>
				<span>REWARDS</span>
			</a>
			<a href="/admin/messages" class="nav-item">
				<span class="nav-icon"><i class="icon icon-messages"></i></span>
				<span>MESSAGES</span>
			</a>
			<a href="/admin/reports" class="nav-item">
				<span class="nav-icon"><i class="icon icon-reports"></i></span>
				<span>REPORTS</span>
			</a>
			<a href="/admin/analytics" class="nav-item">
				<span class="nav-icon"><i class="icon icon-analytics"></i></span>
				<span>SALES & MARKETING</span>
			</a>
		</nav>
	</aside>

	<!-- Main Content -->
	<main class="admin-main">
		<header class="admin-header">
			<div class="header-left">
				<h1 class="page-title">Team Management</h1>
				<p class="page-subtitle">Manage your team members and staff</p>
			</div>
			<div class="header-actions">
				<button class="icon-btn" title="Notifications"><span class="badge-dot">3</span><i class="icon icon-notification"></i></button>
				<button class="icon-btn" title="Logout" @onclick="Logout"><i class="icon icon-logout"></i></button>
			</div>
		</header>

		<!-- Stats Bar -->
		<div class="stats-bar">
			<div class="stat-card">
				<div class="stat-icon purple">
					<i class="icon icon-users"></i>
				</div>
				<div class="stat-content">
					<div class="stat-number">@totalCount</div>
					<div class="stat-text">Total Employees</div>
				</div>
			</div>
			<div class="stat-card">
				<div class="stat-icon blue">
					<i class="icon icon-shield"></i>
				</div>
				<div class="stat-content">
					<div class="stat-number">@employees.Count(e => e.roleName == "admin")</div>
					<div class="stat-text">Administrators</div>
				</div>
			</div>
			<div class="stat-card">
				<div class="stat-icon green">
					<i class="icon icon-users"></i>
				</div>
				<div class="stat-content">
					<div class="stat-number">@employees.Count(e => e.roleName == "staff")</div>
					<div class="stat-text">Staff Members</div>
				</div>
			</div>
		</div>

		<div class="toolbar">
			<div class="search-box">
				<span><i class="icon icon-search"></i></span>
				<input type="text" placeholder="Search by name or email..." @bind="searchQuery" @bind:event="oninput" />
			</div>
			<div class="filter-pills">
				<button class="filter-pill @(string.IsNullOrEmpty(roleFilter) ? "active" : "")" @onclick='() => SetRoleFilter("")'>
					All <span class="count">@totalCount</span>
				</button>
				<button class="filter-pill @(roleFilter == "admin" ? "active" : "")" @onclick='() => SetRoleFilter("admin")'>
					Admin <span class="count">@employees.Count(e => e.roleName == "admin")</span>
				</button>
				<button class="filter-pill @(roleFilter == "staff" ? "active" : "")" @onclick='() => SetRoleFilter("staff")'>
					Staff <span class="count">@employees.Count(e => e.roleName == "staff")</span>
				</button>
			</div>
			<button class="btn-add-new" @onclick="ShowAddModal">
				<span>+</span> Add New Employee
			</button>
		</div>

		@if (loading)
		{
			<div class="loading-container">
				<div class="spinner"></div>
				<p>Loading employees...</p>
			</div>
		}
		else if (loadError)
		{
			<div class="error-banner">
				<span><i class="icon icon-error"></i></span>
				<span>Failed to load employees. Please try again.</span>
				<button class="btn-add-new" style="margin-left: auto;" @onclick="LoadPageAsync">Retry</button>
			</div>
		}
		else if (!EmployeesPage.Any())
		{
			<div class="empty-state-modern">
				<div class="empty-state-icon">👥</div>
				<h3 class="empty-state-title">No employees found</h3>
				<p class="empty-state-text">@(string.IsNullOrWhiteSpace(searchQuery) && string.IsNullOrEmpty(roleFilter) ? "Start by adding your first employee" : "Try adjusting your search or filters")</p>
				@if (string.IsNullOrWhiteSpace(searchQuery) && string.IsNullOrEmpty(roleFilter))
				{
					<button class="btn-add-new" @onclick="ShowAddModal">
						<span>+</span> Add Your First Employee
					</button>
				}
			</div>
		}
		else
		{
			<!-- Employee Cards Grid -->
			<div class="employees-grid">
				@foreach (var emp in EmployeesPage)
				{
					<div class="employee-card-modern">
						<div class="employee-avatar-modern">@GetInitials(emp)</div>
						<div class="role-badge @emp.roleName">
							<i class="icon icon-@(emp.roleName == "admin" ? "shield" : "user")"></i>
							@emp.roleName
						</div>
						<h3 class="employee-name-modern">@GetFullName(emp)</h3>
						<p class="employee-email-modern">@emp.user_email</p>
						@if (!string.IsNullOrWhiteSpace(emp.user_contact_number))
						{
							<div class="contact-info">
								<div class="contact-item">
									<i class="icon icon-phone"></i>
									@emp.user_contact_number
								</div>
							</div>
						}
						<div class="employee-actions-modern">
							<button class="btn-employee-action primary" @onclick="() => Edit(emp)">
								<i class="icon icon-edit"></i> Edit
							</button>
							<button class="btn-employee-action secondary">
								<i class="icon icon-email"></i>
							</button>
						</div>
					</div>
				}
			</div>

			<!-- Modern Pagination -->
			<div class="pagination-modern">
				<div class="pagination-controls">
					<button class="page-btn-modern" disabled="@(!CanPrev)" @onclick="FirstPage">
						<i class="icon icon-chevron-double-left"></i>
					</button>
					<button class="page-btn-modern" disabled="@(!CanPrev)" @onclick="PrevPage">
						<i class="icon icon-chevron-left"></i>
					</button>
					
					@foreach (var p in GetVisiblePageNumbers())
					{
						@if (p == -1)
						{
							<span class="page-dots">...</span>
						}
						else
						{
							<button class="page-btn-modern @(p == page ? "active" : "")" @onclick="() => GoPage(p)">
								@p
							</button>
						}
					}

					<button class="page-btn-modern" disabled="@(!CanNext)" @onclick="NextPage">
						<i class="icon icon-chevron-right"></i>
					</button>
					<button class="page-btn-modern" disabled="@(!CanNext)" @onclick="LastPage">
						<i class="icon icon-chevron-double-right"></i>
					</button>
				</div>

				<div class="pagination-info">
					<span class="page-info-text">
						Showing <strong>@((page - 1) * pageSize + 1)</strong> to <strong>@Math.Min(page * pageSize, totalCount)</strong> of <strong>@totalCount</strong> employees
					</span>
					<div class="page-size-selector">
						<label>Show:</label>
						<select class="page-size-select" @onchange="PageSizeChanged">
							<option value="8" selected="@(pageSize==8)">8 per page</option>
							<option value="16" selected="@(pageSize==16)">16 per page</option>
							<option value="24" selected="@(pageSize==24)">24 per page</option>
							<option value="32" selected="@(pageSize==32)">32 per page</option>
						</select>
					</div>
				</div>
			</div>
		}
	</main>
</div>

@if (showModal)
{
	<div class="modal-overlay" @onclick="CloseModal">
		<div class="modal-card" @onclick:stopPropagation>
			<div class="modal-header">
				<h2 class="modal-title">@(isEdit ? "Edit Employee" : "New Employee")</h2>
				<button class="modal-close-btn" @onclick="CloseModal"><i class="icon icon-close"></i></button>
			</div>
			<div class="modal-body">
				@if (!string.IsNullOrEmpty(modalErrorMessage))
				{
					<div class="error-banner" style="margin-bottom: 1rem;">
						<span><i class="icon icon-error"></i></span>
						<span>@modalErrorMessage</span>
					</div>
				}
				<div class="form-grid">
					<div class="form-field @(firstNameError ? "has-error" : "")">
						<label>First Name *</label>
						<input type="text" @bind="formFirstName" />
						@if (firstNameError)
						{
							<span class="error-text">First name is required</span>
						}
					</div>
					<div class="form-field">
						<label>Middle Name</label>
						<input type="text" @bind="formMiddleName" />
					</div>
				</div>
				<div class="form-grid">
					<div class="form-field @(lastNameError ? "has-error" : "")">
						<label>Last Name *</label>
						<input type="text" @bind="formLastName" />
						@if (lastNameError)
						{
							<span class="error-text">Last name is required</span>
						}
					</div>
					<div class="form-field">
						<label>Birth Date</label>
						<input type="date" value="@formBirthDateString" @onchange="OnBirthDateChanged" />
					</div>
				</div>
				<div class="form-grid">
					<div class="form-field @(emailError ? "has-error" : "")">
						<label>Email *</label>
						<input type="email" @bind="formEmail" />
						@if (emailError)
						{
							<span class="error-text">Valid email is required</span>
						}
					</div>
					<div class="form-field">
						<label>Contact Number</label>
						<input type="text" @bind="formContact" />
					</div>
				</div>
				<div class="form-grid">
					<div class="form-field">
						<label>Role *</label>
						<select @bind="formRole">
							<option value="admin">Admin</option>
							<option value="staff">Staff</option>
						</select>
					</div>
					<div class="form-field @(passwordError ? "has-error" : "")">
						<label>Password *</label>
						<input type="password" @bind="formPassword" />
						@if (passwordError)
						{
							<span class="error-text">Password is required</span>
						}
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn-modal-cancel" @onclick="CloseModal">Cancel</button>
				<button class="btn-modal-save" @onclick="Save">@(isEdit ? "Update" : "Add")</button>
			</div>
		</div>
	</div>
}

@code {
	List<Hospitality.Models.User> employees = new();
	bool loading = true;
	bool loadError = false;
	bool showModal = false;
	bool isEdit = false;
	string searchQuery = string.Empty;
	string roleFilter = string.Empty;
	string errorMessage = string.Empty;
	string modalErrorMessage = string.Empty;
	int page =1;
	int pageSize =8;
	int totalCount =0;
	int totalPages => totalCount ==0 ?1 : (int)Math.Ceiling(totalCount / (double)pageSize);
	List<int> PageNumbers => Enumerable.Range(1, totalPages).ToList();
	List<Hospitality.Models.User> EmployeesPage => employees;
	bool CanPrev => page >1;
	bool CanNext => page < totalPages;

	string formFirstName = "";
	string formMiddleName = "";
	string formLastName = "";
	string formBirthDateString = "";
	string formEmail = "";
	string formContact = "";
	string formRole = "staff";
	string formPassword = "";
	
	bool firstNameError = false;
	bool lastNameError = false;
	bool emailError = false;
	bool passwordError = false;

	// New method for smart pagination
	List<int> GetVisiblePageNumbers()
	{
		var pages = new List<int>();
		int maxVisible = 7;
		
		if (totalPages <= maxVisible)
		{
			return Enumerable.Range(1, totalPages).ToList();
		}
		
		pages.Add(1);
		
		int start = Math.Max(2, page - 2);
		int end = Math.Min(totalPages - 1, page + 2);
		
		if (start > 2) pages.Add(-1); // ellipsis
		
		for (int i = start; i <= end; i++)
		{
			pages.Add(i);
		}
		
		if (end < totalPages - 1) pages.Add(-1); // ellipsis
		
		pages.Add(totalPages);
		
		return pages;
	}

	void SetRoleFilter(string filter)
	{
		roleFilter = filter;
		page = 1;
		_ = LoadPageAsync();
	}

	protected override async Task OnInitializedAsync() => await LoadPageAsync();

	async Task LoadPageAsync()
	{
		loading = true; 
		loadError = false;
		errorMessage = string.Empty;
		try
		{
			employees = await UserService.GetEmployeesAsync(page, pageSize, searchQuery, roleFilter);
			totalCount = await UserService.GetEmployeesCountAsync(searchQuery, roleFilter);
		}
		catch (Exception ex)
		{
			loadError = true;
			errorMessage = $"Failed to load employees: {ex.Message}";
			Console.WriteLine($"❌ Error loading employees: {ex.Message}");
		}
		finally { loading = false; }
	}

	void ToggleRoleFilter()
	{
		if (string.IsNullOrEmpty(roleFilter)) roleFilter = "staff"; 
		else if (roleFilter == "staff") roleFilter = "admin"; 
		else if (roleFilter == "admin") roleFilter = "client"; 
		else roleFilter = string.Empty;
		page =1;
		_ = LoadPageAsync();
	}

	void ShowAddModal() 
	{ 
		isEdit = false; 
		ResetForm(); 
		showModal = true; 
	}
	
	void Edit(Hospitality.Models.User u) 
	{ 
		isEdit = true; 
		formFirstName = u.user_fname ?? ""; 
		formEmail = u.user_email ?? ""; 
		formRole = u.roleName ?? "staff"; 
		showModal = true; 
	}
	
	void ResetForm() 
	{ 
		formFirstName = formMiddleName = formLastName = formBirthDateString = formEmail = formContact = formPassword = string.Empty; 
		formRole = "staff";
		firstNameError = lastNameError = emailError = passwordError = false;
		modalErrorMessage = string.Empty;
	}
	
	bool ValidateForm()
	{
		bool isValid = true;
		modalErrorMessage = string.Empty;
		firstNameError = lastNameError = emailError = passwordError = false;
		
		if (string.IsNullOrWhiteSpace(formFirstName))
		{
			firstNameError = true;
			isValid = false;
		}
		
		if (string.IsNullOrWhiteSpace(formLastName))
		{
			lastNameError = true;
			isValid = false;
		}
		
		if (string.IsNullOrWhiteSpace(formEmail) || !formEmail.Contains("@"))
		{
			emailError = true;
			isValid = false;
		}
		
		if (!isEdit && string.IsNullOrWhiteSpace(formPassword))
		{
			passwordError = true;
			isValid = false;
		}
		
		if (!isValid)
		{
			modalErrorMessage = "Please fill in all required fields correctly.";
		}
		
		return isValid;
	}

	async Task Save()
	{
		if (!ValidateForm()) return;
		
		try
		{
			if (!isEdit)
			{
				var roleId = await UserService.GetRoleIdByNameAsync(formRole) ?? 0;
				DateTime? birth = DateTime.TryParse(formBirthDateString, out var b) ? b : null;
				var newUser = new Hospitality.Models.User
				{
					role_id = roleId,
					user_fname = formFirstName,
					user_mname = string.IsNullOrWhiteSpace(formMiddleName) ? null : formMiddleName,
					user_lname = string.IsNullOrWhiteSpace(formLastName) ? null : formLastName,
					user_brith_date = birth,
					user_email = formEmail,
					user_contact_number = formContact,
					user_password = formPassword,
					roleName = formRole
				};
				var id = await UserService.RegisterAsync(newUser);
				newUser.userId = id; 
				employees.Add(newUser); 
				totalCount++;
			}
			CloseModal();
		}
		catch (Exception ex)
		{
			modalErrorMessage = $"Failed to save: {ex.Message}";
			Console.WriteLine($"❌ Error saving employee: {ex.Message}");
		}
	}

	void CloseModal() { showModal = false; ResetForm(); }
	
	string GetInitials(Hospitality.Models.User u) 
	{ 
		var parts = new List<string>();
		if (!string.IsNullOrWhiteSpace(u.user_fname))
			parts.Add(u.user_fname.Substring(0, 1));
		if (!string.IsNullOrWhiteSpace(u.user_lname))
			parts.Add(u.user_lname.Substring(0, 1));

		return string.Join("", parts).ToUpper();
	}
	
	string GetFullName(Hospitality.Models.User u) 
	{ 
		var mn = string.IsNullOrWhiteSpace(u.user_mname) ? "" : u.user_mname;
		var ln = string.IsNullOrWhiteSpace(u.user_lname) ? "" : u.user_lname;

		return string.Join(" ", new[] { u.user_fname, mn, ln }.Where(s => !string.IsNullOrWhiteSpace(s)));
	}

	async Task PrevPage() { if (CanPrev) { page--; await LoadPageAsync(); } }
	async Task NextPage() { if (CanNext) { page++; await LoadPageAsync(); } }
	async Task FirstPage() { if (CanPrev) { page =1; await LoadPageAsync(); } }
	async Task LastPage() { if (CanNext) { page = totalPages; await LoadPageAsync(); } }
	async Task GoPage(int p) { if (p != page) { page = p; await LoadPageAsync(); } }
	async Task PageSizeChanged(ChangeEventArgs e) { if (int.TryParse(e.Value?.ToString(), out var ps) && ps >0) { pageSize = ps; page =1; await LoadPageAsync(); } }

	void OnBirthDateChanged(ChangeEventArgs e) { formBirthDateString = e.Value?.ToString() ?? string.Empty; }

	void Logout() => Navigation.NavigateTo("/");
}
