@page "/client/receipts/{id:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.UserService UserService
@inject Hospitality.Services.BookingService BookingService
@inject Hospitality.Services.PaymentService PaymentService
@inject Hospitality.Services.LoyaltyService LoyaltyService

<link rel="stylesheet" href="css/clientprofile.css" />
<link rel="stylesheet" href="css/client-layout.css" />
<link rel="stylesheet" href="css/client-receipts.css" />

<div class="client-profile-page">
	<!-- Shared Navigation Component -->
	<ClientNavigation UserId="@id" ActivePage="receipts" User="@user" LoyaltyProgram="@loyaltyProgram" />

	<div class="profile-container">
		@if (loading)
		{
			<div class="loading-container">
				<p>Loading receipts...</p>
			</div>
		}
		else if (user == null)
		{
			<div class="error-container">
				<h3>User not found</h3>
				<p>Could not find user with ID: @id</p>
			</div>
		}
		else
		{
			<!-- Page Header -->
			<header class="page-header">
				<div class="header-content">
					<button class="back-btn" @onclick="GoBack">
						<span>?</span> Back to Dashboard
					</button>
					<h1 class="page-title">Your Receipts</h1>
					<p class="page-subtitle">View and download receipts for all your bookings and payments.</p>
				</div>
			</header>

			<!-- Receipts Summary -->
			<div class="receipts-summary">
				<div class="summary-card">
					<span class="summary-icon">ðŸ§¾</span>
					<div class="summary-content">
						<span class="summary-value">@totalReceipts</span>
						<span class="summary-label">Total Receipts</span>
					</div>
				</div>
				<div class="summary-card">
					<span class="summary-icon">ðŸ’°</span>
					<div class="summary-content">
						<span class="summary-value">PHP @totalPaid.ToString("N2")</span>
						<span class="summary-label">Total Paid</span>
					</div>
				</div>
				<div class="summary-card">
					<span class="summary-icon">ðŸ“…</span>
					<div class="summary-content">
						<span class="summary-value">@totalBookings</span>
						<span class="summary-label">Bookings</span>
					</div>
				</div>
			</div>

			<!-- Receipts Table Card -->
			<div class="card receipts-table-card">
				<div class="card-header-split">
					<div>
						<h3>Payment History</h3>
						<p class="card-subtitle">All your payment receipts and transactions.</p>
					</div>
					<div class="filter-controls">
						<select @bind="selectedFilter" class="filter-select">
							<option value="all">All Receipts</option>
							<option value="completed">Full Payments</option>
							<option value="partial">Partial Payments</option>
						</select>
					</div>
				</div>

				@if (!filteredReceipts.Any())
				{
					<div class="empty-state">
						<span class="empty-icon">ðŸ§¾</span>
						<h3>No Receipts Found</h3>
						<p>You don't have any receipts yet. Once you make a booking, your payment receipts will appear here.</p>
						<button class="btn btn-primary" @onclick="BookRoom">
							<i class="icon icon-calendar"></i> Book a Room
						</button>
					</div>
				}
				else
				{
					<table class="receipts-table">
						<thead>
							<tr>
								<th>RECEIPT ID</th>
								<th>ROOM TYPE</th>
								<th>DURATION & GUESTS</th>
								<th>STATUS</th>
								<th>AMOUNT</th>
								<th>ACTION</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var receipt in filteredReceipts)
							{
								var nights = (receipt.CheckOutDate - receipt.CheckInDate).Days;
								<tr>
									<td class="receipt-id">#@receipt.PaymentId.ToString("D7")</td>
									<td class="room-type">@receipt.RoomName</td>
									<td class="duration-guests">
										<span class="duration">@nights night@(nights != 1 ? "s" : "") ï¿½ @receipt.GuestCount guest@(receipt.GuestCount != 1 ? "s" : "")</span>
										<span class="dates">@receipt.CheckInDate.ToString("MMM dd")ï¿½@receipt.CheckOutDate.ToString("MMM dd")</span>
									</td>
									<td>
										<span class="status-badge status-@GetPaymentStatusClass(receipt.PaymentStatus)">
											@FormatPaymentStatus(receipt.PaymentStatus)
										</span>
									</td>
									<td class="amount">?@receipt.Amount.ToString("N2")</td>
									<td class="action-cell">
										<button class="btn btn-action" @onclick="() => ViewReceiptDetails(receipt)">
											View
										</button>
									</td>
								</tr>
							}
						</tbody>
					</table>
				}
			</div>
		}
	</div>
</div>

<!-- Receipt Detail Modal -->
@if (showReceiptModal && selectedReceipt != null)
{
	<div class="modal-overlay" @onclick="CloseModal">
		<div class="modal-content" @onclick:stopPropagation="true">
			<div class="modal-header">
				<h2>Receipt Details</h2>
				<button class="close-btn" @onclick="CloseModal">ï¿½</button>
			</div>
			<div class="modal-body">
				<div class="receipt-detail-section">
					<h4>Payment Information</h4>
					<div class="detail-grid">
						<div class="detail-item">
							<span class="label">Receipt Number</span>
							<span class="value">#@selectedReceipt.PaymentId.ToString("D7")</span>
						</div>
						<div class="detail-item">
							<span class="label">Payment Date</span>
							<span class="value">@selectedReceipt.PaymentDate.ToString("MMMM dd, yyyy")</span>
						</div>
						<div class="detail-item">
							<span class="label">Payment Time</span>
							<span class="value">@selectedReceipt.PaymentDate.ToString("h:mm tt")</span>
						</div>
						<div class="detail-item">
							<span class="label">Payment Method</span>
							<span class="value">@FormatPaymentMethod(selectedReceipt.PaymentMethod)</span>
						</div>
					</div>
				</div>

				<div class="receipt-detail-section">
					<h4>Booking Information</h4>
					<div class="detail-grid">
						<div class="detail-item">
							<span class="label">Booking Reference</span>
							<span class="value">#@selectedReceipt.BookingId.ToString("D7")</span>
						</div>
						<div class="detail-item">
							<span class="label">Room</span>
							<span class="value">@selectedReceipt.RoomName</span>
						</div>
						<div class="detail-item">
							<span class="label">Check-in</span>
							<span class="value">@selectedReceipt.CheckInDate.ToString("MMM dd, yyyy")</span>
						</div>
						<div class="detail-item">
							<span class="label">Check-out</span>
							<span class="value">@selectedReceipt.CheckOutDate.ToString("MMM dd, yyyy")</span>
						</div>
					</div>
				</div>

				<div class="receipt-detail-section amount-section">
					<div class="total-row">
						<span>Amount Paid</span>
						<span class="total-amount">?@selectedReceipt.Amount.ToString("N2")</span>
					</div>
				</div>

				@if (!string.IsNullOrEmpty(selectedReceipt.Notes))
				{
					<div class="receipt-detail-section">
						<h4>Notes</h4>
						<p class="notes-text">@selectedReceipt.Notes</p>
					</div>
				}
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" @onclick="CloseModal">Close</button>
				<button class="btn btn-primary" @onclick="() => DownloadReceipt(selectedReceipt)">
					<i class="icon icon-download"></i> Download Receipt
				</button>
			</div>
		</div>
	</div>
}

@code {
	[Parameter] public int id { get; set; }

	Hospitality.Models.User? user;
	Hospitality.Models.LoyaltyProgram? loyaltyProgram;
	List<ReceiptViewModel> allReceipts = new();
	ReceiptViewModel? selectedReceipt;

	bool loading = true;
	bool showReceiptModal = false;
	string selectedFilter = "all";
	int actualClientId = 0;

	int totalReceipts => allReceipts.Count;
	decimal totalPaid => allReceipts.Sum(r => r.Amount);
	int totalBookings => allReceipts.Select(r => r.BookingId).Distinct().Count();

	List<ReceiptViewModel> filteredReceipts => GetFilteredReceipts();

	protected override async Task OnParametersSetAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		loading = true;
		StateHasChanged();

		try
		{
			user = await UserService.GetUserByIdAsync(id);

			if (user != null)
			{
				actualClientId = await GetClientIdAsync(id);

				if (actualClientId > 0)
				{
					// Load loyalty program data
					try
					{
						loyaltyProgram = await LoyaltyService.GetLoyaltyProgramAsync(actualClientId);
					}
					catch { }

					// Load all bookings and their payments
					await LoadReceiptsAsync();
				}
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"? Error loading receipts: {ex.Message}");
		}
		finally
		{
			loading = false;
			StateHasChanged();
		}
	}

	private async Task LoadReceiptsAsync()
	{
		allReceipts.Clear();

		var bookings = await BookingService.GetBookingsByUserIdAsync(id);

		foreach (var booking in bookings)
		{
			var payments = await PaymentService.GetPaymentsForBookingAsync(booking.booking_id);

			foreach (var payment in payments)
			{
				allReceipts.Add(new ReceiptViewModel
				{
					PaymentId = payment.payment_id,
					BookingId = booking.booking_id,
					RoomName = booking.room_name ?? "Room",
					CheckInDate = booking.check_in_date,
					CheckOutDate = booking.check_out_date,
					GuestCount = booking.person_count,
					Amount = payment.amount,
					PaymentMethod = payment.payment_method,
					PaymentStatus = payment.payment_status,
					PaymentType = payment.payment_type,
					PaymentDate = payment.payment_date,
					Notes = payment.notes
				});
			}
		}

		// Sort by payment date descending (newest first)
		allReceipts = allReceipts.OrderByDescending(r => r.PaymentDate).ToList();
	}

	private List<ReceiptViewModel> GetFilteredReceipts()
	{
		return selectedFilter switch
		{
			"completed" => allReceipts.Where(r => r.PaymentType == "full" || r.PaymentType == "remaining").ToList(),
			"partial" => allReceipts.Where(r => r.PaymentType == "downpayment" || r.PaymentType == "partial").ToList(),
			_ => allReceipts
		};
	}

	async Task<int> GetClientIdAsync(int userId)
	{
		try
		{
			using var con = Hospitality.Database.DbConnection.GetConnection();
			await con.OpenAsync();

			string sql = "SELECT client_id FROM Clients WHERE user_id = @userId";
			using var cmd = new Microsoft.Data.SqlClient.SqlCommand(sql, con);
			cmd.Parameters.AddWithValue("@userId", userId);

			var result = await cmd.ExecuteScalarAsync();
			return result != null && result != DBNull.Value ? Convert.ToInt32(result) : 0;
		}
		catch
		{
			return 0;
		}
	}

	string FormatPaymentMethod(string method) => method?.ToLower() switch
	{
		"card" => "Credit/Debit Card",
		"gcash" => "GCash",
		"paymaya" => "PayMaya",
		"grab_pay" => "GrabPay",
		"cash" => "Cash",
		_ => method ?? "Unknown"
	};

	string FormatPaymentStatus(string status) => status?.ToLower() switch
	{
		"completed" => "Completed",
		"pending" => "Pending",
		"failed" => "Failed",
		_ => status ?? "Unknown"
	};

	string GetPaymentStatusClass(string status) => status?.ToLower() switch
	{
		"completed" => "confirmed",
		"pending" => "pending",
		"failed" => "cancelled",
		_ => "pending"
	};

	void ViewReceiptDetails(ReceiptViewModel receipt)
	{
		selectedReceipt = receipt;
		showReceiptModal = true;
	}

	void CloseModal()
	{
		showReceiptModal = false;
		selectedReceipt = null;
	}

	void DownloadReceipt(ReceiptViewModel receipt)
	{
		// In a real app, this would generate and download a PDF
		Console.WriteLine($"?? Downloading receipt #{receipt.PaymentId}");
	}

	void GoBack() => Navigation.NavigateTo($"/client/profile/{id}");
	void BookRoom() => Navigation.NavigateTo($"/booking/new/{id}");

	int LoyaltyPoints => loyaltyProgram?.total_points ?? 0;
	string CurrentTier => loyaltyProgram?.current_tier ?? "Bronze";

	public class ReceiptViewModel
	{
		public int PaymentId { get; set; }
		public int BookingId { get; set; }
		public string RoomName { get; set; } = "";
		public DateTime CheckInDate { get; set; }
		public DateTime CheckOutDate { get; set; }
		public int GuestCount { get; set; }
		public decimal Amount { get; set; }
		public string PaymentMethod { get; set; } = "";
		public string PaymentStatus { get; set; } = "";
		public string PaymentType { get; set; } = "";
		public DateTime PaymentDate { get; set; }
		public string? Notes { get; set; }
	}
}
