@page "/booking/payment/{clientId:int}"
@page "/booking/payment/{clientId:int}/{bookingId:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.BookingService BookingService
@inject Hospitality.Services.UserService UserService
@inject Hospitality.Services.PayMongoService PayMongoService
@inject Hospitality.Services.PaymentService PaymentService
@inject Hospitality.Services.LoyaltyService LoyaltyService
@inject Hospitality.Services.RoomService RoomService
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="css/payment.css" />

<div class="payment-page">
	<!-- Top Navigation Bar -->
	<nav class="top-nav">
		<div class="nav-left">
			<div class="brand">
				<img src="images/InnSight.png" alt="InnSight" style="height: 32px; width: auto; margin-right: 8px;" />
				<span class="brand-name">InnSight</span>
				<span class="brand-sub">Guest Portal</span>
			</div>
		</div>
		<div class="nav-center">
			<a href="/client/profile/@clientId" class="nav-link">Dashboard</a>
			<a href="#" class="nav-link">Stays</a>
			<a href="/client/loyalty/@clientId" class="nav-link">Loyalty</a>
			<a href="/client/messages/@clientId" class="nav-link">Messages</a>
		</div>
		<div class="nav-right">
			<span class="points-badge">@loyaltyTier • @LoyaltyPoints pts</span>
			<div class="user-menu">
				<div class="user-avatar-small" @onclick="ToggleDropdown">@GetInitials()</div>
				@if (isDropdownOpen)
				{
					<div class="user-dropdown">
						<button class="dropdown-item" title="Logout" @onclick="Logout">Logout</button>
					</div>
				}
			</div>
		</div>
	</nav>

	<div class="payment-container">
		<div class="payment-content">
			<!-- Left Panel - Payment Form -->
			<div class="payment-left">
				<div class="page-header">
					<h1 class="page-title">Complete your booking</h1>
					<p class="page-subtitle">Secure payment powered by PayMongo</p>
				</div>

				@if (loading)
				{
					<div class="loading-container">
						<div class="spinner"></div>
						<p>Loading payment details...</p>
					</div>
				}
				else if (showPaymentPendingMessage)
				{
					<!-- Payment Pending - User needs to complete payment in browser -->
					<div class="payment-pending-card" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 16px; padding: 32px; text-align: center; margin-bottom: 24px;">
						<div style="font-size: 64px; margin-bottom: 16px;">🏦</div>
						<h2 style="color: #2e7d32; font-size: 24px; margin-bottom: 12px;">Payment Page Opened</h2>
						<p style="color: #388e3c; font-size: 16px; margin-bottom: 24px;">
							Complete your payment in the browser window that opened.<br/>
							Once done, click the button below to confirm.
						</p>
						
						<div style="display: flex; flex-direction: column; gap: 12px; max-width: 300px; margin: 0 auto;">
							<button class="btn-primary" @onclick="ConfirmPaymentComplete" style="padding: 16px 32px; font-size: 16px;">
								✅ I've Completed Payment
							</button>
							<button class="btn-secondary" @onclick="RetryPayment" style="padding: 12px 24px;">
								🔄 Open Payment Page Again
							</button>
							<button class="btn-secondary" @onclick="CancelPayment" style="padding: 12px 24px;">
								❌ Cancel
							</button>
						</div>
					</div>
				}
				else
				{
					<!-- Success Message -->
					@if (!string.IsNullOrEmpty(successMessage))
					{
						<div class="success-banner" style="background: #e6ffe6; border: 1px solid #4caf50; padding: 15px; margin-bottom: 20px; border-radius: 8px; color: #2e7d32;">
							<div style="display: flex; align-items: center; gap: 10px;">
								<span style="font-size: 18px;">✅</span>
								<div>
									<strong>Payment Successful</strong>
									<div style="margin-top: 5px;">@successMessage</div>
								</div>
							</div>
						</div>
					}

					<!-- Error Message -->
					@if (!string.IsNullOrEmpty(errorMessage))
					{
						<div class="error-banner" style="background: #ffe6e6; border: 1px solid #ff6b6b; padding: 15px; margin-bottom: 20px; border-radius: 8px; color: #d63031;">
							<div style="display: flex; align-items: center; gap: 10px;">
								<span style="font-size: 18px;">⚠️</span>
								<div>
									<strong>Payment Error</strong>
									<div style="margin-top: 5px;">@errorMessage</div>
								</div>
							</div>
						</div>
					}

					<!-- Guest Information -->
					<div class="form-section">
						<div class="section-header">
							<h3 class="section-title">Guest Information</h3>
							<span class="section-subtitle">Confirm your details</span>
						</div>
						<div class="guest-info">
							<div class="input-row">
								<div class="input-field">
									<label class="field-label">First Name <span class="required">*</span></label>
									<input type="text" @bind="firstName" class="text-input" placeholder="Enter first name" required />
								</div>
								<div class="input-field">
									<label class="field-label">Last Name <span class="required">*</span></label>
									<input type="text" @bind="lastName" class="text-input" placeholder="Enter last name" required />
								</div>
							</div>
							<div class="input-row">
								<div class="input-field">
									<label class="field-label">Email Address <span class="required">*</span></label>
									<input type="email" @bind="email" class="text-input" placeholder="your.email@example.com" required />
								</div>
								<div class="input-field">
									<label class="field-label">Phone Number <span class="required">*</span></label>
									<input type="tel" @bind="phoneNumber" class="text-input" placeholder="+63 999 123 4567" required />
								</div>
							</div>
						</div>
					</div>

					<!-- Payment Type Selection -->
					<div class="form-section">
						<div class="section-header">
							<h3 class="section-title">Payment Option</h3>
							<span class="section-subtitle">Choose how much to pay now</span>
						</div>
						<div class="payment-methods">
							<button type="button" class="payment-method @(selectedPaymentType == "full" ? "selected" : "")" @onclick="SelectFullPayment">
								<div class="method-icon">💳</div>
								<div class="method-details">
									<div class="method-name">Pay in Full</div>
									<div class="method-desc">₱@totalAmount.ToString("N2") - Complete payment now</div>
								</div>
								<div class="method-radio">
									<input type="radio" name="paymentType" value="full" checked="@(selectedPaymentType == "full")" />
								</div>
							</button>
							<button type="button" class="payment-method @(selectedPaymentType == "downpayment" ? "selected" : "")" @onclick="SelectDownpayment">
								<div class="method-icon">📝</div>
								<div class="method-details">
									<div class="method-name">Downpayment (50%)</div>
									<div class="method-desc">₱@minimumDownpayment.ToString("N2") now, balance at check-in</div>
								</div>
								<div class="method-radio">
									<input type="radio" name="paymentType" value="downpayment" checked="@(selectedPaymentType == "downpayment")" />
								</div>
							</button>
						</div>
					</div>

					<!-- Payment Method Selection -->
					<div class="form-section">
						<div class="section-header">
							<h3 class="section-title">Payment Method</h3>
							<span class="section-subtitle">Choose how you'd like to pay</span>
						</div>
						<div class="payment-methods">
							<button type="button" class="payment-method @(selectedPaymentMethod == "card" ? "selected" : "")" @onclick="SelectCardPayment">
								<div class="method-icon">💳</div>
								<div class="method-details">
									<div class="method-name">Credit/Debit Card</div>
									<div class="method-desc">Visa, Mastercard, JCB</div>
								</div>
								<div class="method-radio">
									<input type="radio" name="paymentMethod" value="card" checked="@(selectedPaymentMethod == "card")" />
								</div>
							</button>
							<button type="button" class="payment-method @(selectedPaymentMethod == "gcash" ? "selected" : "")" @onclick="SelectGCashPayment">
								<div class="method-icon">📱</div>
								<div class="method-details">
									<div class="method-name">GCash</div>
									<div class="method-desc">Pay with your GCash wallet</div>
								</div>
								<div class="method-radio">
									<input type="radio" name="paymentMethod" value="gcash" checked="@(selectedPaymentMethod == "gcash")" />
								</div>
							</button>
							<button type="button" class="payment-method @(selectedPaymentMethod == "paymaya" ? "selected" : "")" @onclick="SelectPayMayaPayment">
								<div class="method-icon">💳</div>
								<div class="method-details">
									<div class="method-name">PayMaya</div>
									<div class="method-desc">Pay with your PayMaya wallet</div>
								</div>
								<div class="method-radio">
									<input type="radio" name="paymentMethod" value="paymaya" checked="@(selectedPaymentMethod == "paymaya")" />
								</div>
							</button>
						</div>
					</div>

					<!-- Terms and Conditions -->
					<div class="form-section">
						<div class="terms-section">
							<label class="checkbox-container">
								<input type="checkbox" @bind="agreeToTerms" />
								<span class="checkmark"></span>
								<span class="checkbox-text">
									I agree to the <a href="#" class="terms-link">Terms and Conditions</a> 
									and <a href="#" class="terms-link">Privacy Policy</a>
								</span>
							</label>
							<label class="checkbox-container">
								<input type="checkbox" @bind="subscribeToOffers" />
								<span class="checkmark"></span>
								<span class="checkbox-text">
									I would like to receive special offers and updates via email
								</span>
							</label>
						</div>
					</div>

					<!-- Payment Buttons -->
					<div class="payment-actions">
						<button class="btn-secondary" @onclick="GoBack">
							← Back to Rooms
						</button>
						<button class="btn-primary @(CanProcessPayment() ? "" : "disabled")" 
								@onclick="ProcessPayment" 
								disabled="@(!CanProcessPayment() || processingPayment)"
								style="min-width: 200px;">
							@if (processingPayment)
							{
								<span class="spinner-small"></span>
								<span>Processing...</span>
							}
							else
							{
								<span>Pay ₱@paymentAmount.ToString("N2")</span>
							}
						</button>
					</div>
				}
			</div>

			<!-- Right Panel - Booking Summary -->
			<div class="payment-right">
				<div class="summary-card">
					<div class="summary-header">
						<div class="summary-icon">📋</div>
						<h3>Booking Summary</h3>
					</div>

					<!-- Hotel Details -->
					<div class="summary-section">
						<div class="hotel-info">
							<div class="hotel-details">
								<h4 class="hotel-name">InnSight Hotel</h4>
								<div class="hotel-location">📍 Waterfront, San Francisco</div>
								<div class="hotel-rating">⭐⭐⭐⭐⭐ 4.8 (2,847 reviews)</div>
							</div>
						</div>
					</div>

					<!-- Stay Details -->
					<div class="summary-section">
						<h4 class="section-title">Stay Details</h4>
						<div class="stay-info">
							<div class="info-row">
								<span class="info-label">Room(s)</span>
								<span class="info-value">@string.Join(", ", selectedRoomNames)</span>
							</div>
							<div class="info-row">
								<span class="info-label">Check-in</span>
								<span class="info-value">@checkInDate.ToString("ddd, MMM dd") • 3:00 PM</span>
							</div>
							<div class="info-row">
								<span class="info-label">Check-out</span>
								<span class="info-value">@checkOutDate.ToString("ddd, MMM dd") • 11:00 AM</span>
							</div>
							<div class="info-row">
								<span class="info-label">Guests</span>
								<span class="info-value">@adults adult@(adults != 1 ? "s" : "")</span>
							</div>
							<div class="info-row">
								<span class="info-label">Nights</span>
								<span class="info-value">@GetNights() night@(GetNights() != 1 ? "s" : "")</span>
							</div>
						</div>
					</div>

					<!-- Price Breakdown -->
					<div class="summary-section">
						<h4 class="section-title">Price Breakdown</h4>
						<div class="price-breakdown">
							<div class="price-row">
								<span class="price-label">Room(s) x @GetNights() nights</span>
								<span class="price-value">₱@subtotal.ToString("N2")</span>
							</div>
							@if (discountPercentage > 0)
							{
								<div class="price-row discount" style="color: #27ae60;">
									<span class="price-label">@loyaltyTier Member Discount (@discountPercentage%)</span>
									<span class="price-value">-₱@discountAmount.ToString("N2")</span>
								</div>
							}
							<div class="price-row">
								<span class="price-label">Taxes & Fees (12%)</span>
								<span class="price-value">₱@taxesAndFees.ToString("N2")</span>
							</div>
							<div class="price-row total">
								<span class="price-label">Total</span>
								<span class="price-value">₱@totalAmount.ToString("N2")</span>
							</div>
						</div>
					</div>

					<!-- Payment Summary -->
					<div class="summary-section" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-top: 10px;">
						<h4 class="section-title">Payment Summary</h4>
						<div class="price-breakdown">
							<div class="price-row">
								<span class="price-label">Amount to Pay Now</span>
								<span class="price-value" style="font-weight: bold; color: #2980b9;">₱@paymentAmount.ToString("N2")</span>
							</div>
							@if (selectedPaymentType == "downpayment")
							{
								<div class="price-row">
									<span class="price-label">Remaining Balance (due at check-in)</span>
									<span class="price-value">₱@(totalAmount - paymentAmount).ToString("N2")</span>
								</div>
							}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public int clientId { get; set; }
	[Parameter] public int? bookingId { get; set; }

	// User data
	Hospitality.Models.User? user;

	// Loading states
	bool loading = true;
	bool processingPayment = false;
	bool showPaymentPendingMessage = false;
	bool isDropdownOpen = false;
	string errorMessage = "";
	string successMessage = "";
	string lastCheckoutUrl = "";

	// Guest information
	string firstName = "";
	string lastName = "";
	string email = "";
	string phoneNumber = "";

	// Payment details
	string selectedPaymentMethod = "gcash";
	string selectedPaymentType = "full";

	// Terms and conditions
	bool agreeToTerms = false;
	bool subscribeToOffers = false;

	// PayMongo payment tracking
	string paymentIntentId = "";

	// Pricing (from query params or existing booking)
	DateTime checkInDate = DateTime.Today.AddDays(1);
	DateTime checkOutDate = DateTime.Today.AddDays(4);
	int adults = 2;
	List<int> roomIds = new();
	List<string> selectedRoomNames = new();
	string loyaltyTier = "Bronze";
	decimal discountPercentage = 0;
	decimal subtotal = 0;
	decimal discountAmount = 0;
	decimal taxesAndFees = 0;
	decimal totalAmount = 0;
	decimal minimumDownpayment = 0;
	decimal paymentAmount = 0;
	int LoyaltyPoints = 0;

	// Pending booking data (not saved until payment succeeds)
	Hospitality.Models.PendingBooking? pendingBooking;

	protected override async Task OnInitializedAsync()
	{
		loading = true;
		errorMessage = "";
		
		try
		{
			Console.WriteLine($"Payment page initialized with clientId: {clientId}, bookingId: {bookingId}");
			
			// Load user data
			user = await UserService.GetUserByIdAsync(clientId);
			
			if (user != null)
			{
				firstName = user.user_fname ?? "";
				lastName = user.user_lname ?? "";
				email = user.user_email ?? "";
				phoneNumber = user.user_contact_number ?? "";
				Console.WriteLine($"Loaded user: {firstName} {lastName}");
			}

			// Parse query parameters for new booking
			var uri = new Uri(Navigation.Uri);
			var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
			
			if (!string.IsNullOrEmpty(query["checkIn"]))
			{
				// This is a new booking from room selection
				if (DateTime.TryParse(query["checkIn"], out var parsedCheckIn))
					checkInDate = parsedCheckIn;
				if (DateTime.TryParse(query["checkOut"], out var parsedCheckOut))
					checkOutDate = parsedCheckOut;
				if (int.TryParse(query["adults"], out var parsedAdults))
					adults = parsedAdults;
				
				// Parse room IDs
				var roomIdStr = query["rooms"];
				if (!string.IsNullOrEmpty(roomIdStr))
				{
					roomIds = roomIdStr.Split(',').Select(int.Parse).ToList();
				}
				
				// Parse pricing
				loyaltyTier = query["tier"] ?? "Bronze";
				if (decimal.TryParse(query["discount"], out var parsedDiscount))
					discountPercentage = parsedDiscount;
				if (decimal.TryParse(query["subtotal"], out var parsedSubtotal))
					subtotal = parsedSubtotal;
				if (decimal.TryParse(query["taxes"], out var parsedTaxes))
					taxesAndFees = parsedTaxes;
				if (decimal.TryParse(query["total"], out var parsedTotal))
					totalAmount = parsedTotal;
				
				discountAmount = subtotal * (discountPercentage / 100m);
				
				// Load room names
				await LoadRoomNames();
				
				// Build pending booking object
				pendingBooking = new Hospitality.Models.PendingBooking
				{
					client_id = await GetActualClientId(),
					check_in_date = checkInDate,
					check_out_date = checkOutDate,
					person_count = adults,
					check_in_time = new TimeOnly(15, 0),
					check_out_time = new TimeOnly(11, 0),
					room_ids = roomIds,
					loyalty_tier = loyaltyTier,
					discount_percentage = discountPercentage,
					subtotal = subtotal,
					discount_amount = discountAmount,
					taxes_and_fees = taxesAndFees,
					total_amount = totalAmount
				};
			}
			else if (bookingId.HasValue)
			{
				// This is an existing booking (partial payment)
				var booking = await BookingService.GetBookingByIdAsync(bookingId.Value);
				if (booking != null)
				{
					checkInDate = booking.check_in_date;
					checkOutDate = booking.check_out_date;
					adults = booking.person_count;
					selectedRoomNames.Add(booking.room_name ?? "Selected Room");
					totalAmount = await BookingService.GetBookingTotalAsync(bookingId.Value);
					
					// Get payment summary for existing booking
					var paymentSummary = await PaymentService.GetPaymentSummaryAsync(bookingId.Value, totalAmount);
					if (paymentSummary.total_paid > 0)
					{
						totalAmount = paymentSummary.remaining_balance;
						selectedPaymentType = "balance"; // Paying remaining balance
					}
				}
			}

			// Calculate minimum downpayment (50%)
			minimumDownpayment = totalAmount * 0.5m;
			paymentAmount = totalAmount; // Default to full payment
			
			// Load loyalty points
			await LoadLoyaltyInfo();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading payment data: {ex.Message}");
			errorMessage = $"Error loading payment details: {ex.Message}";
		}
		finally
		{
			loading = false;
		}
	}

	async Task LoadRoomNames()
	{
		try
		{
			var allRooms = await RoomService.GetRoomsAsync();
			selectedRoomNames = allRooms
				.Where(r => roomIds.Contains(r.room_id))
				.Select(r => r.room_name)
				.ToList();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading room names: {ex.Message}");
			selectedRoomNames = roomIds.Select(id => $"Room {id}").ToList();
		}
	}

	async Task LoadLoyaltyInfo()
	{
		try
		{
			var actualClientId = await GetActualClientId();
			var loyalty = await LoyaltyService.GetLoyaltyProgramAsync(actualClientId);
			if (loyalty != null)
			{
				LoyaltyPoints = loyalty.total_points;
			}
		}
		catch { }
	}

	async Task<int> GetActualClientId()
	{
		using var con = Hospitality.Database.DbConnection.GetConnection();
		await con.OpenAsync();

		string sql = "SELECT client_id FROM clients WHERE user_id = @userId";
		using var cmd = new Microsoft.Data.SqlClient.SqlCommand(sql, con);
		cmd.Parameters.AddWithValue("@userId", clientId);
		var result = await cmd.ExecuteScalarAsync();
		
		if (result == null)
		{
			// Create client record
			string insertSql = "INSERT INTO Clients (user_id) VALUES (@userId); SELECT CAST(SCOPE_IDENTITY() AS INT);";
			using var insertCmd = new Microsoft.Data.SqlClient.SqlCommand(insertSql, con);
			insertCmd.Parameters.AddWithValue("@userId", clientId);
			var newId = await insertCmd.ExecuteScalarAsync();
			return Convert.ToInt32(newId);
		}
		return Convert.ToInt32(result);
	}

	string GetInitials()
	{
		if (user == null) return "G";
		var parts = new List<string>();
		if (!string.IsNullOrWhiteSpace(user.user_fname)) parts.Add(user.user_fname.Substring(0, 1));
		if (!string.IsNullOrWhiteSpace(user.user_lname)) parts.Add(user.user_lname.Substring(0, 1));
		return string.Join("", parts).ToUpperInvariant();
	}

	void ToggleDropdown() => isDropdownOpen = !isDropdownOpen;
	void Logout() => Navigation.NavigateTo("/");

	string GetDashboardLink() => $"/client/profile/{clientId}";

	int GetNights() => (checkOutDate - checkInDate).Days;

	void SelectPaymentType(string type)
	{
		selectedPaymentType = type;
		paymentAmount = type == "full" ? totalAmount : minimumDownpayment;
		StateHasChanged();
	}

	void SelectFullPayment()
	{
		selectedPaymentType = "full";
		paymentAmount = totalAmount;
		StateHasChanged();
	}

	void SelectDownpayment()
	{
		selectedPaymentType = "downpayment";
		paymentAmount = minimumDownpayment;
		StateHasChanged();
	}

	void SelectCardPayment() => selectedPaymentMethod = "card";
	void SelectGCashPayment() => selectedPaymentMethod = "gcash";
	void SelectPayMayaPayment() => selectedPaymentMethod = "paymaya";

	bool IsBasicInfoValid()
	{
		return !string.IsNullOrWhiteSpace(firstName) && 
			   !string.IsNullOrWhiteSpace(lastName) && 
			   !string.IsNullOrWhiteSpace(email) && 
			   !string.IsNullOrWhiteSpace(phoneNumber);
	}

	bool CanProcessPayment()
	{
		if (processingPayment || !agreeToTerms) return false;
		return IsBasicInfoValid();
	}

	async Task ProcessPayment()
	{
		if (!CanProcessPayment()) 
		{
			errorMessage = "Please fill in all required fields and agree to the terms.";
			StateHasChanged();
			return;
		}

		processingPayment = true;
		errorMessage = "";
		successMessage = "";
		StateHasChanged();
		
		try
		{
			Console.WriteLine($"Starting payment processing - Amount: ₱{paymentAmount:N2}");
			Console.WriteLine($"Payment method: {selectedPaymentMethod}, Type: {selectedPaymentType}");
			
			await ProcessWithCheckoutSession();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Payment error: {ex.Message}");
			errorMessage = $"Payment failed: {ex.Message}. Please try again.";
			showPaymentPendingMessage = false;
		}
		finally
		{
			processingPayment = false;
			StateHasChanged();
		}
	}

	async Task ProcessWithCheckoutSession()
	{
		Console.WriteLine("=== Creating PayMongo Checkout Session ===");
		
		// Use placeholder URLs - PayMongo requires valid URLs but we handle the result manually
		var successUrl = "https://checkout.paymongo.com/success";
		var cancelUrl = "https://checkout.paymongo.com/cancel";

		string[] paymentMethods = selectedPaymentMethod switch
		{
			"card" => new[] { "card" },
			"gcash" => new[] { "gcash" },
			"paymaya" => new[] { "paymaya" },
			_ => new[] { "card", "gcash", "paymaya" }
		};

		var description = selectedPaymentType == "full" 
			? $"InnSight Hotel - Full Payment"
			: $"InnSight Hotel - 50% Downpayment";

		var checkoutRequest = new Hospitality.Services.CreateCheckoutSessionRequest
		{
			Amount = (int)(paymentAmount * 100), // Convert to centavos
			Currency = "PHP",
			Description = description,
			LineItemName = string.Join(", ", selectedRoomNames),
			LineItemDescription = $"{GetNights()} night(s) - Check-in: {checkInDate:MMM dd, yyyy}",
			PaymentMethodTypes = paymentMethods,
			SuccessUrl = successUrl,
			CancelUrl = cancelUrl,
			ReferenceNumber = $"PEND-{DateTime.Now:yyyyMMddHHmmss}",
			Billing = new Hospitality.Services.CheckoutBilling
			{
				Name = $"{firstName} {lastName}",
				Email = email,
				Phone = phoneNumber
			},
			Metadata = new Dictionary<string, string>
			{
				{ "client_id", clientId.ToString() },
				{ "payment_type", selectedPaymentType },
				{ "loyalty_tier", loyaltyTier }
			}
		};

		var result = await PayMongoService.CreateCheckoutSessionAsync(checkoutRequest);
		
		if (!result.Success)
		{
			throw new Exception(result.ErrorMessage);
		}

		paymentIntentId = result.CheckoutSessionId;
		lastCheckoutUrl = result.CheckoutUrl;
		Console.WriteLine($"✅ Checkout session created: {paymentIntentId}");

		if (!string.IsNullOrEmpty(result.CheckoutUrl))
		{
			try
			{
				await Microsoft.Maui.ApplicationModel.Launcher.OpenAsync(new Uri(result.CheckoutUrl));
				showPaymentPendingMessage = true;
				StateHasChanged();
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error opening browser: {ex.Message}");
				Navigation.NavigateTo(result.CheckoutUrl, true);
			}
		}
		else
		{
			throw new Exception("Checkout URL not received from PayMongo");
		}
	}

	async Task ConfirmPaymentComplete()
	{
		Console.WriteLine("User confirmed payment complete");
		processingPayment = true;
		StateHasChanged();

		try
		{
			if (pendingBooking != null)
			{
				// Create booking now that payment is confirmed
				Console.WriteLine("Creating booking after successful payment...");
				
				var (newBookingId, success, message) = await PaymentService.CreateBookingWithPaymentAsync(
					pendingBooking,
					paymentAmount,
					selectedPaymentMethod,
					selectedPaymentType,
					paymentIntentId,
					paymentIntentId
				);

				if (success)
				{
					Console.WriteLine($"✅ Booking {newBookingId} created successfully!");
					
					// Award loyalty points
					await LoyaltyService.AddPointsForBookingAsync(
						pendingBooking.client_id, 
						newBookingId, 
						totalAmount
					);
					
					// Navigate to confirmation
					Navigation.NavigateTo($"/booking/confirmation/{clientId}/{newBookingId}");
				}
				else
				{
					errorMessage = $"Error creating booking: {message}";
					showPaymentPendingMessage = false;
				}
			}
			else if (bookingId.HasValue)
			{
				// This is an additional payment for existing booking
				var (success, message) = await PaymentService.AddPaymentToBookingAsync(
					bookingId.Value,
					paymentAmount,
					selectedPaymentMethod,
					selectedPaymentType,
					totalAmount,
					paymentIntentId
				);

				if (success)
				{
					Navigation.NavigateTo($"/booking/confirmation/{clientId}/{bookingId.Value}");
				}
				else
				{
					errorMessage = $"Error recording payment: {message}";
					showPaymentPendingMessage = false;
				}
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error confirming payment: {ex.Message}");
			errorMessage = $"Error: {ex.Message}";
			showPaymentPendingMessage = false;
		}
		finally
		{
			processingPayment = false;
			StateHasChanged();
		}
	}

	async Task RetryPayment()
	{
		if (!string.IsNullOrEmpty(lastCheckoutUrl))
		{
			try
			{
				await Microsoft.Maui.ApplicationModel.Launcher.OpenAsync(new Uri(lastCheckoutUrl));
			}
			catch
			{
				Navigation.NavigateTo(lastCheckoutUrl, true);
			}
		}
		else
		{
			showPaymentPendingMessage = false;
			StateHasChanged();
		}
	}

	void CancelPayment()
	{
		showPaymentPendingMessage = false;
		errorMessage = "Payment cancelled. You can try again when ready.";
		StateHasChanged();
	}

	void GoBack()
	{
		var checkInStr = checkInDate.ToString("yyyy-MM-dd");
		var checkOutStr = checkOutDate.ToString("yyyy-MM-dd");
		Navigation.NavigateTo($"/booking/rooms/{clientId}/{adults}/1/{checkInStr}/{checkOutStr}");
	}
}