@page "/booking/payment/{clientId:int}/{bookingId:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.BookingService BookingService
@inject Hospitality.Services.UserService UserService
@inject Hospitality.Services.PayMongoService PayMongoService
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="css/payment.css" />

<div class="payment-page">
	<!-- Top Navigation Bar -->
	<nav class="top-nav">
		<div class="nav-left">
			<div class="brand">
				<img src="images/InnSight.png" alt="InnSight" style="height: 32px; width: auto; margin-right: 8px;" />
				<span class="brand-name">InnSight</span>
				<span class="brand-sub">Guest Portal</span>
			</div>
		</div>
		<div class="nav-center">
			<a href="@GetDashboardLink()" class="nav-link">Dashboard</a>
			<a href="#" class="nav-link">Stays</a>
			<a href="#" class="nav-link">Loyalty</a>
			<a href="#" class="nav-link">Messages</a>
		</div>
		<div class="nav-right">
			<span class="points-badge">Gold • @LoyaltyPoints pts</span>
			<div class="user-menu">
				<div class="user-avatar-small">@GetInitials()</div>
			</div>
		</div>
	</nav>

	<div class="payment-container">
		<div class="payment-content">
			<!-- Left Panel - Payment Form -->
			<div class="payment-left">
				<div class="page-header">
					<h1 class="page-title">Complete your booking</h1>
					<p class="page-subtitle">Secure payment powered by PayMongo</p>
				</div>

				@if (loading)
				{
					<div class="loading-container">
						<div class="spinner"></div>
						<p>Loading payment details...</p>
					</div>
				}
				else if (showPaymentPendingMessage)
				{
					<!-- Payment Pending - User needs to complete payment in browser -->
					<div class="payment-pending-card" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 16px; padding: 32px; text-align: center; margin-bottom: 24px;">
						<div style="font-size: 64px; margin-bottom: 16px;">??</div>
						<h2 style="color: #2e7d32; font-size: 24px; margin-bottom: 12px;">Payment Page Opened</h2>
						<p style="color: #388e3c; font-size: 16px; margin-bottom: 24px;">
							Complete your payment in the browser window that opened.<br/>
							Once done, click the button below to confirm.
						</p>
						
						<div style="display: flex; flex-direction: column; gap: 12px; max-width: 300px; margin: 0 auto;">
							<button class="btn-primary" @onclick="ConfirmPaymentComplete" style="padding: 16px 32px; font-size: 16px;">
								? I've Completed Payment
							</button>
							<button class="btn-secondary" @onclick="RetryPayment" style="padding: 12px 24px;">
								?? Open Payment Page Again
							</button>
							<button class="btn-secondary" @onclick="CancelPayment" style="padding: 12px 24px;">
								? Cancel
							</button>
						</div>
					</div>
				}
				else
				{
					<!-- Success Message -->
					@if (!string.IsNullOrEmpty(successMessage))
					{
						<div class="success-banner" style="background: #e6ffe6; border: 1px solid #4caf50; padding: 15px; margin-bottom: 20px; border-radius: 8px; color: #2e7d32;">
							<div style="display: flex; align-items: center; gap: 10px;">
								<span style="font-size: 18px;">?</span>
								<div>
									<strong>Payment Successful</strong>
									<div style="margin-top: 5px;">@successMessage</div>
								</div>
							</div>
						</div>
					}

					<!-- Error Message -->
					@if (!string.IsNullOrEmpty(errorMessage))
					{
						<div class="error-banner" style="background: #ffe6e6; border: 1px solid #ff6b6b; padding: 15px; margin-bottom: 20px; border-radius: 8px; color: #d63031;">
							<div style="display: flex; align-items: center; gap: 10px;">
								<span style="font-size: 18px;">?</span>
								<div>
									<strong>Payment Error</strong>
									<div style="margin-top: 5px;">@errorMessage</div>
								</div>
							</div>
						</div>
					}

					<!-- Guest Information -->
					<div class="form-section">
						<div class="section-header">
							<h3 class="section-title">Guest Information</h3>
							<span class="section-subtitle">Confirm your details</span>
						</div>
						<div class="guest-info">
							<div class="input-row">
								<div class="input-field">
									<label class="field-label">First Name <span class="required">*</span></label>
									<input type="text" @bind="firstName" class="text-input" placeholder="Enter first name" required />
								</div>
								<div class="input-field">
									<label class="field-label">Last Name <span class="required">*</span></label>
									<input type="text" @bind="lastName" class="text-input" placeholder="Enter last name" required />
								</div>
							</div>
							<div class="input-row">
								<div class="input-field">
									<label class="field-label">Email Address <span class="required">*</span></label>
									<input type="email" @bind="email" class="text-input" placeholder="your.email@example.com" required />
								</div>
								<div class="input-field">
									<label class="field-label">Phone Number <span class="required">*</span></label>
									<input type="tel" @bind="phoneNumber" class="text-input" placeholder="+63 999 123 4567" required />
								</div>
							</div>
						</div>
					</div>

					<!-- Payment Method Selection -->
					<div class="form-section">
						<div class="section-header">
							<h3 class="section-title">Payment Method</h3>
							<span class="section-subtitle">Choose how you'd like to pay</span>
						</div>
						<div class="payment-methods">
							<button type="button" class="payment-method @(selectedPaymentMethod == "card" ? "selected" : "")" @onclick="SelectCardPayment">
								<div class="method-icon">??</div>
								<div class="method-details">
									<div class="method-name">Credit/Debit Card</div>
									<div class="method-desc">Visa, Mastercard, JCB</div>
								</div>
								<div class="method-radio">
									<input type="radio" name="paymentMethod" value="card" checked="@(selectedPaymentMethod == "card")" />
								</div>
							</button>
							<button type="button" class="payment-method @(selectedPaymentMethod == "gcash" ? "selected" : "")" @onclick="SelectGCashPayment">
								<div class="method-icon">??</div>
								<div class="method-details">
									<div class="method-name">GCash</div>
									<div class="method-desc">Pay with your GCash wallet</div>
								</div>
								<div class="method-radio">
									<input type="radio" name="paymentMethod" value="gcash" checked="@(selectedPaymentMethod == "gcash")" />
								</div>
							</button>
							<button type="button" class="payment-method @(selectedPaymentMethod == "grab_pay" ? "selected" : "")" @onclick="SelectGrabPayPayment">
								<div class="method-icon">??</div>
								<div class="method-details">
									<div class="method-name">GrabPay</div>
									<div class="method-desc">Pay with your GrabPay wallet</div>
								</div>
								<div class="method-radio">
									<input type="radio" name="paymentMethod" value="grab_pay" checked="@(selectedPaymentMethod == "grab_pay")" />
								</div>
							</button>
						</div>
					</div>

					<!-- Terms and Conditions -->
					<div class="form-section">
						<div class="terms-section">
							<label class="checkbox-container">
								<input type="checkbox" @bind="agreeToTerms" />
								<span class="checkmark"></span>
								<span class="checkbox-text">
									I agree to the <a href="#" class="terms-link">Terms and Conditions</a> 
									and <a href="#" class="terms-link">Privacy Policy</a>
								</span>
							</label>
							<label class="checkbox-container">
								<input type="checkbox" @bind="subscribeToOffers" />
								<span class="checkmark"></span>
								<span class="checkbox-text">
									I would like to receive special offers and updates via email
								</span>
							</label>
						</div>
					</div>

					<!-- Payment Buttons -->
					<div class="payment-actions">
						<button class="btn-secondary" @onclick="GoBack">
							? Back to Rooms
						</button>
						<button class="btn-primary @(CanProcessPayment() ? "" : "disabled")" 
								@onclick="ProcessPayment" 
								disabled="@(!CanProcessPayment() || processingPayment)"
								style="min-width: 200px;">
							@if (processingPayment)
							{
								<span class="spinner-small"></span>
								<span>Processing...</span>
							}
							else
							{
								<span>Pay ?@totalAmount.ToString("N2")</span>
							}
						</button>
					</div>
				}
			</div>

			<!-- Right Panel - Booking Summary -->
			<div class="payment-right">
				<div class="summary-card">
					<div class="summary-header">
						<div class="summary-icon">??</div>
						<h3>Booking Summary</h3>
					</div>

					@if (booking != null)
					{
						<!-- Hotel Details -->
						<div class="summary-section">
							<div class="hotel-info">
								<div class="hotel-details">
									<h4 class="hotel-name">InnSight Hotel</h4>
									<div class="hotel-location">?? Waterfront, San Francisco</div>
									<div class="hotel-rating">????? 4.8 (2,847 reviews)</div>
								</div>
							</div>
						</div>

						<!-- Stay Details -->
						<div class="summary-section">
							<h4 class="section-title">Stay Details</h4>
							<div class="stay-info">
								<div class="info-row">
									<span class="info-label">Room Type</span>
									<span class="info-value">@booking.room_name</span>
								</div>
								<div class="info-row">
									<span class="info-label">Check-in</span>
									<span class="info-value">@booking.check_in_date.ToString("ddd, MMM dd") • 3:00 PM</span>
								</div>
								<div class="info-row">
									<span class="info-label">Check-out</span>
									<span class="info-value">@booking.check_out_date.ToString("ddd, MMM dd") • 11:00 AM</span>
								</div>
								<div class="info-row">
									<span class="info-label">Guests</span>
									<span class="info-value">@booking.person_count adult@(booking.person_count != 1 ? "s" : "")</span>
								</div>
								<div class="info-row">
									<span class="info-label">Nights</span>
									<span class="info-value">@GetNights() night@(GetNights() != 1 ? "s" : "")</span>
								</div>
							</div>
						</div>

						<!-- Price Breakdown -->
						<div class="summary-section">
							<h4 class="section-title">Price Breakdown</h4>
							<div class="price-breakdown">
								<div class="price-row">
									<span class="price-label">@booking.room_name x @GetNights() nights</span>
									<span class="price-value">?@((booking.room_price ?? 0) * GetNights()).ToString("N2")</span>
								</div>
								<div class="price-row">
									<span class="price-label">Taxes & Fees</span>
									<span class="price-value">?@taxesAndFees.ToString("N2")</span>
								</div>
								<div class="price-row discount">
									<span class="price-label">Gold Member Discount</span>
									<span class="price-value">-?@goldDiscount.ToString("N2")</span>
								</div>
								<div class="price-row total">
									<span class="price-label">Total</span>
									<span class="price-value">?@totalAmount.ToString("N2")</span>
								</div>
							</div>
						</div>
					}
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public int clientId { get; set; }
	[Parameter] public int bookingId { get; set; }

	// User and booking data
	Hospitality.Models.User? user;
	Hospitality.Models.Booking? booking;

	// Loading states
	bool loading = true;
	bool processingPayment = false;
	bool showPaymentPendingMessage = false;
	string errorMessage = "";
	string successMessage = "";
	string lastCheckoutUrl = "";

	// Guest information
	string firstName = "";
	string lastName = "";
	string email = "";
	string phoneNumber = "";

	// Payment details
	string selectedPaymentMethod = "gcash";

	// Terms and conditions
	bool agreeToTerms = false;
	bool subscribeToOffers = false;

	// PayMongo payment tracking
	string paymentIntentId = "";

	// Pricing
	decimal taxesAndFees = 96.50m;
	decimal goldDiscount = 24.80m;
	decimal totalAmount = 0;
	int LoyaltyPoints = 0;

	protected override async Task OnInitializedAsync()
	{
		loading = true;
		errorMessage = "";
		
		try
		{
			Console.WriteLine($"Payment page initialized with clientId: {clientId}, bookingId: {bookingId}");
			
			user = await UserService.GetUserByIdAsync(clientId);
			
			if (user != null)
			{
				firstName = user.user_fname ?? "";
				lastName = user.user_lname ?? "";
				email = user.user_email ?? "";
				phoneNumber = user.user_contact_number ?? "";
				Console.WriteLine($"Loaded user: {firstName} {lastName}, Email: {email}");
			}

			// Load actual booking data from database
			try
			{
				booking = await BookingService.GetBookingByIdAsync(bookingId);
				Console.WriteLine($"Loaded booking: {booking?.booking_id}, Room: {booking?.room_name}");
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error loading booking: {ex.Message}");
				booking = new Hospitality.Models.Booking
				{
					booking_id = bookingId,
					client_id = clientId,
					room_name = "Deluxe King Suite",
					check_in_date = DateTime.Today.AddDays(1),
					check_out_date = DateTime.Today.AddDays(4),
					person_count = 2,
					room_price = 248m,
					booking_status = "pending"
				};
			}

			CalculateTotalAmount();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading payment data: {ex.Message}");
			errorMessage = $"Error loading payment details: {ex.Message}";
		}
		finally
		{
			loading = false;
		}
	}

	string GetInitials()
	{
		if (user == null) return "G";
		var parts = new List<string>();
		if (!string.IsNullOrWhiteSpace(user.user_fname)) parts.Add(user.user_fname.Substring(0, 1));
		if (!string.IsNullOrWhiteSpace(user.user_lname)) parts.Add(user.user_lname.Substring(0, 1));
		return string.Join("", parts).ToUpperInvariant();
	}

	string GetDashboardLink() => $"/client/profile/{clientId}";

	int GetNights()
	{
		if (booking == null) return 0;
		return (int)(booking.check_out_date - booking.check_in_date).TotalDays;
	}

	void CalculateTotalAmount()
	{
		if (booking?.room_price == null) return;
		var subtotal = booking.room_price.Value * GetNights();
		totalAmount = subtotal + taxesAndFees - goldDiscount;
	}

	int GetAmountInCents() => (int)(totalAmount * 100);

	void SelectCardPayment() => selectedPaymentMethod = "card";
	void SelectGCashPayment() => selectedPaymentMethod = "gcash";
	void SelectGrabPayPayment() => selectedPaymentMethod = "grab_pay";

	bool IsBasicInfoValid()
	{
		return !string.IsNullOrWhiteSpace(firstName) && 
			   !string.IsNullOrWhiteSpace(lastName) && 
			   !string.IsNullOrWhiteSpace(email) && 
			   !string.IsNullOrWhiteSpace(phoneNumber);
	}

	bool CanProcessPayment()
	{
		if (processingPayment || !agreeToTerms) return false;
		return IsBasicInfoValid();
	}

	async Task ProcessPayment()
	{
		if (!CanProcessPayment()) 
		{
			errorMessage = "Please fill in all required fields and agree to the terms.";
			StateHasChanged();
			return;
		}

		processingPayment = true;
		errorMessage = "";
		successMessage = "";
		StateHasChanged();
		
		try
		{
			Console.WriteLine($"Starting payment processing for booking {bookingId}");
			Console.WriteLine($"Payment method: {selectedPaymentMethod}");
			Console.WriteLine($"Total amount: ?{totalAmount:N2} ({GetAmountInCents()} centavos)");
			
			await ProcessWithCheckoutSession();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Payment error: {ex.Message}");
			errorMessage = $"Payment failed: {ex.Message}. Please try again.";
			showPaymentPendingMessage = false;
		}
		finally
		{
			processingPayment = false;
			StateHasChanged();
		}
	}

	async Task ProcessWithCheckoutSession()
	{
		Console.WriteLine("=== Creating PayMongo Checkout Session ===");
		
		// For MAUI apps, use a generic success URL since external browser can't redirect back
		var successUrl = "https://www.google.com/search?q=payment+successful";
		var cancelUrl = "https://www.google.com/search?q=payment+cancelled";

		string[] paymentMethods = selectedPaymentMethod switch
		{
			"card" => new[] { "card" },
			"gcash" => new[] { "gcash" },
			"grab_pay" => new[] { "grab_pay" },
			_ => new[] { "card", "gcash", "grab_pay" }
		};

		var checkoutRequest = new Hospitality.Services.CreateCheckoutSessionRequest
		{
			Amount = GetAmountInCents(),
			Currency = "PHP",
			Description = $"InnSight Hotel Booking #{bookingId}",
			LineItemName = booking?.room_name ?? "Hotel Room",
			LineItemDescription = $"{GetNights()} night(s) - Check-in: {booking?.check_in_date:MMM dd, yyyy}",
			PaymentMethodTypes = paymentMethods,
			SuccessUrl = successUrl,
			CancelUrl = cancelUrl,
			ReferenceNumber = $"BOOK-{bookingId:D6}",
			Billing = new Hospitality.Services.CheckoutBilling
			{
				Name = $"{firstName} {lastName}",
				Email = email,
				Phone = phoneNumber
			},
			Metadata = new Dictionary<string, string>
			{
				{ "booking_id", bookingId.ToString() },
				{ "client_id", clientId.ToString() },
				{ "room_name", booking?.room_name ?? "" }
			}
		};

		var result = await PayMongoService.CreateCheckoutSessionAsync(checkoutRequest);
		
		if (!result.Success)
		{
			throw new Exception(result.ErrorMessage);
		}

		paymentIntentId = result.CheckoutSessionId;
		lastCheckoutUrl = result.CheckoutUrl;
		Console.WriteLine($"? Checkout session created: {paymentIntentId}");
		Console.WriteLine($"? Checkout URL: {result.CheckoutUrl}");

		await BookingService.UpdateBookingStatusAsync(bookingId, "pending_payment");

		if (!string.IsNullOrEmpty(result.CheckoutUrl))
		{
			try
			{
				await Microsoft.Maui.ApplicationModel.Launcher.OpenAsync(new Uri(result.CheckoutUrl));
				showPaymentPendingMessage = true;
				StateHasChanged();
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error opening browser: {ex.Message}");
				Navigation.NavigateTo(result.CheckoutUrl, true);
			}
		}
		else
		{
			throw new Exception("Checkout URL not received from PayMongo");
		}
	}

	async Task ConfirmPaymentComplete()
	{
		Console.WriteLine("User confirmed payment complete");
		
		// Update booking status to confirmed
		await BookingService.UpdateBookingStatusAsync(bookingId, "confirmed");
		
		// Navigate to dashboard with success message
		Navigation.NavigateTo($"/client/profile/{clientId}");
	}

	async Task RetryPayment()
	{
		if (!string.IsNullOrEmpty(lastCheckoutUrl))
		{
			try
			{
				await Microsoft.Maui.ApplicationModel.Launcher.OpenAsync(new Uri(lastCheckoutUrl));
			}
			catch
			{
				Navigation.NavigateTo(lastCheckoutUrl, true);
			}
		}
		else
		{
			showPaymentPendingMessage = false;
			StateHasChanged();
		}
	}

	void CancelPayment()
	{
		showPaymentPendingMessage = false;
		errorMessage = "Payment cancelled. You can try again when ready.";
		StateHasChanged();
	}

	void GoBack()
	{
		Navigation.NavigateTo($"/booking/rooms/{clientId}");
	}
}