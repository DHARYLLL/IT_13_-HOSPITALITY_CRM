@page "/booking/new"
@page "/booking/new/{clientId:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.RoomService RoomService
@inject Hospitality.Services.BookingService BookingService
@inject Hospitality.Services.UserService UserService
@inject Hospitality.Services.LoyaltyService LoyaltyService

<link rel="stylesheet" href="css/newbooking.css" />

<div class="booking-page">
	<!-- Top Navigation Bar - Consistent with Client Profile -->
	<nav class="top-nav">
		<div class="nav-left">
			<div class="brand">
				<img src="images/InnSight.png" alt="InnSight" style="height: 32px; width: auto; margin-right: 8px;" />
				<span class="brand-name">InnSight</span>
				<span class="brand-sub">Guest Portal</span>
			</div>
		</div>
		<div class="nav-center">
			<a href="@GetDashboardLink()" class="nav-link @(IsActive("Dashboard"))">Dashboard</a>
			<a href="@(clientId.HasValue ? $"/client/stays/{clientId.Value}" : "/")" class="nav-link">Stays</a>
			<a href="@(clientId.HasValue ? $"/client/loyalty/{clientId.Value}" : "/")" class="nav-link">Loyalty</a>
			<a href="@(clientId.HasValue ? $"/client/messages/{clientId.Value}" : "/")" class="nav-link">Messages</a>
		</div>
		<div class="nav-right">
			<span class="points-badge">@loyaltyTier • @LoyaltyPoints pts</span>
			<div class="user-menu">
				<div class="user-avatar-small" @onclick="ToggleDropdown">@GetInitials()</div>
				@if (isDropdownOpen)
				{
					<div class="user-dropdown">
						<button class="dropdown-item" title="Logout" @onclick="Logout">Logout</button>
					</div>
				}
			</div>
		</div>
	</nav>

	<div class="booking-container">
		<!-- Left Panel - Form -->
		<div class="booking-left">
			<div class="page-title-section">
				<h1 class="page-title">Book a stay</h1>
				<p class="page-subtitle">Choose your dates and room preferences to see available options.</p>
			</div>

			<!-- Stay Details Section -->
			<div class="form-card">
				<div class="card-header">
					<div class="card-icon">📅</div>
					<div class="card-title-group">
						<h3>Stay details</h3>
						<span class="step-badge">Step 1 of 3</span>
					</div>
					<button class="collapse-btn">Choose dates & guests</button>
				</div>

				<div class="form-content">
					@if (!string.IsNullOrEmpty(validationMessage))
					{
						<div class="validation-message error">
							<span class="error-icon">⚠️</span>
							@validationMessage
						</div>
					}

					<!-- Where and when -->
					<div class="form-group">
						<label class="form-label">Where and when</label>
						<div class="input-row">
							<div class="input-field full-width">
								<label class="field-label">Destination</label>
								<input type="text" class="text-input" value="InnSight Hotel" readonly/>
							</div>
						</div>
						<div class="input-row">
							<div class="input-field">
								<label class="field-label">Check-in</label>
								<input type="date" @bind="checkInDate" class="date-input" />
								<span class="date-display">
									@if (checkInDate.HasValue)
									{
										@($"{checkInDate.Value:ddd, MMM dd} • 3:00 PM")
									}
									else
									{
										<text>Select check-in date</text>
									}
								</span>
							</div>
							<div class="input-field">
								<label class="field-label">Check-out</label>
								<input type="date" @bind="checkOutDate" class="date-input" />
								<span class="date-display">
									@if (checkOutDate.HasValue)
									{
										@($"{checkOutDate.Value:ddd, MMM dd} • 11:00 AM")
									}
									else
									{
										<text>Select check-out date</text>
									}
								</span>
							</div>
						</div>
					</div>

					<!-- Guests & Rooms -->
					<div class="form-group">
						<div class="input-row">
							<div class="input-field">
								<label class="field-label">Adults</label>
								<div class="counter-input">
									<button class="counter-btn" @onclick="() => ChangeAdults(-1)">−</button>
									<span class="counter-value">@adults adult@(adults != 1 ? "s" : "")</span>
									<button class="counter-btn" @onclick="() => ChangeAdults(1)">+</button>
								</div>
							</div>
							<div class="input-field">
								<label class="field-label">Rooms</label>
								<div class="counter-input">
									<button class="counter-btn" @onclick="() => ChangeRooms(-1)">−</button>
									<span class="counter-value">@rooms room@(rooms != 1 ? "s" : "")</span>
									<button class="counter-btn" @onclick="() => ChangeRooms(1)">+</button>
								</div>
							</div>
						</div>
						<div class="input-row">
							<div class="input-field full-width">
								<span class="field-note">@adults adult@(adults != 1 ? "s" : "") • @NightsCount night@(NightsCount != 1 ? "s" : "")</span>
							</div>
						</div>
					</div>

					<!-- Special Requests Only -->
					<div class="form-group">
						<label class="form-label">Special requests <span class="info-text">Optional</span></label>
						<textarea @bind="specialRequests" class="textarea-input" rows="2"
						   placeholder="Add preferences like high floor, late arrival, or accessibility needs."></textarea>
					</div>
				</div>
			</div>

			<!-- Trip Info Banner -->
			<div class="trip-info">
				<div class="trip-dates">
					<span class="trip-icon">📅</span>
					<span>
						@if (checkInDate.HasValue && checkOutDate.HasValue)
						{
							@($"{checkInDate.Value:ddd, MMM dd} 3:00 PM – {checkOutDate.Value:ddd, MMM dd} 11:00 AM")
						}
						else
						{
							<text>Select your travel dates</text>
						}
					</span>
				</div>
				<span class="trip-note">Changes are free until 24 hours before check-in</span>
			</div>

			<!-- Action Buttons -->
			<div class="action-buttons">
				<button class="btn-primary" @onclick="SearchRooms">
					🔍 Search available rooms
				</button>
			</div>
		</div>

		<!-- Right Panel - Summary -->
		<div class="booking-right">
			<div class="summary-card">
				<div class="summary-header">
					<div class="summary-icon">📊</div>
					<h3>Stay summary</h3>
					@if (discountPercentage > 0)
					{
						<span style="background: linear-gradient(135deg, #ffd700, #ffb800); color: #000; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
							@loyaltyTier - @discountPercentage% discount
						</span>
					}
				</div>

				<div class="summary-section">
					<h4 class="summary-title">Selected details</h4>
					<div class="summary-item">
						<span class="summary-label">@destination</span>
					</div>
					<div class="summary-item">
						<span class="summary-label">@adults adult@(adults != 1 ? "s" : "") • @rooms room@(rooms != 1 ? "s" : "") • @NightsCount night@(NightsCount != 1 ? "s" : "")</span>
					</div>
				</div>

				<div class="summary-section">
					<div class="date-cards-row">
						<div class="date-card check-in">
							<div class="date-label">Check-in</div>
							<div class="date-value">
								@if (checkInDate.HasValue)
								{
									@checkInDate.Value.ToString("ddd, MMM dd")
								}
								else
								{
									<text>Select date</text>
								}
							</div>
							<div class="date-time">• 3:00 PM</div>
						</div>
						<div class="date-card check-out">
							<div class="date-label">Check-out</div>
							<div class="date-value">
								@if (checkOutDate.HasValue)
								{
									@checkOutDate.Value.ToString("ddd, MMM dd")
								}
								else
								{
									<text>Select date</text>
								}
							</div>
							<div class="date-time">• 11:00 AM</div>
						</div>
					</div>
				</div>

				@if (discountPercentage > 0)
				{
					<div class="summary-section">
						<div class="offer-badge">
							<span class="badge-icon">🎁</span>
							<div class="badge-content">
								<div class="badge-title">@loyaltyTier member discount</div>
								<div class="badge-desc">@discountPercentage% off your stay as a @loyaltyTier member</div>
							</div>
						</div>
					</div>
				}

				<div class="summary-section pricing-section">
					<div class="pricing-label">Estimated nightly rate (Before tax)</div>
					<div class="price-range">
						<span class="price-to">From ₱@EstimatedNightlyRate.ToString("N0")</span>
					</div>
				</div>

				<div class="summary-section">
					<h4 class="summary-title">Points & payment</h4>
					<div class="points-info">
						<div class="points-row">
							<span>Earn → @EstimatedPoints points</span>
						</div>
						<div class="points-sub">You currently have @LoyaltyPoints points</div>
					</div>
				</div>

				<div class="summary-total">
					<div class="total-label">Final amount shown on the next step before confirming.</div>
					<div class="total-amount">₱@EstimatedTotal.ToString("N2")</div>
					@if (discountPercentage > 0)
					{
						<div style="font-size: 12px; color: #27ae60;">Includes @discountPercentage% @loyaltyTier discount</div>
					}
				</div>

				<div class="summary-section">
					<h4 class="summary-title">Policies</h4>
					<ul class="policy-list">
						<li>Minimum 50% downpayment required to confirm</li>
						<li>Late checkout subject to availability for @loyaltyTier members</li>
						<li>Free cancellation up to 24 hours before check-in</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public int? clientId { get; set; }

	DateTime? checkInDate = null; 
	DateTime? checkOutDate = null; 
	string destination = "InnSight Hotel";
	int adults = 2;
	int rooms = 1;
	string specialRequests = "";
	int LoyaltyPoints = 0;
	string loyaltyTier = "Bronze";
	decimal discountPercentage = 0;
	string validationMessage = "";

	Hospitality.Models.User? user;
	bool isDropdownOpen = false;

	protected override async Task OnInitializedAsync()
	{
		// Set default dates
		if (!checkInDate.HasValue)
		{
			checkInDate = DateTime.Today.AddDays(1);
		}
		if (!checkOutDate.HasValue)
		{
			checkOutDate = DateTime.Today.AddDays(3);
		}

		// Load user and loyalty data
		if (clientId.HasValue)
		{
			try
			{
				user = await UserService.GetUserByIdAsync(clientId.Value);
				await LoadLoyaltyInfo();
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error loading user data: {ex.Message}");
			}
		}
	}

	async Task LoadLoyaltyInfo()
	{
		if (!clientId.HasValue) return;
		
		try
		{
			// Get client_id from user_id
			using var con = Hospitality.Database.DbConnection.GetConnection();
			await con.OpenAsync();
			
			string clientIdSql = "SELECT client_id FROM clients WHERE user_id = @userId";
			using var clientCmd = new Microsoft.Data.SqlClient.SqlCommand(clientIdSql, con);
			clientCmd.Parameters.AddWithValue("@userId", clientId.Value);
			var clientIdResult = await clientCmd.ExecuteScalarAsync();
			
			if (clientIdResult != null)
			{
				var actualClientId = Convert.ToInt32(clientIdResult);
				var loyalty = await LoyaltyService.GetLoyaltyProgramAsync(actualClientId);
				
				if (loyalty != null)
				{
					loyaltyTier = loyalty.current_tier;
					LoyaltyPoints = loyalty.total_points;
					
					// Calculate discount based on tier
					discountPercentage = loyaltyTier.ToLower() switch
					{
						"silver" => 5m,
						"gold" => 10m,
						"platinum" => 15m,
						_ => 0m
					};
				}
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading loyalty info: {ex.Message}");
		}
	}

	int NightsCount => (checkInDate.HasValue && checkOutDate.HasValue) ? (checkOutDate.Value - checkInDate.Value).Days : 0;
	decimal EstimatedNightlyRate => 248m;
	decimal EstimatedSubtotal => EstimatedNightlyRate * NightsCount;
	decimal EstimatedDiscount => EstimatedSubtotal * (discountPercentage / 100m);
	decimal EstimatedTotal => (EstimatedSubtotal - EstimatedDiscount) * 1.12m; // Add 12% tax
	int EstimatedPoints => (int)(EstimatedTotal * GetPointsMultiplier());

	decimal GetPointsMultiplier()
	{
		return loyaltyTier.ToLower() switch
		{
			"silver" => 1.2m,
			"gold" => 1.5m,
			"platinum" => 2.0m,
			_ => 1.0m
		};
	}

	string GetInitials()
	{
		if (user == null) return "G";
		var parts = new List<string>();
		if (!string.IsNullOrWhiteSpace(user.user_fname)) parts.Add(user.user_fname.Substring(0, 1));
		if (user.user_lname != null && user.user_lname.Length > 0)
		{
			try
			{
				var ln = user.user_lname ?? "";
				if (!string.IsNullOrWhiteSpace(ln)) parts.Add(ln.Substring(0, 1));
			}
			catch { }
		}
		return string.Join("", parts).ToUpperInvariant();
	}

	void ChangeAdults(int delta)
	{
		adults = Math.Max(1, adults + delta);
	}

	void ChangeRooms(int delta)
	{
		rooms = Math.Max(1, rooms + delta);
	}

	string GetDashboardLink()
	{
		if (clientId.HasValue)
		{
			return $"/client/profile/{clientId.Value}";
		}
		return "/";
	}

	string IsActive(string page)
	{
		return page == "Dashboard" ? "" : "";
	}

	void SearchRooms()
	{
		validationMessage = "";
		
		if (!checkInDate.HasValue || !checkOutDate.HasValue)
		{
			validationMessage = "Please select both check-in and check-out dates.";
			StateHasChanged();
			return;
		}

		if (checkInDate.Value >= checkOutDate.Value)
		{
			validationMessage = "Check-out date must be after check-in date.";
			StateHasChanged();
			return;
		}

		if (checkInDate.Value < DateTime.Today)
		{
			validationMessage = "Check-in date cannot be in the past.";
			StateHasChanged();
			return;
		}

		var checkInStr = checkInDate.Value.ToString("yyyy-MM-dd");
		var checkOutStr = checkOutDate.Value.ToString("yyyy-MM-dd");
		
		Console.WriteLine($"Navigating to room selection: adults={adults}, rooms={rooms}");
		
		try
		{
			if (clientId.HasValue)
			{
				var url = $"/booking/rooms/{clientId.Value}/{adults}/{rooms}/{checkInStr}/{checkOutStr}";
				Console.WriteLine($"Navigation URL: {url}");
				Navigation.NavigateTo(url);
			}
			else
			{
				var url = $"/booking/rooms/1/{adults}/{rooms}/{checkInStr}/{checkOutStr}";
				Console.WriteLine($"Navigation URL (guest): {url}");
				Navigation.NavigateTo(url);
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Navigation error: {ex.Message}");
			validationMessage = "Error navigating to room selection. Please try again.";
			StateHasChanged();
		}
	}

	void ToggleDropdown() => isDropdownOpen = !isDropdownOpen;
	void Logout() => Navigation.NavigateTo("/");
}
