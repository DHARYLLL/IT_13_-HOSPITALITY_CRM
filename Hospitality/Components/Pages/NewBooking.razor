@page "/booking/new"
@page "/booking/new/{clientId:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.RoomService RoomService
@inject Hospitality.Services.BookingService BookingService

<link rel="stylesheet" href="css/newbooking.css" />

<div class="booking-page">
	<!-- Top Navigation Bar - Consistent with Client Profile -->
	<nav class="top-nav">
		<div class="nav-left">
			<div class="brand">
				<img src="images/InnSight.png" alt="InnSight" style="height: 32px; width: auto; margin-right: 8px;" />
				<span class="brand-name">InnSight</span>
				<span class="brand-sub">Guest Portal</span>
			</div>
		</div>
		<div class="nav-center">
			<a href="@GetDashboardLink()" class="nav-link @(IsActive("Dashboard"))">Dashboard</a>
			<a href="#" class="nav-link">Stays</a>
			<a href="#" class="nav-link">Loyalty</a>
			<a href="#" class="nav-link">Messages</a>
			<a href="#" class="nav-link">Reports</a>
		</div>
		<div class="nav-right">
			<span class="points-badge">Gold • @LoyaltyPoints pts</span>
			<div class="user-menu">
				<span class="user-name">dharyl</span>
				<div class="user-avatar-small">D</div>
			</div>
		</div>
	</nav>

	<div class="booking-container">
		<!-- Left Panel - Form -->
		<div class="booking-left">
			<div class="page-title-section">
				<h1 class="page-title">Book a stay</h1>
				<p class="page-subtitle">Choose your dates and room preferences to see available options.</p>
			</div>

			<!-- Stay Details Section -->
			<div class="form-card">
				<div class="card-header">
					<div class="card-icon">📅</div>
					<div class="card-title-group">
						<h3>Stay details</h3>
						<span class="step-badge">Step 1 of 3</span>
					</div>
					<button class="collapse-btn">Choose dates & guests</button>
				</div>

				<div class="form-content">
					<!-- Where and when -->
					<div class="form-group">
						<label class="form-label">Where and when</label>
						<div class="input-row">
							<div class="input-field full-width">
								<label class="field-label">Destination <span class="required">Required</span></label>
								<input type="text" class="text-input" value="InnSight Waterfront" readonly />
							</div>
						</div>
						<div class="input-row">
							<div class="input-field">
								<label class="field-label">Check-in</label>
								<input type="date" @bind="checkInDate" class="date-input" />
								<span class="date-display">@checkInDate.ToString("ddd, MMM dd")</span>
							</div>
							<div class="input-field">
								<label class="field-label">Check-out</label>
								<input type="date" @bind="checkOutDate" class="date-input" />
								<span class="date-display">@checkOutDate.ToString("ddd, MMM dd")</span>
							</div>
						</div>
					</div>

					<!-- Guests & Rooms -->
					<div class="form-group">
						<div class="input-row">
							<div class="input-field">
								<label class="field-label">Adults</label>
								<div class="counter-input">
									<button class="counter-btn" @onclick="() => ChangeAdults(-1)">−</button>
									<span class="counter-value">@adults adult@(adults != 1 ? "s" : "")</span>
									<button class="counter-btn" @onclick="() => ChangeAdults(1)">+</button>
								</div>
							</div>
							<div class="input-field">
								<label class="field-label">Rooms</label>
								<div class="counter-input">
									<button class="counter-btn" @onclick="() => ChangeRooms(-1)">−</button>
									<span class="counter-value">@rooms room@(rooms != 1 ? "s" : "")</span>
									<button class="counter-btn" @onclick="() => ChangeRooms(1)">+</button>
								</div>
							</div>
						</div>
						<div class="input-row">
							<div class="input-field full-width">
								<span class="field-note">@adults adult@(adults != 1 ? "s" : "")</span>
							</div>
						</div>
					</div>

					<!-- Room & rate preferences -->
					<div class="form-group">
						<label class="form-label">Room & rate preferences</label>
						<div class="input-row">
							<div class="input-field">
								<label class="field-label">Preferred room type</label>
								<select @bind="roomType" class="select-input">
									<option value="Deluxe King Suite">Deluxe King Suite</option>
									<option value="Standard Room">Standard Room</option>
									<option value="Executive Suite">Executive Suite</option>
								</select>
							</div>
							<div class="input-field">
								<label class="field-label">Rate preference <span class="info-text">Best for you</span></label>
								<select @bind="ratePreference" class="select-input">
									<option value="Member flexible rate">Member flexible rate</option>
									<option value="Non-refundable">Non-refundable</option>
								</select>
							</div>
						</div>

						<!-- Special Requests -->
						<div class="input-field full-width">
							<label class="field-label">Special requests <span class="info-text">Optional</span></label>
							<textarea @bind="specialRequests" class="textarea-input" rows="2"
							   placeholder="Add preferences like high floor, late arrival, or accessibility needs."></textarea>
						</div>
					</div>
				</div>
			</div>

			<!-- Trip Info Banner -->
			<div class="trip-info">
				<div class="trip-dates">
					<span class="trip-icon">📅</span>
					<span>@checkInDate.ToString("ddd, MMM dd") – @checkOutDate.ToString("ddd, MMM dd")</span>
				</div>
				<span class="trip-note">Changes are free until 24 hours before check-in</span>
			</div>

			<!-- Action Buttons -->
			<div class="action-buttons">
				<button class="btn-secondary" @onclick="SaveDraft">
					⏰ Save & decide later
				</button>
				<button class="btn-primary" @onclick="SearchRooms">
					🔍 Search available rooms
				</button>
			</div>
		</div>

		<!-- Right Panel - Summary -->
		<div class="booking-right">
			<div class="summary-card">
				<div class="summary-header">
					<div class="summary-icon">📊</div>
					<h3>Stay summary</h3>
				</div>

				<div class="summary-section">
					<h4 class="summary-title">Selected details</h4>
					<div class="summary-item">
						<span class="summary-label">InnSight Waterfront • San Francisco</span>
					</div>
					<div class="summary-item">
						<span class="summary-label">Deluxe King Suite + Bay view</span>
					</div>
					<div class="summary-item">
						<span class="summary-label">@adults adult@(adults != 1 ? "s" : "") • @rooms room@(rooms != 1 ? "s" : "")</span>
					</div>
				</div>

				<div class="summary-section">
					<div class="date-cards-row">
						<div class="date-card check-in">
							<div class="date-label">Check-in</div>
							<div class="date-value">@checkInDate.ToString("ddd, MMM dd")</div>
							<div class="date-time">• @checkInDate.ToString("h:mm tt")</div>
						</div>
						<div class="date-card check-out">
							<div class="date-label">Check-out</div>
							<div class="date-value">@checkOutDate.ToString("ddd, MMM dd")</div>
							<div class="date-time">• @checkOutDate.ToString("h:mm tt")</div>
						</div>
					</div>
				</div>

				<div class="summary-section">
					<div class="offer-badge">
						<span class="badge-icon">🎁</span>
						<div class="badge-content">
							<div class="badge-title">Gold weekend offer applied</div>
							<div class="badge-desc">You earned 1,248 points + 24 points on eligible August weekend stays</div>
						</div>
					</div>
				</div>

				<div class="summary-section pricing-section">
					<div class="pricing-label">Estimated nightly rate (Before tax)</div>
					<div class="price-range">
						@* <span class="price-from">$248</span>
						<span class="price-arrow">→</span> *@
						<span class="price-to">$294</span>
					</div>
				</div>

				<div class="summary-section">
					<h4 class="summary-title">Points & payment</h4>
					<div class="points-info">
						<div class="points-row">
							<span>Earn → 288 points</span>
						</div>
						<div class="points-sub">You can earn 288 points + 2,500 to Platinum</div>
					</div>
					<button class="points-btn">Use points later</button>
				</div>

				<div class="summary-total">
					<div class="total-label">Final amount shown on the next step before confirming.</div>
					<div class="total-amount">$716.50</div>
				</div>

				<div class="summary-section">
					<h4 class="summary-title">Policies</h4>
					<ul class="policy-list">
						<li>Member rate: 14.7 hours before arrival</li>
						<li>Late checkout subject to availability for Gold members</li>
						<li>A credit card is required to guarantee your booking</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public int? clientId { get; set; }

	DateTime checkInDate = DateTime.Today.AddDays(1);
	DateTime checkOutDate = DateTime.Today.AddDays(4);
	int adults = 2;
	int rooms = 1;
	string roomType = "Deluxe King Suite";
	string ratePreference = "Member flexible rate";
	bool includeBreakfast = false;
	bool nonSmoking = false;
	string specialRequests = "";
	int LoyaltyPoints = 12465;

	int NightsCount => (checkOutDate - checkInDate).Days;
	decimal RoomRate => NightsCount * 248m;
	decimal BreakfastPrice => includeBreakfast ? 45m : 0m;
	decimal TaxesFees => 96.50m;
	decimal EstimatedTotal => RoomRate + BreakfastPrice + TaxesFees;

	void ChangeAdults(int delta)
	{
		adults = Math.Max(1, adults + delta);
	}

	void ChangeRooms(int delta)
	{
		rooms = Math.Max(1, rooms + delta);
	}

	string GetDashboardLink()
	{
		if (clientId.HasValue)
		{
			return $"/client/profile/{clientId.Value}";
		}
		return "/";
	}

	string IsActive(string page)
	{
		return page == "Dashboard" ? "" : "";
	}

	void SaveDraft()
	{
		// Save draft logic
	}

	void SearchRooms()
	{
		// Navigate to room selection with client ID if available
		if (clientId.HasValue)
		{
			Navigation.NavigateTo($"/booking/rooms/{clientId.Value}");
		}
		else
		{
			Navigation.NavigateTo("/booking/rooms");
		}
	}
}
