@page "/client/loyalty/{clientId:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.LoyaltyService LoyaltyService
@inject Hospitality.Services.UserService UserService
@inject Hospitality.Services.BookingService BookingService
@using Microsoft.Maui.ApplicationModel.DataTransfer

<link rel="stylesheet" href="css/clientprofile.css" />
<link rel="stylesheet" href="css/client-layout.css" />
<link rel="stylesheet" href="css/client-loyalty.css" />

<div class="loyalty-page">
	<!-- Shared Navigation Component -->
	<ClientNavigation UserId="@clientId" ActivePage="loyalty" User="@user" LoyaltyProgram="@loyalty" />

	@if (!string.IsNullOrEmpty(copiedMessage))
	{
		<div class="notification-toast">
			<i class="icon icon-check"></i>
			<span>@copiedMessage</span>
		</div>
	}

	@if (!string.IsNullOrEmpty(useInstructions))
	{
		<div class="notification-toast instructions-toast">
			<i class="icon icon-gift"></i>
			<span>@useInstructions</span>
		</div>
	}

	<div class="loyalty-container">
		@if (loading)
		{
			<div class="loading-container">
				<p>Loading your loyalty program...</p>
			</div>
		}
		else if (loyalty == null)
		{
			<div class="loading-container">
				<p>Unable to load loyalty program data.</p>
				<p><small>User ID: @clientId</small></p>
			</div>
		}
		else
		{
			<!-- Hero Section -->
			<header class="loyalty-hero">
				<div class="hero-content">
					<h1 class="hero-title">Your loyalty and rewards</h1>
					<p class="hero-subtitle">Track your points, tier progress, and available benefits.</p>
				</div>
				<div class="hero-badge">
					<span class="badge-icon" style="font-size: 48px;">@currentTier.Icon</span>
					<span class="badge-label">Member since @loyalty.member_since.Year</span>
				</div>
			</header>

			<!-- Main Content Grid -->
			<div class="loyalty-grid">
				<!-- Current Status Card -->
				<div class="card status-card">
					<div class="card-header">
						<i class="icon icon-gift"></i>
						<h3>Current status</h3>
						<span class="tier-badge" style="background: @currentTier.Color">@currentTier.Icon @currentTier.Name tier</span>
					</div>

					<div class="status-content">
						<!-- Points Circle -->
						<div class="points-circle-wrapper">
							<svg class="points-circle" viewBox="0 0 160 160">
								<circle cx="80" cy="80" r="70" fill="none" stroke="#e8e8ea" stroke-width="12" />
								<circle cx="80" cy="80" r="70" fill="none" stroke="@currentTier.Color" stroke-width="12"
										stroke-dasharray="@GetCircleProgress() 440" stroke-dashoffset="0"
										transform="rotate(-90 80 80)" stroke-linecap="round" />
							</svg>
							<div class="points-center">
								<div class="points-number">@loyalty.total_points</div>
								<div class="points-label">points</div>
							</div>
						</div>

						<!-- Progress to Next Tier -->
						<div class="tier-progress">
							@if (nextTier != null && currentTier.Name != "Platinum")
							{
								<h4 class="progress-title">Progress to @nextTier.Name</h4>
								<div class="progress-bar-container">
									<div class="progress-bar" style="width: @GetTierProgress()%"></div>
								</div>
								<p class="progress-text">@PointsToNextTier points to reach @nextTier.Name tier</p>
							}
							else
							{
								<p class="progress-text max-tier"><i class="icon icon-star"></i> You've reached the highest tier!</p>
							}
						</div>
					</div>
				</div>

				<!-- Benefits Card -->
				<div class="card benefits-card">
					<div class="card-header">
						<i class="icon icon-gift"></i>
						<h3>@currentTier.Name benefits</h3>
					</div>

					<div class="benefits-content">
						<ul class="benefits-list">
							@foreach (var benefit in currentTier.Benefits)
							{
								<li>
									<i class="icon icon-check"></i>
									<span>@benefit</span>
								</li>
							}
						</ul>
					</div>

					@if (nextTier != null && currentTier.Name != "Platinum")
					{
						<div class="next-tier-preview">
							<h4 class="preview-title">Unlock @nextTier.Name benefits</h4>
							<ul class="preview-list">
								@foreach (var benefit in nextTier.Benefits.Take(3))
								{
									<li>
										<span class="preview-icon">@nextTier.Icon</span>
										<span>@benefit</span>
									</li>
								}
							</ul>
							@if (nextTier.Benefits.Count > 3)
							{
								<p class="preview-note">+ @(nextTier.Benefits.Count - 3) more exclusive benefits</p>
							}
						</div>
					}
				</div>

				<!-- Statistics Card -->
				<div class="card stats-card">
					<div class="card-header">
						<i class="icon icon-calendar"></i>
						<h3>Lifetime statistics</h3>
						<span class="time-label">Since @loyalty.member_since.ToString("MMM yyyy")</span>
					</div>

					<div class="stats-grid">
						<div class="stat-item">
							<div class="stat-number">@loyalty.lifetime_stays</div>
							<div class="stat-label">Total stays</div>
						</div>
						<div class="stat-item">
							<div class="stat-number">PHP @loyalty.lifetime_spend.ToString("N0")</div>
							<div class="stat-label">Total spend</div>
						</div>
						<div class="stat-item">
							<div class="stat-number">@loyalty.total_points</div>
							<div class="stat-label">Points earned</div>
						</div>
						<div class="stat-item">
							<div class="stat-number">@GetAverageNightlyRate()</div>
							<div class="stat-label">Avg. rate/night</div>
						</div>
					</div>
				</div>

				<!-- Available Rewards -->
				<div class="card rewards-card">
					<div class="card-header">
						<i class="icon icon-gift"></i>
						<h3>Available rewards</h3>
						<span class="rewards-count">@availableRewards.Count rewards</span>
					</div>

					@if (availableRewards.Count == 0)
					{
						<p class="empty-text">No rewards available at the moment.</p>
					}
					else
					{
						<div class="rewards-list">
							@foreach (var reward in availableRewards)
							{
								var canRedeem = loyalty.total_points >= reward.points_required;
								<div class="reward-item @(canRedeem ? "available" : "locked")">
									<div class="reward-info">
										<h4 class="reward-name">@reward.reward_name</h4>
										<p class="reward-description">@reward.reward_description</p>
										<div class="reward-cost">
											<span class="cost-points">@reward.points_required points</span>
											@if (!canRedeem)
											{
												<span class="cost-needed">Need @(reward.points_required - loyalty.total_points) more</span>
											}
										</div>
									</div>
									<button class="btn-redeem" 
											disabled="@(!canRedeem)"
											@onclick="() => RedeemReward(reward.reward_id)">
										@if (canRedeem)
										{
											<span>Redeem</span>
										}
										else
										{
											<span><i class="icon icon-lock"></i> Locked</span>
										}
									</button>
								</div>
							}
						</div>
					}
				</div>

				<!-- My Redeemed Rewards -->
				<div class="card redeemed-rewards-card">
					<div class="card-header">
						<i class="icon icon-gift"></i>
						<h3>My redeemed rewards</h3>
					</div>

					<div class="rewards-usage-info">
						<p><strong>How to use your rewards:</strong></p>
						<ul>
							<li><strong>Vouchers:</strong> Copy the voucher code and enter it during booking or present it at check-in</li>
							<li><strong>Services/Upgrades:</strong> Present your voucher code at the front desk during check-in</li>
							<li><strong>Late Checkout:</strong> Request late checkout when making your reservation or at check-in</li>
						</ul>
					</div>

					@if (redeemedRewards.Count == 0)
					{
						<p class="empty-text">You haven't redeemed any rewards yet.</p>
					}
					else
					{
						<div class="table-wrapper">
							<table class="redeemed-rewards-table">
								<thead>
									<tr>
										<th>Reward</th>
										<th>Description</th>
										<th>Voucher Code</th>
										<th>Redeemed</th>
										<th>Expires</th>
										<th>Status</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var redeemed in redeemedRewards)
									{
										var statusClass = redeemed.IsUsed ? "used" : redeemed.IsExpired ? "expired" : "active";
										<tr class="@statusClass">
											<td>
												<strong>@redeemed.reward_name</strong>
												<br />
												<small class="reward-type">@redeemed.reward_type</small>
											</td>
											<td>@redeemed.reward_description</td>
											<td>
												@if (!string.IsNullOrEmpty(redeemed.voucher_code))
												{
													<div class="voucher-code-cell">
														<code class="voucher-code-text @(redeemed.IsUsed || redeemed.IsExpired ? "voucher-used" : "")">@redeemed.voucher_code</code>
														@if (!redeemed.IsUsed && !redeemed.IsExpired)
														{
															<button class="btn-copy-small" @onclick="() => CopyVoucherCode(redeemed.voucher_code)" title="Copy voucher code">
																<i class="icon icon-check"></i>
															</button>
														}
													</div>
												}
												else
												{
													<span class="no-code">—</span>
												}
											</td>
											<td>@redeemed.redemption_date.ToString("MMM dd, yyyy")</td>
											<td>
												@if (redeemed.expiry_date.HasValue)
												{
													<span class="@(redeemed.IsExpired ? "expired-date" : "")">
														@redeemed.expiry_date.Value.ToString("MMM dd, yyyy")
													</span>
												}
												else
												{
													<span class="no-expiry">No expiry</span>
												}
											</td>
											<td>
												<span class="status-badge @statusClass">
													@if (redeemed.IsUsed)
													{
														<i class="icon icon-check"></i> <text>Used</text>
													}
													else if (redeemed.IsExpired)
													{
														<i class="icon icon-lock"></i> <text>Expired</text>
													}
													else
													{
														<i class="icon icon-gift"></i> <text>Active</text>
													}
												</span>
											</td>
											<td>
												@if (!redeemed.IsUsed && !redeemed.IsExpired)
												{
													<button class="btn-use" @onclick="async () => await ShowUseInstructions(redeemed)" title="How to use this reward">
														Use
													</button>
												}
												else
												{
													<span class="no-action">—</span>
												}
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
				</div>

				<!-- Recent Activity -->
				<div class="card activity-card">
					<div class="card-header">
						<i class="icon icon-calendar"></i>
						<h3>Recent points activity</h3>
						<a href="#" class="view-all-link">View all</a>
					</div>

					@if (recentTransactions.Count == 0)
					{
						<p class="empty-text">No recent activity.</p>
					}
					else
					{
						<div class="activity-list">
							@foreach (var transaction in recentTransactions)
							{
								<div class="activity-item">
									<div class="activity-icon @(transaction.transaction_type == "earn" ? "earn" : "redeem")">
										@(transaction.transaction_type == "earn" ? "+" : "-")
									</div>
									<div class="activity-info">
										<div class="activity-description">@transaction.description</div>
										<div class="activity-date">@transaction.transaction_date.ToString("MMM dd, yyyy")</div>
									</div>
									<div class="activity-points @(transaction.transaction_type == "earn" ? "positive" : "negative")">
										@(transaction.transaction_type == "earn" ? "+" : "-")@(transaction.points_earned > 0 ? transaction.points_earned : transaction.points_redeemed)
									</div>
								</div>
							}
						</div>
					}
				</div>
			</div>

			<!-- Tier Comparison Table -->
			<div class="card tiers-comparison-card">
				<div class="card-header">
					<i class="icon icon-gift"></i>
					<h3>All membership tiers</h3>
				</div>

				<div class="tiers-table-wrapper">
					<table class="tiers-table">
						<thead>
							<tr>
								<th>Tier</th>
								<th>Points Required</th>
								<th>Earning Rate</th>
								<th>Key Benefits</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var tier in LoyaltyTier.Tiers)
							{
								<tr class="@(tier.Name == currentTier.Name ? "current-tier" : "")">
									<td>
										<span class="tier-name-cell">
											<span style="font-size: 1.5rem; margin-right: 8px;">@tier.Icon</span>
											<strong>@tier.Name</strong>
											@if (tier.Name == currentTier.Name)
											{
												<span class="current-badge">Current</span>
											}
										</span>
									</td>
									<td>@tier.MinPoints @(tier.MaxPoints == int.MaxValue ? "+" : $"- {tier.MaxPoints}") pts</td>
									<td>
										@{
											var rate = tier.Name switch
											{
												"Bronze" => "10 pts/₱1",
												"Silver" => "12 pts/₱1",
												"Gold" => "15 pts/₱1",
												"Platinum" => "20 pts/₱1",
												_ => "10 pts/₱1"
											};
										}
										@rate
									</td>
									<td>
										<ul class="tier-benefits-mini">
											@foreach (var benefit in tier.Benefits.Take(2))
											{
												<li>@benefit</li>
											}
										</ul>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		}
	</div>
</div>

@code {
	[Parameter] public int clientId { get; set; }

	Hospitality.Models.User? user;
	Hospitality.Models.LoyaltyProgram? loyalty;
	LoyaltyTier currentTier = LoyaltyTier.Tiers[0];
	LoyaltyTier? nextTier;
	List<LoyaltyReward> availableRewards = new();
	List<LoyaltyTransaction> recentTransactions = new();
	List<RedeemedReward> redeemedRewards = new();
	bool loading = true;
	int actualClientId = 0;
	string? copiedMessage = null;
	string? useInstructions = null;

	protected override async Task OnParametersSetAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		loading = true;
		StateHasChanged();

		try
		{
			Console.WriteLine($"?? Loading loyalty data for user ID: {clientId}");

			// Load user data
			user = await UserService.GetUserByIdAsync(clientId);

			if (user == null)
			{
				Console.WriteLine("? UserService returned null!");
				loading = false;
				StateHasChanged();
				return;
			}

			Console.WriteLine($"? User loaded: {user.user_fname}");

			// Get actual client_id from user_id
			actualClientId = await GetClientIdFromUserIdAsync(clientId);
			Console.WriteLine($"? Client ID: {actualClientId}");

			// Load loyalty program
			loyalty = await LoyaltyService.GetLoyaltyProgramAsync(actualClientId);
			
			if (loyalty != null)
			{
				Console.WriteLine($"? Loyalty: {loyalty.total_points} points, {loyalty.current_tier} tier");
				currentTier = LoyaltyTier.GetTierByName(loyalty.current_tier);
				nextTier = LoyaltyTier.GetNextTier(loyalty.current_tier);
			}
			else
			{
				Console.WriteLine("?? No loyalty program found, using defaults");
				currentTier = LoyaltyTier.Tiers[0];
				nextTier = LoyaltyTier.GetNextTier("Bronze");
			}

			// Load available rewards
			availableRewards = await LoyaltyService.GetAvailableRewardsAsync();
			Console.WriteLine($"? Loaded {availableRewards.Count} rewards");

			// Load recent transactions
			recentTransactions = await LoyaltyService.GetTransactionHistoryAsync(actualClientId, 10);
			Console.WriteLine($"? Loaded {recentTransactions.Count} transactions");

			// Load redeemed rewards
			redeemedRewards = await LoyaltyService.GetRedeemedRewardsAsync(actualClientId);
			Console.WriteLine($"? Loaded {redeemedRewards.Count} redeemed rewards");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"? Error loading loyalty data: {ex.Message}");
		}
		finally
		{
			loading = false;
			StateHasChanged();
		}
	}

	private async Task<int> GetClientIdFromUserIdAsync(int userId)
	{
		try
		{
			using var con = Hospitality.Database.DbConnection.GetConnection();
			await con.OpenAsync();

			string sql = "SELECT client_id FROM Clients WHERE user_id = @userId";
			using var cmd = new Microsoft.Data.SqlClient.SqlCommand(sql, con);
			cmd.Parameters.AddWithValue("@userId", userId);
			var result = await cmd.ExecuteScalarAsync();

			if (result != null && result != DBNull.Value)
			{
				return Convert.ToInt32(result);
			}

			// Create client record if it doesn't exist
			string insertSql = "INSERT INTO Clients (user_id) VALUES (@userId); SELECT CAST(SCOPE_IDENTITY() AS INT);";
			using var insertCmd = new Microsoft.Data.SqlClient.SqlCommand(insertSql, con);
			insertCmd.Parameters.AddWithValue("@userId", userId);
			result = await insertCmd.ExecuteScalarAsync();

			return result != null ? Convert.ToInt32(result) : 0;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"? Error getting/creating client_id: {ex.Message}");
			return 0;
		}
	}

	int PointsToNextTier => nextTier != null && loyalty != null ? Math.Max(0, nextTier.MinPoints - loyalty.total_points) : 0;

	double GetCircleProgress()
	{
		if (loyalty == null || nextTier == null) return 0;
		if (nextTier.MinPoints == currentTier.MinPoints) return 440;
		var progress = (loyalty.total_points - currentTier.MinPoints) / (double)(nextTier.MinPoints - currentTier.MinPoints);
		return Math.Min(440, Math.Max(0, progress * 440));
	}

	double GetTierProgress()
	{
		if (loyalty == null || nextTier == null) return 0;
		if (nextTier.MinPoints == currentTier.MinPoints) return 100;
		var progress = (loyalty.total_points - currentTier.MinPoints) / (double)(nextTier.MinPoints - currentTier.MinPoints);
		return Math.Min(100, Math.Max(0, progress * 100));
	}

	string GetAverageNightlyRate()
	{
		if (loyalty == null || loyalty.lifetime_stays == 0) return "PHP 0";
		var avg = loyalty.lifetime_spend / loyalty.lifetime_stays;
		return $"PHP {avg:N0}";
	}

	async Task RedeemReward(int rewardId)
	{
		if (loyalty == null) return;

		try
		{
			bool success = await LoyaltyService.RedeemPointsAsync(actualClientId, rewardId);
			
			if (success)
			{
				// Reload loyalty data
				loyalty = await LoyaltyService.GetLoyaltyProgramAsync(actualClientId);
				recentTransactions = await LoyaltyService.GetTransactionHistoryAsync(actualClientId, 10);
				redeemedRewards = await LoyaltyService.GetRedeemedRewardsAsync(actualClientId);
				StateHasChanged();
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"? Error redeeming reward: {ex.Message}");
		}
	}

	private async Task CopyVoucherCode(string voucherCode)
	{
		try
		{
			// Copy to clipboard using MAUI Clipboard API
			await Clipboard.SetTextAsync(voucherCode);
			
			copiedMessage = $"Voucher code '{voucherCode}' copied!";
			StateHasChanged();
			
			// Clear message after 3 seconds
			await Task.Delay(3000);
			copiedMessage = null;
			StateHasChanged();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error copying voucher code: {ex.Message}");
			copiedMessage = "Failed to copy. Please copy manually: " + voucherCode;
			StateHasChanged();
			
			await Task.Delay(5000);
			copiedMessage = null;
			StateHasChanged();
		}
	}

	private async Task ShowUseInstructions(RedeemedReward redeemed)
	{
		var instructions = redeemed.reward_type?.ToLower() switch
		{
			"voucher" => $"To use this voucher: 1) Copy the voucher code '{redeemed.voucher_code}', 2) Go to Book a Room, 3) Enter the code when prompted, or 4) Present it at check-in.",
			"service" => $"To use this service: Present your voucher code '{redeemed.voucher_code}' at the front desk during check-in.",
			"upgrade" => $"To use this upgrade: Present your voucher code '{redeemed.voucher_code}' at the front desk during check-in. Subject to availability.",
			_ => $"Present your voucher code '{redeemed.voucher_code}' at the front desk during check-in."
		};
		
		useInstructions = instructions;
		StateHasChanged();
		
		// Clear message after 5 seconds
		await Task.Delay(5000);
		useInstructions = null;
		StateHasChanged();
	}
}
