@page "/client/messages/{clientId:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.MessageService MessageService
@inject Hospitality.Services.UserService UserService

<link rel="stylesheet" href="css/client-messages.css" />

<div class="messages-page">
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
       <div class="brand">
             <img src="images/InnSight.png" alt="InnSight" style="height: 32px; width: auto; margin-right: 8px;" />
       <span class="brand-name">InnSight</span>
     <span class="brand-sub">Guest Portal</span>
        </div>
  </div>
   <div class="nav-center">
            <a href="/client/profile/@clientId" class="nav-link">Dashboard</a>
   <a href="#" class="nav-link">Stays</a>
            <a href="/client/loyalty/@clientId" class="nav-link">Loyalty</a>
      <a href="/client/messages/@clientId" class="nav-link active">Messages</a>
        </div>
        <div class="nav-right">
     <span class="points-badge">Gold • @LoyaltyPoints pts</span>
            <div class="user-menu">
     <div class="user-avatar-small">@GetInitials()</div>
            </div>
        </div>
    </nav>

    <div class="messages-container">
        <!-- Left Sidebar - Inbox List -->
        <div class="messages-left">
            <div class="inbox-header">
             <h2 class="inbox-title">Messages & notifications</h2>
   <p class="inbox-subtitle">Review updates about your stays, offers, and account activity, or email the hotel team.</p>
   </div>

     <!-- Filter Tabs -->
    <div class="filter-tabs">
         <button class="filter-tab @(currentFilter == "All" ? "active" : "")" 
              @onclick='() => SetFilter("All")'>
     All
    </button>
         <button class="filter-tab @(currentFilter == "Unread" ? "active" : "")" 
      @onclick='() => SetFilter("Unread")'>
         Unread (@unreadCount)
   </button>
      <button class="filter-tab @(currentFilter == "Stays" ? "active" : "")" 
@onclick='() => SetFilter("Stays")'>
Stays
         </button>
        <button class="filter-tab @(currentFilter == "Offers" ? "active" : "")" 
      @onclick='() => SetFilter("Offers")'>
      Offers
      </button>
 </div>

            <!-- Time Range Filter -->
        <div class="time-filter">
         <span class="time-label">Showing messages from the last 90 days</span>
   </div>

        <!-- Messages List -->
     <div class="inbox-list">
    @if (loading)
     {
        <div class="loading-state">
   <div class="spinner"></div>
    <p>Loading messages...</p>
         </div>
      }
       else if (!messages.Any())
                {
   <div class="empty-state">
                  <div class="empty-icon">??</div>
         <h3>No messages</h3>
       <p>You don't have any messages matching this filter.</p>
           </div>
                }
         else
    {
         @foreach (var message in messages)
       {
    <div class="inbox-item @(message.is_read ? "read" : "unread") @(selectedMessage?.message_id == message.message_id ? "selected" : "")"
          @onclick="() => SelectMessage(message)">
           <div class="inbox-item-header">
       <div class="inbox-item-category">
   <span class="category-icon">@GetCategoryIcon(message.message_category)</span>
               <span class="category-name">@message.message_category</span>
       </div>
           <span class="inbox-item-date">@FormatDate(message.sent_date)</span>
          </div>
<h4 class="inbox-item-title">@message.message_subject</h4>
   <p class="inbox-item-preview">@GetPreview(message.message_body)</p>
            @if (!message.is_read)
             {
    <span class="unread-dot"></span>
          }
   </div>
            }
          }
         </div>
      </div>

    <!-- Right Panel - Message Detail -->
        <div class="messages-right">
     @if (selectedMessage == null && !showEmailForm)
       {
  <div class="no-selection">
    <div class="no-selection-icon">??</div>
          <h3>Select a message</h3>
      <p>Choose a message from the list to view its contents</p>
               <button class="btn-primary" @onclick="ShowEmailForm">
             <span class="btn-icon">??</span> Email the hotel team
     </button>
          </div>
       }
   else if (showEmailForm)
            {
             <!-- Email Hotel Team Form -->
        <div class="email-form">
         <div class="email-header">
           <button class="back-btn" @onclick="HideEmailForm">
  ? Back
       </button>
    <h3>Email the hotel team</h3>
           </div>

            <div class="email-content">
       <p class="email-intro">Send a message to the hotel team about reservations, billing, or loyalty support. We'll reply to your email address on file.</p>

            <div class="form-group">
             <label class="field-label">To</label>
     <div class="input-readonly">
  <span>Front desk (Harbourkey Waterfront)</span>
      </div>
            </div>

       <div class="form-group">
      <label class="field-label">Regarding</label>
     <select @bind="emailRegarding" class="form-select">
        <option value="Upcoming stay, billing, or general question">Upcoming stay, billing, or general question</option>
    <option value="Current reservation">Current reservation</option>
  <option value="Past stay inquiry">Past stay inquiry</option>
            <option value="Billing question">Billing question</option>
         <option value="Loyalty program">Loyalty program</option>
       </select>
    </div>

            <div class="form-group">
    <label class="field-label">Subject</label>
<input type="text" @bind="emailSubject" 
       class="form-input" 
   placeholder="Write a short subject for your email" />
  </div>

  <div class="form-group">
       <label class="field-label">Message</label>
      <textarea @bind="emailMessage" 
       class="form-textarea" 
                 rows="10"
      placeholder="Share the details of your request (e.g. early check-in, room preference, invoice request)..."></textarea>
    </div>

  <div class="email-footer">
   <p class="email-note">Your message will be sent as an email to the selected hotel team. Replies will be sent to your email address on file.</p>
<div class="email-actions">
       <button class="btn-secondary" @onclick="SaveDraft">
             Save draft
   </button>
           <button class="btn-primary" @onclick="SendEmail" disabled="@(!IsEmailValid())">
   <span class="btn-icon">??</span> Send email to hotel
        </button>
 </div>
          </div>
        </div>
       </div>
         }
    else if (selectedMessage != null)
    {
         <!-- Message Detail View -->
    <div class="message-detail">
        <div class="message-header">
     <button class="back-btn mobile-only" @onclick="() => selectedMessage = null">
  ? Back
          </button>
       <div class="message-category-badge">
      <span class="category-icon">@GetCategoryIcon(selectedMessage.message_category)</span>
        <span>@selectedMessage.message_category</span>
           </div>
            <div class="message-actions">
   <button class="action-btn" @onclick="() => MarkAsRead(selectedMessage.message_id)" 
         title="@(selectedMessage.is_read ? "Mark as unread" : "Mark as read")">
         @(selectedMessage.is_read ? "??" : "??")
 </button>
   <button class="action-btn" @onclick="ShowEmailForm" title="Reply">
       ??
    </button>
                 <button class="action-btn" title="More">
   ?
           </button>
     </div>
          </div>

     <div class="message-content">
          <h2 class="message-title">@selectedMessage.message_subject</h2>
     <div class="message-meta">
<span class="message-date">@FormatDate(selectedMessage.sent_date)</span>
@if (!string.IsNullOrEmpty(selectedMessage.regarding_text))
          {
       <span class="message-regarding">• @selectedMessage.regarding_text</span>
           }
               </div>

       <div class="message-body">
           <p>Hi @(user?.user_fname ?? "Guest"),</p>
    @foreach (var paragraph in (selectedMessage.message_body ?? "").Split(new[] { "\n\n", "\r\n\r\n" }, StringSplitOptions.RemoveEmptyEntries))
     {
           <p>@paragraph</p>
         }
            </div>

     @if (!string.IsNullOrEmpty(selectedMessage.action_label) && !string.IsNullOrEmpty(selectedMessage.action_url))
    {
  <div class="message-cta">
     <button class="btn-primary" @onclick="@(() => NavigateTo(selectedMessage.action_url))">
           <span class="btn-icon">??</span> @selectedMessage.action_label
    </button>
    <button class="btn-secondary" @onclick="ShowEmailForm">
<span class="btn-icon">??</span> Reply via email
  </button>
       </div>
        }

    @if (selectedMessage.message_type == "offer")
    {
      <div class="offer-details">
         <h4>Offer details</h4>
       <ul class="offer-list">
      <li>Valid for Saturday–Sunday check-ins only</li>
       <li>Minimum stay: 2 nights</li>
      <li>Higher room types: Standard, Deluxe, and Suite categories</li>
     <li>Subject to availability and blackout dates may apply</li>
   </ul>
  </div>
       }

    @if (!string.IsNullOrEmpty(selectedMessage.regarding_text))
       {
             <div class="message-footer-note">
          <p><strong>Need to use this offer</strong></p>
      <p>When you book your next stay from your dashboard, this offer will be automatically applied to eligible dates. You can also mention this offer if you contact our reservations team.</p>
          </div>
          }
    </div>
          </div>
            }
        </div>
    </div>
</div>

@code {
 [Parameter] public int clientId { get; set; }

    Hospitality.Models.User? user;
  List<Hospitality.Models.Message> messages = new();
    Hospitality.Models.Message? selectedMessage;
    
    bool loading = true;
    int unreadCount = 0;
    int LoyaltyPoints = 12450;
    string currentFilter = "All";
    
    // Email form state
    bool showEmailForm = false;
  string emailRegarding = "Upcoming stay, billing, or general question";
    string emailSubject = "";
    string emailMessage = "";

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        try
    {
            user = await UserService.GetUserByIdAsync(clientId);
            await LoadMessages();
         unreadCount = await MessageService.GetUnreadCountAsync(clientId);
        }
     catch (Exception ex)
        {
            Console.WriteLine($"Error loading messages: {ex.Message}");
     }
    finally
    {
    loading = false;
        }
    }

    async Task LoadMessages()
    {
        var filter = new Hospitality.Models.MessageFilter
      {
        FilterType = currentFilter,
            TimeRange = "Last 90 days"
  };
        messages = await MessageService.GetClientMessagesAsync(clientId, filter);
    }

    async Task SetFilter(string filter)
    {
        currentFilter = filter;
     await LoadMessages();
    }

 async Task SelectMessage(Hospitality.Models.Message message)
    {
        selectedMessage = message;
        showEmailForm = false;
        
        if (!message.is_read)
        {
      await MessageService.MarkAsReadAsync(message.message_id);
            message.is_read = true;
       unreadCount = Math.Max(0, unreadCount - 1);
StateHasChanged();
        }
    }

    void ShowEmailForm()
    {
        showEmailForm = true;
        selectedMessage = null;
        emailSubject = "";
        emailMessage = "";
    }

    void HideEmailForm()
    {
        showEmailForm = false;
    }

    async Task SendEmail()
    {
   try
        {
  var request = new Hospitality.Models.EmailRequest
    {
       client_id = clientId,
      regarding = emailRegarding,
       subject = emailSubject,
                message_body = emailMessage,
    email_to = "frontdesk@innsight.com"
 };

   await MessageService.SendEmailToHotelAsync(request);
       
            // Show success message
     Console.WriteLine("Email sent successfully!");
    
          // Reset form
     HideEmailForm();
   await LoadMessages();
        }
        catch (Exception ex)
      {
          Console.WriteLine($"Error sending email: {ex.Message}");
   }
    }

    void SaveDraft()
    {
        Console.WriteLine("Draft saved locally");
    }

    bool IsEmailValid()
    {
     return !string.IsNullOrWhiteSpace(emailSubject) && !string.IsNullOrWhiteSpace(emailMessage);
    }

    async Task MarkAsRead(int messageId)
    {
      var message = messages.FirstOrDefault(m => m.message_id == messageId);
   if (message != null)
        {
            message.is_read = !message.is_read;
            await MessageService.MarkAsReadAsync(messageId);
     unreadCount = await MessageService.GetUnreadCountAsync(clientId);
         StateHasChanged();
        }
    }

    void NavigateTo(string? url)
    {
        if (!string.IsNullOrEmpty(url))
        {
      Navigation.NavigateTo(url);
      }
    }

    string GetInitials()
    {
        if (user == null) return "G";
      var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(user.user_fname)) parts.Add(user.user_fname.Substring(0, 1));
if (user.user_lname != null && user.user_lname.Length > 0)
        {
      try
     {
        var ln = user.user_lname ?? "";
    if (!string.IsNullOrWhiteSpace(ln)) parts.Add(ln.Substring(0, 1));
       }
        catch { }
        }
     return string.Join("", parts).ToUpperInvariant();
    }

    string GetCategoryIcon(string? category)
    {
        return category switch
        {
       "Member Services" => "??",
  "Billing & Receipts" => "??",
        "Harbourkey Waterfront" => "??",
            "Membership Rewards" => "?",
     "Email Sent" => "??",
       _ => "??"
        };
    }

    string FormatDate(DateTime date)
    {
        var timeSpan = DateTime.Now - date;

if (timeSpan.TotalMinutes < 60)
return $"{(int)timeSpan.TotalMinutes}m ago";
     else if (timeSpan.TotalHours < 24)
return $"{(int)timeSpan.TotalHours}h ago";
        else if (timeSpan.TotalDays < 7)
   return date.ToString("ddd");
        else if (timeSpan.TotalDays < 365)
       return date.ToString("MMM dd");
        else
            return date.ToString("MMM dd, yyyy");
    }

    string GetPreview(string? body)
    {
        if (string.IsNullOrEmpty(body)) return "";
   var preview = body.Replace("\r\n", " ").Replace("\n", " ");
        return preview.Length > 80 ? preview.Substring(0, 80) + "..." : preview;
    }
}
