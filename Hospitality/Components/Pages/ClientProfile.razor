@page "/client/profile/{id:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.UserService UserService
@inject Hospitality.Services.BookingService BookingService
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="css/clientprofile.css" />

<div class="client-profile-page">
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-left">
            <div class="brand">
                <img src="images/InnSight.png" alt="InnSight" style="height: 32px; width: auto; margin-right: 8px;" />
                <span class="brand-name">InnSight</span>
                <span class="brand-sub">Guest Portal</span>
            </div>
        </div>
        <div class="nav-center">
        <a href="/client/profile/@id" class="nav-link active">Dashboard</a>
   <a href="#" class="nav-link">Stays</a>
            <a href="/client/loyalty/@id" class="nav-link">Loyalty</a>
<a href="/client/messages/@id" class="nav-link">Messages</a>
      </div>
        <div class="nav-right">
            <span class="points-badge">Gold • @LoyaltyPoints pts</span>
            <div class="user-menu">
                <div class="user-avatar-small" @onclick="ToggleDropdown">@GetInitials()</div>
                @if (isDropdownOpen)
                {
                    <div class="user-dropdown">
                        <button class="dropdown-item" title="Logout" @onclick="Logout">Logout</button>
                    </div>
                }
            </div>
        </div>
    </nav>

    <div class="profile-container">
        @if (loading)
        {
            <div class="loading-container">
                <p>Loading client profile...</p>
                <p><small>User ID: @id</small></p>
            </div>
        }
        else if (!loading && user == null)
        {
            <div class="error-container">
                <h3>User not found</h3>
                <p>Could not find user with ID: @id</p>
                <p>Check your database or service method.</p>
            </div>
        }
        else if (user != null)
        {
            <!-- Welcome Header -->
            <header class="welcome-header">
                <div class="welcome-content">
                    <h1 class="welcome-title">Welcome back, @(user.user_fname ?? "Guest")</h1>
                    <p class="welcome-subtitle">Here is your stay summary and upcoming plans.</p>
                </div>
                <div class="user-avatar-large">
                    <span>@GetInitials()</span>
                    <span class="avatar-label">Loyalty member</span>
                </div>
            </header>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="BookRoom">
                    <span class="btn-icon">🏨</span> Book a Room
                </button>

                <button class="btn btn-secondary" @onclick="ViewReceipts">
                    <span class="btn-icon">📄</span> View Receipts
                </button>
                <button class="btn btn-secondary" @onclick="EditProfile">
                    <span class="btn-icon">✏️</span> Edit Profile
                </button>
            </div>

            <!-- Main Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Upcoming Booking Card -->
                <div class="card upcoming-card">
                    <div class="card-icon-header">
                        <span class="icon">📅</span>
                        <h3>Upcoming Booking</h3>
                    </div>
                    @if (currentBooking == null)
                    {
                        <p class="empty-text">No upcoming booking.</p>
                    }
                    else
                    {
                        <div class="booking-content">
                            <div class="booking-info-left">
                                <h4 class="room-title">@(currentBooking.room_name ?? "Room")</h4>
                                <p class="booking-dates">Check-in @currentBooking.check_in_date.ToString("ddd, MMM dd") • Check-out @currentBooking.check_out_date.ToString("ddd, MMM dd")</p>
                                <p class="booking-meta">Guests: @currentBooking.person_count adult@(currentBooking.person_count != 1 ? "s" : "") • @GetNights(currentBooking) night@(GetNights(currentBooking) != 1 ? "s" : "")</p>
                                <p class="booking-id-text">@GetDaysUntilCheckIn(currentBooking) • Booking ID #@currentBooking.booking_id</p>
                                <a href="#" class="view-link">View details</a>
                            </div>
                            <div class="booking-map-placeholder">
                                <div class="map-icon">🗺️</div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Total Stays Card -->
                <div class="card stays-card">
                    <div class="card-header-split">
                        <div class="card-icon-header">
                            <span class="icon">🏨</span>
                            <h3>Total Stays</h3>
                        </div>
                        <span class="time-label">Last 12 months</span>
                    </div>
                    <div class="stays-content">
                        <div class="stays-number">@TotalStays</div>
                        <p class="stays-label">Completed bookings</p>
                        <p class="stays-avg">
                            Average @(AverageNights > 0 ? AverageNights.ToString("0.1") : "—") nights / stay
                        </p>
                        <div class="month-pills">
                            @foreach (var month in new[] { "Jan", "Mar", "May", "Jul", "Sep", "Nov" })
                            {
                                <div class="month-pill" style="background: @GetMonthColor(month)">
                                    <span class="month-label">@month</span>
                                </div>
                            }
                            <span class="peak-label">Peak in May</span>
                        </div>
                    </div>
                </div>

                <!-- Loyalty & Rewards Card -->
                <div class="card loyalty-card">
                    <div class="card-header-split">
                        <div class="card-icon-header">
                            <span class="icon">⭐</span>
                            <h3>Loyalty & Rewards</h3>
                        </div>
                        <span class="member-since">Member since 2019</span>
                    </div>
                    <div class="loyalty-content">
                        <div class="points-circle-wrapper">
                            <svg class="points-circle" viewBox="0 0 120 120">
                                <circle cx="60" cy="60" r="54" fill="none" stroke="#e8e8ea" stroke-width="10" />
                                <circle cx="60" cy="60" r="54" fill="none" stroke="url(#gradient)" stroke-width="10"
                                        stroke-dasharray="@GetCircleProgress() 340" stroke-dashoffset="0"
                                        transform="rotate(-90 60 60)" stroke-linecap="round" />
                                <defs>
                                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#667eea" />
                                        <stop offset="100%" stop-color="#764ba2" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="points-center">
                                <div class="points-number">@LoyaltyPoints</div>
                                <div class="points-label">points</div>
                            </div>
                        </div>
                        <div class="loyalty-details">
                            <span class="gold-badge">🥇 Gold member</span>
                            <p class="loyalty-perks">Enjoy late checkout, room upgrades (when available), and welcome drinks.</p>
                            <p class="next-tier-label">Next tier: Platinum</p>
                            <p class="points-to-next">@PointsToNextTier points to reach Platinum</p>
                        </div>
                    </div>
                </div>

                <!-- Messages & Notifications Card -->
                <div class="card messages-card" style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo($"/client/messages/{id}"))">
                    <div class="card-header-split">
                        <div class="card-icon-header">
                            <span class="icon">📬</span>
                            <h3>Messages</h3>
                        </div>
                        <span class="unread-badge">3 unread</span>
                    </div>
                    <ul class="messages-list">
                        <li class="message-item">
                            <div class="message-row">
                                <span class="message-title">Exclusive Gold member offer</span>
                                <span class="message-time">2 days ago</span>
                            </div>
                            <p class="message-body">Save 8% on weekend stays with bonus loyalty points...</p>
                        </li>
                        <li class="message-item">
                            <div class="message-row">
                                <span class="message-title">Booking confirmation</span>
                                <span class="message-time">Yesterday</span>
                            </div>
                            <p class="message-body">Your stay at Harbourkey Waterfront is confirmed...</p>
                        </li>
                    </ul>
                    <a href="/client/messages/@id" class="view-link" @onclick:stopPropagation="true">View all messages →</a>
                </div>
            </div>

            <!-- Recent Booking History -->
            <div class="card history-card">
                <div class="card-header-split">
                    <div>
                        <h3>Recent Booking History</h3>
                        <p class="card-subtitle">Overview of your latest stays and their status.</p>
                    </div>
                    <a href="#" class="view-all-link">View all bookings</a>
                </div>
                @if (bookingHistory == null || bookingHistory.Count == 0)
                {
                    <p class="empty-text">No booking history available.</p>
                }
                else
                {
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Room type</th>
                                <th>Duration & Guests</th>
                                <th>Status</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in bookingHistory.Take(5))
                            {
                                <tr>
                                    <td>#@booking.booking_id.ToString("H0000000")</td>
                                    <td>@(booking.room_name ?? "Unknown Room")</td>
                                    <td>
                                        @GetNights(booking) night@(GetNights(booking) != 1 ? "s" : "") • @booking.person_count guest@(booking.person_count != 1 ? "s" : "")<br />
                                        <small>@booking.check_in_date.ToString("MMM dd")–@booking.check_out_date.ToString("MMM dd")</small>
                                    </td>
                                    <td><span class="status-badge status-@(GetStatusBadge(booking.booking_status ?? "pending"))">@(booking.booking_status ?? "Pending")</span></td>
                                    <td>@(booking.room_price?.ToString("C") ?? "—")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public int id { get; set; }

    Hospitality.Models.User? user;
    Hospitality.Models.Booking? currentBooking;
    List<Hospitality.Models.Booking> bookingHistory = new();
    bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        StateHasChanged();

        try
        {
            Console.WriteLine($"🔧 Loading client profile for user ID: {id}");

            user = await UserService.GetUserByIdAsync(id);

            if (user == null)
            {
                Console.WriteLine("❌ UserService returned null!");
            }
            else
            {
                Console.WriteLine($"✅ User loaded: {user.user_fname}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception: {ex.Message}");
        }
        finally
        {
            loading = false;
            StateHasChanged();
            Console.WriteLine("✅ Finished loading");
        }
    }


    void BookRoom() => Navigation.NavigateTo($"/booking/new/{id}");
    void ViewReceipts() { Console.WriteLine("📄 View Receipts clicked"); }
    void EditProfile() { Console.WriteLine("✏️ Edit Profile clicked"); }

    string GetInitials()
    {
        if (user == null) return "G";
        var initials = new[] { user.user_fname, user.user_mname, user.user_lname }
            .Where(s => !string.IsNullOrWhiteSpace(s))
            .Select(s => s[0].ToString().ToUpper());
        return string.Join("", initials);
    }

    string GetStatusBadge(string status) => status?.ToLowerInvariant() switch
    {
        "confirmed" => "confirmed",
        "active" or "checked-in" => "active",
        "completed" => "completed",
        "cancelled" => "cancelled",
        _ => "pending"
    };

    string GetMonthColor(string month) => month switch
    {
        "May" => "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
        _ => "#d8d8dc"
    };

    int GetNights(Hospitality.Models.Booking booking) => Math.Max(1, (int)(booking.check_out_date - booking.check_in_date).TotalDays);

    string GetDaysUntilCheckIn(Hospitality.Models.Booking booking)
    {
        var daysUntil = (int)(booking.check_in_date - DateTime.Today).TotalDays;
        return daysUntil > 0 ? $"Check-in in {daysUntil} day{(daysUntil != 1 ? "s" : "")}"
             : daysUntil == 0 ? "Check-in today"
             : "Currently staying";
    }

    int TotalStays => bookingHistory?.Count(b => string.Equals(b.booking_status, "completed", StringComparison.OrdinalIgnoreCase)) ?? 0;

    double AverageNights
    {
        get
        {
            var completedBookings = bookingHistory?
                .Where(b => string.Equals(b.booking_status, "completed", StringComparison.OrdinalIgnoreCase))
                .ToList();
            return completedBookings?.Any() == true ? completedBookings.Average(GetNights) : 0;
        }
    }

    int LoyaltyPoints => bookingHistory?
        .Where(b => string.Equals(b.booking_status, "completed", StringComparison.OrdinalIgnoreCase))
        .Sum(b => GetNights(b) * 100) ?? 0;

    int PointsToNextTier => Math.Max(0, 5000 - LoyaltyPoints);

    double GetCircleProgress() => LoyaltyPoints > 0 ? Math.Min(340, (LoyaltyPoints / 5000.0) * 340) : 0;


    private bool isDropdownOpen = false;

    private void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
    }

    void Logout() => Navigation.NavigateTo("/");
}
