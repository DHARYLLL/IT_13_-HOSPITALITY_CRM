@page "/client/profile/{id:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.UserService UserService
@inject Hospitality.Services.BookingService BookingService

<link rel="stylesheet" href="css/clientprofile.css" />

<div class="client-profile-page">
	<div class="profile-container">
		<header class="profile-header">
			<div class="header-top">
				<div class="welcome-section">
					<h1 class="welcome-title">Welcome back, @(user?.user_fname ?? "Guest")</h1>
					<p class="welcome-subtitle">Here is your stay summary and upcoming plans.</p>
				</div>
				<div class="user-badge">
					<span class="user-name">@(user?.user_fname ?? "Guest") @Decode(user?.user_lname)</span>
					<span class="user-label">Loyalty member</span>
					<div class="user-avatar">@GetInitials()</div>
				</div>
			</div>
			<div class="header-actions">
				<a href="/booking/new/@id" class="btn btn-primary">
					<span class="btn-icon">??</span> Book a Room
				</a>
				<button class="btn btn-secondary" disabled>
					<span class="btn-icon">??</span> View Receipts
				</button>
				<button class="btn btn-secondary" disabled>
					<span class="btn-icon">??</span> Edit Profile
				</button>
			</div>
		</header>

		@if (loading)
		{
			<div class="loading-container">
				<p>Loading...</p>
			</div>
		}
		else if (user == null)
		{
			<div class="error-container">
				<p>User not found.</p>
			</div>
		}
		else
		{
			<div class="dashboard-grid">
				<!-- Upcoming Booking -->
				<div class="card upcoming-booking-card">
					<div class="card-header">
						<span class="card-icon">??</span>
						<h2>Upcoming Booking</h2>
					</div>
					<div class="card-body">
						@if (currentBooking == null)
						{
							<p class="empty-text">No upcoming booking.</p>
						}
						else
						{
							<div class="booking-details">
								<h3 class="booking-title">@currentBooking.room_name</h3>
								<p class="booking-dates">Check-in: @currentBooking.check_in_date.ToString("MMM dd") · Check-out: @currentBooking.check_out_date.ToString("MMM dd, yyyy")</p>
								<p class="booking-guests">Guests: @currentBooking.guest_count adults · Flexible cancellation</p>
								<p class="booking-info">Booking ID #@currentBooking.booking_id.ToString("D6")</p>
								<button class="link-btn" disabled>View details</button>
							</div>
							<div class="booking-map">
								<div class="map-placeholder">[Map]</div>
							</div>
						}
					</div>
				</div>

				<!-- Total Stays -->
				<div class="card total-stays-card">
					<div class="card-header-inline">
						<div>
							<span class="card-icon">??</span>
							<h2>Total Stays</h2>
						</div>
						<span class="time-range">Last 12 months</span>
					</div>
					<div class="card-body">
						<div class="stays-number">@TotalStays</div>
						<p class="stays-label">Completed bookings</p>
						<p class="stays-avg">Average @AverageNights.ToString("0.0") nights / stay</p>
						<div class="months-chart">
							@foreach (var m in GetMonthData())
							{
								<div class="month-bar" style="height: @(m.Height)%" title="@m.Label">
									<span class="month-label">@m.Label</span>
								</div>
							}
							<span class="chart-label">Peak in May</span>
						</div>
					</div>
				</div>

				<!-- Loyalty & Rewards -->
				<div class="card loyalty-card">
					<div class="card-header-inline">
						<div>
							<span class="card-icon">?</span>
							<h2>Loyalty & Rewards</h2>
						</div>
						<span class="member-badge">Member since 2019</span>
					</div>
					<div class="card-body">
						<div class="loyalty-content">
							<div class="points-circle">
								<svg viewBox="0 0 100 100">
									<circle cx="50" cy="50" r="45" fill="none" stroke="#e0e0e0" stroke-width="8"/>
									<circle cx="50" cy="50" r="45" fill="none" stroke="#6366f1" stroke-width="8"
									        stroke-dasharray="@GetPointsProgress() 283" stroke-dashoffset="0" 
									        transform="rotate(-90 50 50)"/>
								</svg>
								<div class="points-value">
									<strong>@LoyaltyPoints</strong>
									<span>points</span>
								</div>
							</div>
							<div class="loyalty-info">
								<span class="member-tier">?? Gold member</span>
								<p>Enjoy late checkout, room upgrades (when available), and welcome drinks.</p>
								<p class="next-tier">Next tier: Platinum</p>
								<p class="points-needed">@PointsToNextTier points to reach Platinum</p>
							</div>
						</div>
					</div>
				</div>

				<!-- Messages & Notifications -->
				<div class="card messages-card">
					<div class="card-header-inline">
						<div>
							<span class="card-icon">??</span>
							<h2>Messages & Notifications</h2>
						</div>
						<span class="unread-count">3 unread</span>
					</div>
					<div class="card-body">
						<ul class="messages-list">
							<li class="message-item">
								<div class="message-header">
									<strong>Early check-in request approved</strong>
									<span class="message-time">2h ago</span>
								</div>
								<p class="message-text">You can now check in from 12:00 PM for your upcoming stay on Jul 22.</p>
							</li>
							<li class="message-item">
								<div class="message-header">
									<strong>Exclusive Gold member offer</strong>
									<span class="message-time">Yesterday</span>
								</div>
								<p class="message-text">Save 15% on weekend stays in August at participating properties.</p>
							</li>
							<li class="message-item">
								<div class="message-header">
									<strong>Receipt available for your stay</strong>
									<span class="message-time">Jun 29</span>
								</div>
								<p class="message-text">Your receipt for booking #H0478392 is now ready to download.</p>
							</li>
						</ul>
					</div>
				</div>
			</div>

			<!-- Recent Booking History -->
			<div class="card history-card">
				<div class="card-header-inline">
					<div>
						<h2>Recent Booking History</h2>
						<p class="card-subtitle">Overview of your latest stays and their status.</p>
					</div>
					<a href="#" class="link-btn">View all bookings</a>
				</div>
				<div class="card-body">
					@if (bookingHistory == null || bookingHistory.Count == 0)
					{
						<p class="empty-text">No booking history available.</p>
					}
					else
					{
						<table class="bookings-table">
							<thead>
								<tr>
									<th>Booking ID</th>
									<th>Room type</th>
									<th>Duration</th>
									<th>Status</th>
									<th>Price</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var booking in bookingHistory.Take(5))
								{
									var nights = (int)(booking.check_out_date - booking.check_in_date).TotalDays;
									<tr>
										<td>@booking.booking_id.ToString("#\\H\\0000000")</td>
										<td>@booking.room_name</td>
										<td>@nights night@(nights != 1 ? "s" : "") · @booking.check_in_date.ToString("MMM dd")–@booking.check_out_date.ToString("dd")</td>
										<td><span class="status-badge status-@booking.booking_status.ToLower()">? @booking.booking_status</span></td>
										<td>@(booking.room_price?.ToString("C") ?? "—")</td>
									</tr>
								}
							</tbody>
						</table>
					}
				</div>
			</div>
		}
	</div>
</div>

@code {
	[Parameter] public int id { get; set; }

	Hospitality.Models.User? user;
	Hospitality.Models.Booking? currentBooking;
	List<Hospitality.Models.Booking> bookingHistory = new();
	bool loading = true;

	protected override async Task OnInitializedAsync()
	{
		loading = true;
		try
		{
			user = await UserService.GetUserByIdAsync(id);
			if (user != null)
			{
				currentBooking = await BookingService.GetCurrentBookingByUserIdAsync(id);
				bookingHistory = await BookingService.GetBookingsByUserIdAsync(id);
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading client profile: {ex.Message}");
		}
		finally
		{
			loading = false;
		}
	}

	string Decode(byte[]? data)
	{
		if (data == null || data.Length == 0) return string.Empty;
		try { return System.Text.Encoding.UTF8.GetString(data); }
		catch { return string.Empty; }
	}

	string GetInitials()
	{
		if (user == null) return "G";
		var parts = new List<string>();
		if (!string.IsNullOrWhiteSpace(user.user_fname)) parts.Add(user.user_fname.Substring(0, 1));
		if (user.user_lname != null && user.user_lname.Length > 0)
		{
			try
			{
				var ln = Decode(user.user_lname);
				if (!string.IsNullOrWhiteSpace(ln)) parts.Add(ln.Substring(0, 1));
			}
			catch { }
		}
		return string.Join("", parts).ToUpperInvariant();
	}

	string GetStatusClass(string status)
	{
		return status?.ToLowerInvariant() switch
		{
			"confirmed" => "status-confirmed",
			"active" or "checked-in" => "status-active",
			"completed" => "status-completed",
			"cancelled" => "status-cancelled",
			_ => "status-pending"
		};
	}

	int TotalStays => bookingHistory.Count(b => string.Equals(b.booking_status, "completed", StringComparison.OrdinalIgnoreCase));
	double AverageNights => bookingHistory.Count == 0 ? 0 : bookingHistory.Average(b => (b.check_out_date - b.check_in_date).TotalDays);
	int LoyaltyPoints => (int)bookingHistory.Sum(b => (b.check_out_date - b.check_in_date).TotalDays * 100);
	int PointsToNextTier => Math.Max(0, 5000 - LoyaltyPoints);
	double GetPointsProgress() => LoyaltyPoints > 0 ? (LoyaltyPoints / 5000.0) * 283 : 0;

	record MonthData(string Label, int Height);
	List<MonthData> GetMonthData()
	{
		var months = new[] { "Jan", "Mar", "May", "Jul", "Sep", "Nov" };
		var data = new List<MonthData>();
		for (int i = 0; i < 6; i++)
		{
			int count = bookingHistory.Count(b => b.check_in_date.Month == DateTime.Now.AddMonths(-5 + i).Month);
			int height = Math.Min(100, count * 20 + 40);
			data.Add(new MonthData(months[i], height));
		}
		return data;
	}
}