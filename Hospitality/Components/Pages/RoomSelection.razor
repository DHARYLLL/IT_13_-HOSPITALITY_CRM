@page "/booking/rooms"
@page "/booking/rooms/{clientId:int}"
@page "/booking/rooms/{clientId:int}/{adults:int}/{rooms:int}/{checkIn}/{checkOut}"
@inject NavigationManager Navigation
@inject Hospitality.Services.RoomService RoomService
@inject Hospitality.Services.BookingService BookingService
@inject Hospitality.Services.PaymentService PaymentService
@inject Hospitality.Services.LoyaltyService LoyaltyService
@inject Hospitality.Services.UserService UserService

<link rel="stylesheet" href="css/roomselection.css" />

<div class="room-selection-page">
	<!-- Top Navigation -->
	<nav class="top-nav">
		<div class="nav-left">
			<div class="brand">
				<img src="images/InnSight.png" alt="InnSight" style="height: 32px; width: auto; margin-right: 8px;" />
				<span class="brand-name">InnSight</span>
				<span class="brand-sub">Guest Portal</span>
			</div>
		</div>
		<div class="nav-center">
			<a href="@GetDashboardLink()" class="nav-link">Dashboard</a>
			<a href="@(clientId.HasValue ? $"/client/stays/{clientId.Value}" : "/")" class="nav-link">Stays</a>
			<a href="@(clientId.HasValue ? $"/client/loyalty/{clientId.Value}" : "/")" class="nav-link">Loyalty</a>
			<a href="@(clientId.HasValue ? $"/client/messages/{clientId.Value}" : "/")" class="nav-link">Messages</a>
		</div>
		<div class="nav-right">
			<span class="points-badge">@loyaltyTier • @CurrentPoints pts</span>
			<div class="user-menu">
				<div class="user-avatar-small" @onclick="ToggleDropdown">@GetInitials()</div>
				@if (isDropdownOpen)
				{
					<div class="user-dropdown">
						<button class="dropdown-item" @onclick="GoToEditProfile">
							<i class="icon icon-edit"></i> Edit Profile
						</button>
						<button class="dropdown-item" @onclick="GoToReceipts">
							<i class="icon icon-receipt"></i> View Receipts
						</button>
						<div class="dropdown-divider"></div>
						<button class="dropdown-item logout" @onclick="Logout">
							<i class="icon icon-logout"></i> Logout
						</button>
					</div>
				}
			</div>
		</div>
	</nav>

	<div class="room-selection-container">
		<!-- Left Panel - Room Options -->
		<div class="rooms-left">
			<!-- Header -->
			<div class="page-header">
				<div>
					<h1 class="page-title">Choose your room</h1>
					<p class="page-subtitle">Review available rooms for your dates and pick the one that fits best.</p>
				</div>
			</div>

			<!-- Action Bar -->
			<div class="action-bar">
				<button class="back-link" @onclick="BackToDetails">
					← Back to details
				</button>
			</div>

			<!-- Available Rooms Section -->
			<div class="available-rooms-section">
				<div class="section-header">
					<div class="section-icon">🏨</div>
					<h3>Available rooms</h3>
					<span class="step-badge">Step 2 of 3</span>
				</div>

				@if (!string.IsNullOrEmpty(errorMessage))
				{
					<div class="error-message" style="background: #ffe6e6; border: 2px solid #ff6b6b; padding: 1rem 1.5rem; margin: 1rem 0; border-radius: 12px; display: flex; align-items: center; gap: 1rem;">
						<span class="error-icon" style="font-size: 2rem;">⚠️</span>
						<div style="flex: 1;">
							<strong style="display: block; margin-bottom: 0.25rem; color: #d63031;">Booking Error</strong>
							<span style="color: #d63031;">@errorMessage</span>
						</div>
					</div>
				}

				<div class="room-options-info">
					<span class="room-count">@availableRooms.Count options for @adults adult@(adults != 1 ? "s" : "") • @checkInDate.ToString("ddd, MMM dd") – @checkOutDate.ToString("ddd, MMM dd")</span>
					<span class="selection-progress">@selectedRooms.Count of @rooms room@(rooms != 1 ? "s" : "") selected</span>
					<div class="filter-tabs">
						<button class="filter-tab active">Available</button>
					</div>
				</div>

				@if (loading)
				{
					<p>Loading available rooms...</p>
				}
				else if (availableRooms.Count == 0)
				{
					<p>No rooms available for the selected dates.</p>
				}
				else
				{
					<!-- Room Cards -->
					@foreach (var room in availableRooms)
					{
						var isSelected = selectedRooms.Any(r => r.room_id == room.room_id);
						var canSelect = !isSelected && selectedRooms.Count < rooms;
						
						<div class="room-card @(isSelected ? "selected" : "") @(!canSelect && !isSelected ? "disabled" : "")">
							<div class="room-image">
								@if (room.room_picture != null)
								{
									<img src="@($"data:image/jpeg;base64,{Convert.ToBase64String(room.room_picture)}")" alt="@room.room_name" />
								}
								else
								{
									<div class="room-placeholder">Room @room.room_number</div>
								}
							</div>
							<div class="room-details">
								<div class="room-header">
									<h4 class="room-name">@room.room_name</h4>
									<span class="room-number">Room @room.room_number</span>
								</div>
								<div class="room-features">
									<span class="feature">Floor @room.room_floor</span>
									<span class="feature">@room.room_status</span>
								</div>
								@if (!string.IsNullOrWhiteSpace(room.room_amenities))
								{
									<div class="room-amenities">
										@foreach (var amenity in room.room_amenities.Split(',', StringSplitOptions.RemoveEmptyEntries))
										{
											<span class="amenity">@amenity.Trim()</span>
										}
									</div>
								}
							</div>
							<div class="room-pricing">
								<div class="price-info">
									<div class="price-main">₱@room.room_price.ToString("N2")/night</div>
									<div class="price-total">₱@((room.room_price * NightsCount).ToString("N2")) total for @NightsCount nights</div>
								</div>
								<button class="select-room-btn @(isSelected ? "selected" : "") @(!canSelect && !isSelected ? "disabled" : "")" 
										@onclick="() => SelectRoom(room)"
										disabled="@(!canSelect && !isSelected)">
									@if (isSelected)
									{
										<text>✓ Selected</text>
									}
									else if (canSelect)
									{
										<text>Select room</text>
									}
									else
									{
										<text>Limit reached</text>
									}
								</button>
							</div>
						</div>
					}
				}

				<!-- Footer Actions -->
				<div class="footer-actions">
					<button class="continue-btn" 
							@onclick="ContinueToPayment" 
							disabled="@(selectedRooms.Count != rooms || processingBooking)">
						@if (processingBooking)
						{
							<span>🔄 Processing...</span>
						}
						else if (selectedRooms.Count == rooms)
						{
							<span>Continue to guest & payment →</span>
						}
						else
						{
							<span>Select @(rooms - selectedRooms.Count) more room@((rooms - selectedRooms.Count) > 1 ? "s" : "") to continue</span>
						}
					</button>
				</div>

				<!-- Pricing Disclaimer -->
				<div class="pricing-disclaimer">
					<p>Prices in PHP • Taxes and fees shown in summary.</p>
					<p>@loyaltyTier benefits applied where eligible.</p>
				</div>
			</div>
		</div>

		<!-- Right Panel - Stay Summary -->
		<div class="rooms-right">
			<div class="summary-card">
				<div class="summary-header">
					<div class="summary-icon">📊</div>
					<h3>Stay summary</h3>
					@if (discountPercentage > 0)
					{
						<span class="gold-badge">@loyaltyTier discount applied</span>
					}
				</div>

				<div class="summary-section">
					<h4 class="summary-title">Selected details</h4>
					<div class="summary-item">
						<span class="summary-label">InnSight Waterfront</span>
					</div>
					<div class="summary-item">
						<span class="summary-label">@adults adult@(adults != 1 ? "s" : "") • @rooms room@(rooms != 1 ? "s" : "") • @NightsCount night@(NightsCount != 1 ? "s" : "")</span>
					</div>
				</div>

				<div class="summary-section">
					<div class="check-dates">
						<div class="check-date">
							<span class="date-label">Check-in</span>
							<span class="date-value">@checkInDate.ToString("ddd, MMM dd") • 3:00 PM</span>
						</div>
						<div class="check-date">
							<span class="date-label">Check-out</span>
							<span class="date-value">@checkOutDate.ToString("ddd, MMM dd") • 11:00 AM</span>
						</div>
					</div>
				</div>

				@if (selectedRooms.Any())
				{
					<div class="summary-section">
						<h4 class="summary-title">Room selection (@selectedRooms.Count/@rooms)</h4>
						@foreach (var room in selectedRooms)
						{
							<div class="selected-room-info">
								<div class="selected-room-name">@room.room_name</div>
								<div class="selected-room-rate">Room @room.room_number • Floor @room.room_floor • ₱@room.room_price.ToString("N2")/night</div>
							</div>
						}
					</div>

					<div class="summary-section">
						<h4 class="summary-title">Pricing</h4>
						<div class="pricing-breakdown">
							@foreach (var room in selectedRooms)
							{
								<div class="pricing-row">
									<span>@room.room_name (Room @room.room_number)</span>
									<span class="price-amount">₱@((room.room_price * NightsCount).ToString("N2"))</span>
								</div>
							}
							@if (discountPercentage > 0)
							{
								<div class="pricing-row discount" style="color: #27ae60;">
									<span>@loyaltyTier discount (@discountPercentage%)</span>
									<span class="price-amount">-₱@DiscountAmount.ToString("N2")</span>
								</div>
							}
							<div class="pricing-row total">
								<span>Total for @NightsCount night@(NightsCount != 1 ? "s" : "")</span>
								<span class="price-amount">₱@TotalPrice.ToString("N2")</span>
							</div>
						</div>
						<p class="pricing-note">Minimum 50% downpayment required: ₱@MinimumDownpayment.ToString("N2")</p>
					</div>

					<div class="summary-section">
						<h4 class="summary-title">Points</h4>
						<div class="points-earning">
							<div class="points-main">Earn +@PointsEarned points</div>
							<div class="points-progress">You currently have @CurrentPoints points • @PointsToNextTier to next tier</div>
						</div>
					</div>

					<div class="summary-section">
						<h4 class="summary-title">Policies</h4>
						<ul class="policies-list">
							<li>• Free cancellation up to 24 hours before arrival for flexible rates</li>
							<li>• Late checkout subject to availability for @loyaltyTier members</li>
							<li>• Minimum 50% downpayment required, balance due at check-in</li>
						</ul>
					</div>
				}
			</div>
		</div>
	</div>
</div>

@code { 
	[Parameter] public int? clientId { get; set; }
	[Parameter] public int adults { get; set; } = 2;
	[Parameter] public int rooms { get; set; } = 1;
	[Parameter] public string? checkIn { get; set; }
	[Parameter] public string? checkOut { get; set; }

	DateTime checkInDate = DateTime.Today.AddDays(1);
	DateTime checkOutDate = DateTime.Today.AddDays(4);
	bool loading = true;
	bool processingBooking = false;
	bool isDropdownOpen = false;

	Hospitality.Models.User? user;
	List<Hospitality.Models.Room> selectedRooms = new();
	List<Hospitality.Models.Room> availableRooms = new();
	string errorMessage = "";
	
	// Loyalty-based pricing
	string loyaltyTier = "Bronze";
	decimal discountPercentage = 0;
	int CurrentPoints = 0;
	int PointsToNextTier = 2500;

	int NightsCount => (checkOutDate - checkInDate).Days;
	decimal Subtotal => selectedRooms.Sum(r => r.room_price * NightsCount);
	decimal DiscountAmount => Subtotal * (discountPercentage / 100m);
	decimal EstimatedTaxes => 0m; // No taxes and fees
	decimal TotalPrice => Subtotal - DiscountAmount;
	decimal MinimumDownpayment => TotalPrice * 0.5m;
	int PointsEarned => (int)(TotalPrice * GetPointsPerPHP());

	int GetPointsPerPHP()
	{
		return loyaltyTier.ToLower() switch
		{
			"silver" => 12,
			"gold" => 15,
			"platinum" => 20,
			_ => 10 // Bronze
		};
	}

	protected override async Task OnInitializedAsync()
	{
		// Parse dates from parameters if provided
		if (!string.IsNullOrEmpty(checkIn) && DateTime.TryParse(checkIn, out var parsedCheckIn))
		{
			checkInDate = parsedCheckIn;
		}
		if (!string.IsNullOrEmpty(checkOut) && DateTime.TryParse(checkOut, out var parsedCheckOut))
		{
			checkOutDate = parsedCheckOut;
		}

		// Load user data
		if (clientId.HasValue)
		{
			try
			{
				user = await UserService.GetUserByIdAsync(clientId.Value);
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error loading user data: {ex.Message}");
			}
		}

		// Load loyalty information
		await LoadLoyaltyInfo();
		await LoadAvailableRooms();
	}

	async Task LoadLoyaltyInfo()
	{
		if (clientId.HasValue)
		{
			try
			{
				// Get client_id from user_id
				var actualClientId = await GetClientIdFromUserIdAsync(clientId.Value);
				var loyalty = await LoyaltyService.GetLoyaltyProgramAsync(actualClientId);
				if (loyalty != null)
				{
					loyaltyTier = loyalty.current_tier;
					discountPercentage = PaymentService.GetLoyaltyDiscount(loyaltyTier);
					CurrentPoints = loyalty.total_points;
					
					// Calculate points to next tier
					var nextTier = Hospitality.Models.LoyaltyTier.GetNextTier(loyaltyTier);
					PointsToNextTier = Math.Max(0, nextTier.MinPoints - CurrentPoints);
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error loading loyalty info: {ex.Message}");
			}
		}
	}

	async Task LoadAvailableRooms()
	{
		loading = true;
		try
		{
			availableRooms = await BookingService.GetAvailableRoomsAsync(checkInDate, checkOutDate, adults);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading available rooms: {ex.Message}");
		}
		finally
		{
			loading = false;
		}
	}

	void SelectRoom(Hospitality.Models.Room room)
	{
		if (selectedRooms.Any(r => r.room_id == room.room_id))
		{
			// Room already selected, remove it
			selectedRooms.Remove(selectedRooms.First(r => r.room_id == room.room_id));
		}
		else if (selectedRooms.Count < rooms)
		{
			// Add room if we haven't reached the limit
			selectedRooms.Add(room);
		}
		StateHasChanged();
	}

	void BackToDetails()
	{
		if (clientId.HasValue)
		{
			Navigation.NavigateTo($"/booking/new/{clientId.Value}");
		}
		else
		{
			Navigation.NavigateTo("/booking/new");
		}
	}

	void ContinueToPayment()
	{
		Console.WriteLine($"✅ ContinueToPayment called. Selected rooms: {selectedRooms.Count}, Required rooms: {rooms}, ClientId: {clientId}");
		
		errorMessage = "";
		processingBooking = true;
		StateHasChanged();
		
		if (selectedRooms.Count != rooms)
		{
			errorMessage = $"Please select {rooms} room{(rooms > 1 ? "s" : "")} before continuing.";
			processingBooking = false;
			StateHasChanged();
			return;
		}

		try
		{
			// Store pending booking data in session/navigation state (NOT in database yet)
			// Navigate to payment page with booking details encoded in URL
			var roomIds = string.Join(",", selectedRooms.Select(r => r.room_id));
			var checkInStr = checkInDate.ToString("yyyy-MM-dd");
			var checkOutStr = checkOutDate.ToString("yyyy-MM-dd");
			
			var paymentUrl = $"/booking/payment/{clientId ?? 1}?checkIn={checkInStr}&checkOut={checkOutStr}&adults={adults}&rooms={roomIds}&tier={loyaltyTier}&discount={discountPercentage}&subtotal={Subtotal:F2}&taxes={EstimatedTaxes:F2}&total={TotalPrice:F2}";
			
			Console.WriteLine($"🚀 Navigating to payment (no booking created yet): {paymentUrl}");
			Navigation.NavigateTo(paymentUrl);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"❌ Error in ContinueToPayment: {ex.Message}");
			errorMessage = $"Error: {ex.Message}. Please try again.";
		}
		finally
		{
			processingBooking = false;
			StateHasChanged();
		}
	}

	string GetDashboardLink()
	{
		if (clientId.HasValue)
		{
			return $"/client/profile/{clientId.Value}";
		}
		return "/";
	}

	private async Task<int> GetClientIdFromUserIdAsync(int userId)
	{
		using var con = Hospitality.Database.DbConnection.GetConnection();
		await con.OpenAsync();

		string clientIdSql = "SELECT client_id FROM clients WHERE user_id = @userId";
		using var clientCmd = new Microsoft.Data.SqlClient.SqlCommand(clientIdSql, con);
		clientCmd.Parameters.AddWithValue("@userId", userId);
		var clientIdResult = await clientCmd.ExecuteScalarAsync();
		
		if (clientIdResult == null)
		{
			// Create client record if it doesn't exist
			string insertSql = "INSERT INTO Clients (user_id) VALUES (@userId); SELECT CAST(SCOPE_IDENTITY() AS INT);";
			using var insertCmd = new Microsoft.Data.SqlClient.SqlCommand(insertSql, con);
			insertCmd.Parameters.AddWithValue("@userId", userId);
			var newClientId = await insertCmd.ExecuteScalarAsync();
			return Convert.ToInt32(newClientId);
		}

		return Convert.ToInt32(clientIdResult);
	}

	string GetInitials()
	{
		if (user == null) return "G";
		var parts = new List<string>();
		if (!string.IsNullOrWhiteSpace(user.user_fname)) parts.Add(user.user_fname.Substring(0, 1));
		if (!string.IsNullOrWhiteSpace(user.user_lname)) parts.Add(user.user_lname.Substring(0, 1));
		return string.Join("", parts).ToUpperInvariant();
	}

	void ToggleDropdown() => isDropdownOpen = !isDropdownOpen;
	
	void GoToEditProfile()
	{
		isDropdownOpen = false;
		if (clientId.HasValue)
		{
			Navigation.NavigateTo($"/client/edit-profile/{clientId.Value}");
		}
	}

	void GoToReceipts()
	{
		isDropdownOpen = false;
		if (clientId.HasValue)
		{
			Navigation.NavigateTo($"/client/receipts/{clientId.Value}");
		}
	}

	void Logout()
	{
		isDropdownOpen = false;
		Navigation.NavigateTo("/");
	}
}
