@page "/"
@layout EmptyLayout
@inject NavigationManager Navigation
@inject Hospitality.Services.UserService UserService

<link rel="stylesheet" href="css/login.css" />

<div class="login-page">
	<div class="login-container">
		<div class="login-left">
			<div class="logo-container">
				<img src="images/InnSight_NO_BG.png" alt="InnSight Logo" class="innsight-logo" />
			</div>
			<h1 class="welcome-text">InnSight</h1>
		</div>
		<div class="login-right">
			<div class="login-form">
				<h2 class="login-title">Log in</h2>
				<form @onsubmit="HandleLogin" @onsubmit:preventDefault="true">
					<div class="form-group">
						<label class="input-label">Email</label>
						<div class="input-wrapper @(emailError ? "input-error" : "")">
							<input type="email" class="form-input" placeholder="Enter your email" @bind="email" @oninput="ClearErrors" />
						</div>
						@if (emailError)
						{
							<span class="field-error">Please enter a valid email address</span>
						}
					</div>
					<div class="form-group">
						<label class="input-label">Password</label>
						<div class="input-wrapper @(passwordError ? "input-error" : "")">
							<input type="@(showPassword ? "text" : "password")" class="form-input" placeholder="Enter your password" @bind="password" @oninput="ClearErrors" />
							<button type="button" class="toggle-password" @onclick="TogglePasswordVisibility">@(showPassword ? "ğŸ‘ï¸" : "ğŸ‘ï¸â€ğŸ—¨ï¸")</button>
						</div>
						@if (passwordError)
						{
							<span class="field-error">Please enter your password</span>
						}
					</div>
					@if (!string.IsNullOrEmpty(errorMessage))
					{
						<div class="form-group">
							<span class="field-error">@errorMessage</span>
						</div>
					}
					<button type="submit" class="btn-login" disabled="@isLoading">@(isLoading?"Authenticating...":"Log in")</button>
				</form>
				<div class="divider"><span>Or</span></div>
				<button class="btn-signup" @onclick="HandleSignup">Sign up</button>
			</div>
		</div>
	</div>
</div>

@code {
	string email=""; 
	string password=""; 
	bool showPassword=false; 
	bool isLoading=false; 
	string errorMessage="";
	bool emailError = false;
	bool passwordError = false;
	
	void TogglePasswordVisibility()=> showPassword=!showPassword;
	
	void ClearErrors()
	{
		errorMessage = "";
		emailError = false;
		passwordError = false;
	}
	
	async Task HandleLogin()
	{
		errorMessage="";
		emailError = false;
		passwordError = false;
		
		// Validate inputs
		if(string.IsNullOrWhiteSpace(email))
		{
			emailError = true;
		}
		if(string.IsNullOrWhiteSpace(password))
		{
			passwordError = true;
		}
		
		if(emailError || passwordError)
		{
			errorMessage = "Please fill in all required fields.";
			return;
		}
		
		// Basic email validation
		if(!email.Contains("@") || !email.Contains("."))
		{
			emailError = true;
			errorMessage = "Please enter a valid email address.";
			return;
		}
		
		isLoading=true;
		try 
		{
			Console.WriteLine($"Attempting login for email: {email}");
			var user = await UserService.LoginAsync(email,password);
			
			if(user==null) 
			{ 
				Console.WriteLine("Login failed: Invalid credentials");
				errorMessage="Invalid email or password. Please try again."; 
				return; 
			}
			
			Console.WriteLine($"Login successful for user ID: {user.UserId}, Role: {user.RoleName}");
			var role = user.RoleName;
			
			if(role==Hospitality.Models.UserRoles.Admin) 
			{
				Console.WriteLine("Navigating to admin dashboard");
				Navigation.NavigateTo("/admin/dashboard");
			}
			else if(role==Hospitality.Models.UserRoles.Staff) 
			{
				Console.WriteLine("Navigating to staff dashboard");
				Navigation.NavigateTo("/staff");
			}
			else if(role==Hospitality.Models.UserRoles.Client) 
			{
				var profileUrl = $"/client/profile/{user.UserId}";
				Console.WriteLine($"Navigating to client profile: {profileUrl}");
				Navigation.NavigateTo(profileUrl);
			}
			else 
			{
				Console.WriteLine($"Unknown role: {role}");
				errorMessage="Unknown user role. Please contact support.";
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Login error: {ex.Message}");
			Console.WriteLine($"Stack trace: {ex.StackTrace}");
			
			// More specific error messages based on exception type
			if (ex.Message.Contains("timeout") || ex.Message.Contains("connection"))
			{
				errorMessage = "Connection error. Please check your internet connection and try again.";
			}
			else if (ex.Message.Contains("database") || ex.Message.Contains("SQL"))
			{
				errorMessage = "Database error. Please try again later or contact support.";
			}
			else
			{
				errorMessage = "An error occurred while logging in. Please try again.";
			}
		}
		finally
		{
			isLoading=false;
		}
	}
	void HandleSignup()=> Navigation.NavigateTo("/signup");
}
