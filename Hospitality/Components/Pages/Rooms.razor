@page "/admin/rooms"
@inject NavigationManager Navigation
@inject Hospitality.Services.RoomService RoomService
@inject Hospitality.Services.BookingService BookingService

<link rel="stylesheet" href="css/admin.css" />
<link rel="stylesheet" href="css/admin-rooms-modern.css" />

<div class="admin-page">
	<aside class="admin-sidebar">
		<div class="sidebar-header">
			<img src="images/InnSight.png" alt="InnSight" class="sidebar-logo" />
			<div class="admin-console-text">
				<h4>InnSight Hotels</h4>
				<span>Admin console</span>
			</div>
		</div>
		<nav class="sidebar-nav">
			<a href="/admin/dashboard" class="nav-item"><span class="nav-icon"><i class="icon icon-dashboard"></i></span><span>DASHBOARD</span></a>
			<a href="/admin" class="nav-item"><span class="nav-icon"><i class="icon icon-users"></i></span><span>EMPLOYEES</span></a>
			<a href="/admin/rooms" class="nav-item active"><span class="nav-icon"><i class="icon icon-rooms"></i></span><span>ROOMS</span></a>
			<a href="/admin/walkin" class="nav-item"><span class="nav-icon"><i class="icon icon-bookings-detail"></i></span><span>WALK-IN</span></a>
			<a href="/admin/rewards" class="nav-item"><span class="nav-icon"><i class="icon icon-gift"></i></span><span>REWARDS</span></a>
			<a href="/admin/messages" class="nav-item"><span class="nav-icon"><i class="icon icon-messages"></i></span><span>MESSAGES</span></a>
			<a href="/admin/reports" class="nav-item"><span class="nav-icon"><i class="icon icon-reports"></i></span><span>REPORTS</span></a>
			<a href="/admin/analytics" class="nav-item"><span class="nav-icon"><i class="icon icon-analytics"></i></span><span>SALES & MARKETING</span></a>
		</nav>
	</aside>

	<main class="admin-main">
		<header class="admin-header">
			<div class="header-left">
				<h1 class="page-title">Rooms Management</h1>
				<p class="page-subtitle">Manage hotel rooms and availability</p>
			</div>
			<div class="header-actions">
				<button class="icon-btn" title="Notifications"><span class="badge-dot">3</span><i class="icon icon-notification"></i></button>
				<button class="icon-btn" title="Logout" @onclick="Logout"><i class="icon icon-logout"></i></button>
			</div>
		</header>

		<div class="toolbar">
			<div class="search-box">
				<span><i class="icon icon-search"></i></span>
				<input type="text" placeholder="Search by room name or number..." @bind="searchQuery" @bind:event="oninput" />
			</div>
			<button class="btn-sort" @onclick="SortByNumber">
				<i class="icon icon-sort"></i> Sort: @(sortAsc ? "Ascending" : "Descending")
			</button>
			<button class="btn-add-new" @onclick="ShowAddModal">
				<span>+</span> Add New Room
			</button>
		</div>

		@if (loading)
		{
			<div class="loading-container">
				<div class="spinner"></div>
				<p>Loading rooms...</p>
			</div>
		}
		else if (loadError)
		{
			<div class="error-banner">
				<span><i class="icon icon-error"></i></span>
				<span>Failed to load rooms. Please try again.</span>
				<button class="btn-add-new" style="margin-left: auto;" @onclick="LoadRoomsAsync">Retry</button>
			</div>
		}
		else if (!FilteredRooms.Any())
		{
			<div class="empty-state-modern">
				<div class="empty-state-icon">🏨</div>
				<h3 class="empty-state-title">No rooms found</h3>
				<p class="empty-state-text">@(string.IsNullOrWhiteSpace(searchQuery) ? "Start by adding your first room" : "Try adjusting your search criteria")</p>
				@if (string.IsNullOrWhiteSpace(searchQuery))
				{
					<button class="btn-add-new" @onclick="ShowAddModal">
						<span>+</span> Add Your First Room
					</button>
				}
			</div>
		}
		else
		{
			<div class="rooms-grid">
				@foreach (var room in PagedRooms)
				{
					<div class="room-card">
						<div class="room-card-image">
							@if (room.room_picture != null)
							{
								<img src="@($"data:image/jpeg;base64,{Convert.ToBase64String(room.room_picture)}")" alt="@room.room_name" />
							}
							<div class="room-number-badge-new">@room.room_number</div>
							<div class="room-status-badge-new status-@room.room_status.ToLower()">@room.room_status</div>
						</div>
						<div class="room-card-body">
							<div class="room-card-title">
								<span>@room.room_name</span>
							</div>
							<div class="room-card-price">
								P @room.room_price.ToString("N2") <small>/ night</small>
							</div>
							<div class="room-card-details">
								<div class="room-detail-item">
									<i class="icon icon-building"></i>
									Floor @room.room_floor
								</div>
								<div class="room-detail-item">
									<i class="icon icon-guests"></i>
									@room.room_occupancy guests
								</div>
							</div>
							@if (!string.IsNullOrWhiteSpace(room.room_amenities))
							{
								<div class="room-amenities-list">
									@foreach (var amenity in room.room_amenities.Split(',', StringSplitOptions.RemoveEmptyEntries).Take(3))
									{
										<span class="amenity-tag">@amenity.Trim()</span>
									}
									@if (room.room_amenities.Split(',').Length > 3)
									{
										<span class="amenity-tag">+@(room.room_amenities.Split(',').Length - 3) more</span>
									}
								</div>
							}
							<div class="room-card-actions">
								<button class="btn-room-action primary" @onclick="() => Edit(room)">
									<i class="icon icon-edit"></i> Edit
								</button>
								<button class="btn-room-action secondary" @onclick="() => BookRoom(room)">
									<i class="icon icon-calendar"></i> Book
								</button>
								<button class="btn-room-action danger" @onclick="() => Delete(room)">
									<i class="icon icon-delete"></i>
								</button>
							</div>
						</div>
					</div>
				}
			</div>

			<!-- Modern Pagination -->
			<div class="pagination-modern">
				<div class="pagination-controls">
					<button class="page-btn-modern" disabled="@(!CanPrev)" @onclick="FirstPage">
						<i class="icon icon-chevron-double-left"></i>
					</button>
					<button class="page-btn-modern" disabled="@(!CanPrev)" @onclick="PrevPage">
						<i class="icon icon-chevron-left"></i>
					</button>
					
					@foreach (var p in GetVisiblePageNumbers())
					{
						@if (p == -1)
						{
							<span class="page-dots">...</span>
						}
						else
						{
							<button class="page-btn-modern @(p == page ? "active" : "")" @onclick="() => GoPage(p)">
								@p
							</button>
						}
					}

					<button class="page-btn-modern" disabled="@(!CanNext)" @onclick="NextPage">
						<i class="icon icon-chevron-right"></i>
					</button>
					<button class="page-btn-modern" disabled="@(!CanNext)" @onclick="LastPage">
						<i class="icon icon-chevron-double-right"></i>
					</button>
				</div>

				<div class="pagination-info">
					<span class="page-info-text">
						Showing <strong>@((page - 1) * pageSize + 1)</strong> to <strong>@Math.Min(page * pageSize, FilteredRooms.Count())</strong> of <strong>@FilteredRooms.Count()</strong> rooms
					</span>
					<div class="page-size-selector">
						<label>Show:</label>
						<select class="page-size-select" @onchange="PageSizeChanged">
							<option value="8" selected="@(pageSize == 8)">8 per page</option>
							<option value="16" selected="@(pageSize == 16)">16 per page</option>
							<option value="24" selected="@(pageSize == 24)">24 per page</option>
							<option value="32" selected="@(pageSize == 32)">32 per page</option>
						</select>
					</div>
				</div>
			</div>
		}
	</main>
</div>

@if (showModal)
{
	<div class="modal-overlay" @onclick="CloseModal">
		<div class="modal-card" @onclick:stopPropagation>
			<div class="modal-header">
				<h2 class="modal-title">@(isEdit ? "Edit Room" : "New Room")</h2><button class="modal-close-btn" @onclick="CloseModal"><i class="icon icon-close"></i></button>
			</div>
			<div class="modal-body">
				@if (!string.IsNullOrEmpty(modalErrorMessage))
				{
					<div class="error-banner" style="margin-bottom: 1rem;">
						<span><i class="icon icon-error"></i></span>
						<span>@modalErrorMessage</span>
					</div>
				}
				<div class="form-grid">
					<div class="form-field @(roomNameError ? "has-error" : "")">
						<label>Room Name *</label>
						<input type="text" @bind="current.room_name" />
						@if (roomNameError)
						{
							<span class="error-text">Room name is required</span>
						}
					</div>
					<div class="form-field @(roomNumberError ? "has-error" : "")">
						<label>Room Number *</label>
						<input type="number" @bind="current.room_number" min="1" />
						@if (roomNumberError)
						{
							<span class="error-text">Valid room number is required</span>
						}
					</div>
				</div>
				<div class="form-grid">
					<div class="form-field">
						<label>Floor *</label>
						<input type="number" @bind="current.room_floor" min="1" />
					</div>
					<div class="form-field">
						<label>Price *</label>
						<input type="number" step="0.01" @bind="current.room_price" min="0" />
					</div>
				</div>
				<div class="form-grid">
					<div class="form-field">
						<label>Status *</label>
						<select @bind="current.room_status">
							<option value="Available">Available</option>
							<option value="Occupied">Occupied</option>
							<option value="Cleaning">Cleaning</option>
							<option value="Maintenance">Maintenance</option>
							<option value="Reserved">Reserved</option>
						</select>
					</div>
					<div class="form-field">
						<label>Max Occupancy (guests)</label>
						<input type="number" @bind="current.room_occupancy" min="1" max="10" />
					</div>
				</div>

				<div class="form-grid">
					<div class="form-field">
						<label>Room Photo</label>
						<InputFile OnChange="OnPhotoSelected" accept="image/jpeg,image/png" />
						@if (!string.IsNullOrEmpty(uploadError))
						{
							<span class="error-text">@uploadError</span>
						}
					</div>
					<div class="form-field">
						<label>Amenities (comma-separated)</label>
						<input type="text" @bind="amenitiesText" placeholder="WiFi, TV, Air Conditioning" />
					</div>
				</div>
			</div>

			@if (previewImage != null)
			{
				<img src="@previewImage"
					 style="width:150px;height:150px;margin-top:10px;border-radius:8px;object-fit:cover;" />
			}
			<div class="modal-footer">
				<button class="btn-modal-cancel" @onclick="CloseModal">Cancel</button><button class="btn-modal-save" @onclick="Save">@(isEdit ? "Update" : "Add") Room</button>
			</div>
		</div>
	</div>
}

@code {
	List<Hospitality.Models.Room> rooms = new();
	string searchQuery = string.Empty;
	bool showModal = false;
	bool isEdit = false;
	Hospitality.Models.Room current = new();
	bool loading = true;
	bool loadError = false;
	bool sortAsc = true;
	string errorMessage = string.Empty;
	string modalErrorMessage = string.Empty;

	IBrowserFile? uploadedPhoto;
	string? previewImage;
	string amenitiesText = string.Empty;
	string? uploadError;
	
	bool roomNameError = false;
	bool roomNumberError = false;

	int page = 1;
	int pageSize = 8;
	int totalPages => FilteredRooms.Count() == 0 ? 1 : (int)Math.Ceiling(FilteredRooms.Count() / (double)pageSize);
	List<int> PageNumbers => Enumerable.Range(1, totalPages).ToList();
	bool CanPrev => page > 1;
	bool CanNext => page < totalPages;
	List<Hospitality.Models.Room> PagedRooms => FilteredRooms.Skip((page - 1) * pageSize).Take(pageSize).ToList();

	// New method for smart pagination
	List<int> GetVisiblePageNumbers()
	{
		var pages = new List<int>();
		int maxVisible = 7;
		
		if (totalPages <= maxVisible)
		{
			return Enumerable.Range(1, totalPages).ToList();
		}
		
		pages.Add(1);
		
		int start = Math.Max(2, page - 2);
		int end = Math.Min(totalPages - 1, page + 2);
		
		if (start > 2) pages.Add(-1); // ellipsis
		
		for (int i = start; i <= end; i++)
		{
			pages.Add(i);
		}
		
		if (end < totalPages - 1) pages.Add(-1); // ellipsis
		
		pages.Add(totalPages);
		
		return pages;
	}

	protected override async Task OnInitializedAsync() { await LoadRoomsAsync(); }

	async Task LoadRoomsAsync()
	{
		loading = true;
		loadError = false;
		errorMessage = string.Empty;
		try
		{
			try
			{
				await BookingService.UpdateRoomStatusesBasedOnDatesAsync();
				Console.WriteLine("✅ Room statuses updated based on booking dates");
			}
			catch (Exception ex)
			{
				Console.WriteLine($"⚠️ Warning: Could not update room statuses: {ex.Message}");
			}

			rooms = await RoomService.GetRoomsAsync();
		}
		catch (Exception ex)
		{
			loadError = true;
			errorMessage = $"Failed to load rooms: {ex.Message}";
			Console.WriteLine($"❌ Rooms load error: {ex}");
		}
		finally { loading = false; }
	}

	IEnumerable<Hospitality.Models.Room> FilteredRooms => ApplySort(string.IsNullOrWhiteSpace(searchQuery)
		? rooms
		: rooms.Where(r => r.room_name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) || r.room_number.ToString().Contains(searchQuery, StringComparison.OrdinalIgnoreCase)));

	IEnumerable<Hospitality.Models.Room> ApplySort(IEnumerable<Hospitality.Models.Room> list) => sortAsc ? list.OrderBy(r => r.room_number) : list.OrderByDescending(r => r.room_number);
	void SortByNumber() { sortAsc = !sortAsc; }

	string GetStatusColor(string status) => status switch
	{
		"Available" => "#27ae60",
		"Occupied" => "#e74c3c",
		"Cleaning" => "#f39c12",
		"Maintenance" => "#95a5a6",
		"Reserved" => "#3498db",
		_ => "#5e1369"
	};

	void ShowAddModal()
	{
		isEdit = false;
		current = new()
		{
			room_status = "Available",
			room_floor = 1,
			room_price = 100.00m,
			room_occupancy = 2
		};
		amenitiesText = string.Empty;
		previewImage = null; 
		uploadedPhoto = null; 
		current.room_picture = null; 
		current.room_amenities = null; 
		uploadError = null;
		modalErrorMessage = string.Empty;
		roomNameError = false;
		roomNumberError = false;
		showModal = true;
	}
	
	void Edit(Hospitality.Models.Room r)
	{
		isEdit = true;
		current = new()
		{
			room_id = r.room_id,
			room_name = r.room_name,
			room_number = r.room_number,
			room_floor = r.room_floor,
			room_price = r.room_price,
			room_status = r.room_status,
			room_occupancy = r.room_occupancy,
			room_picture = r.room_picture,
			room_amenities = r.room_amenities
		};
		amenitiesText = r.room_amenities ?? string.Empty;
		previewImage = r.room_picture != null ? $"data:image/jpeg;base64,{Convert.ToBase64String(r.room_picture)}" : null;
		uploadedPhoto = null; 
		uploadError = null;
		modalErrorMessage = string.Empty;
		roomNameError = false;
		roomNumberError = false;
		showModal = true;
	}

	async Task OnPhotoSelected(InputFileChangeEventArgs e)
	{
		uploadError = null;
		uploadedPhoto = e.File;
		var contentType = uploadedPhoto.ContentType?.ToLowerInvariant();
		if (contentType != "image/jpeg" && contentType != "image/png")
		{
			uploadError = "Only JPEG/PNG allowed."; return;
		}
		var maxSize = 8 * 1024 * 1024;
		try
		{
			using var stream = uploadedPhoto.OpenReadStream(maxSize);
			using var ms = new MemoryStream();
			await stream.CopyToAsync(ms);
			current.room_picture = ms.ToArray();
			previewImage = $"data:{uploadedPhoto.ContentType};base64,{Convert.ToBase64String(current.room_picture)}";
		}
		catch (Exception ex)
		{
			uploadError = $"Upload failed: {ex.Message}";
		}
	}
	
	async Task Delete(Hospitality.Models.Room r)
	{
		try
		{
			await RoomService.DeleteRoomAsync(r.room_id);
			rooms.Remove(r);
		}
		catch (Exception ex)
		{
			errorMessage = $"Failed to delete room: {ex.Message}";
			Console.WriteLine($"❌ Delete room error: {ex.Message}");
		}
	}
	
	void BookRoom(Hospitality.Models.Room r)
	{
		Console.WriteLine($"Booking room: {r.room_number}");
	}
	
	void CloseModal()
	{
		showModal = false;
		current = new();
		modalErrorMessage = string.Empty;
		roomNameError = false;
		roomNumberError = false;
	}
	
	bool ValidateForm()
	{
		bool isValid = true;
		modalErrorMessage = string.Empty;
		roomNameError = false;
		roomNumberError = false;
		
		if (string.IsNullOrWhiteSpace(current.room_name))
		{
			roomNameError = true;
			isValid = false;
		}
		
		if (current.room_number <= 0)
		{
			roomNumberError = true;
			isValid = false;
		}
		
		if (!isValid)
		{
			modalErrorMessage = "Please fill in all required fields.";
		}
		
		return isValid;
	}
	
	async Task Save()
	{
		if (!ValidateForm()) return;
		
		try
		{
			current.room_amenities = string.IsNullOrWhiteSpace(amenitiesText) ? null : amenitiesText.Trim();
			if (isEdit)
			{
				await RoomService.UpdateRoomAsync(current);
				var existing = rooms.First(x => x.room_id == current.room_id);
				existing.room_name = current.room_name;
				existing.room_number = current.room_number;
				existing.room_floor = current.room_floor;
				existing.room_price = current.room_price;
				existing.room_status = current.room_status;
				existing.room_occupancy = current.room_occupancy;
				existing.room_picture = current.room_picture;
				existing.room_amenities = current.room_amenities;
			}
			else
			{
				var newId = await RoomService.AddRoomAsync(current);
				current.room_id = newId;
				rooms.Add(current);
			}
			CloseModal();
		}
		catch (Exception ex)
		{
			modalErrorMessage = $"Failed to save room: {ex.Message}";
			Console.WriteLine($"❌ Save room error: {ex}");
		}
	}

	async Task PrevPage() { if (CanPrev) { page--; } }
	async Task NextPage() { if (CanNext) { page++; } }
	async Task FirstPage() { if (CanPrev) { page = 1; } }
	async Task LastPage() { if (CanNext) { page = totalPages; } }
	async Task GoPage(int p) { if (p != page) { page = p; } }
	async Task PageSizeChanged(ChangeEventArgs e)
	{
		if (int.TryParse(e.Value?.ToString(), out var ps) && ps > 0) { pageSize = ps; page = 1; }
	}

	void Logout() => Navigation.NavigateTo("/");
}
