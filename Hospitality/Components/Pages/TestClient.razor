@page "/test-client/{id:int}"
@inject Hospitality.Services.UserService UserService
@inject Hospitality.Services.BookingService BookingService

<h3>Client Profile Debug Test</h3>

<div style="padding: 20px; margin: 20px; border: 1px solid #ccc;">
	<h4>Debug Information for User ID: @id</h4>
	
	@if (loading)
	{
		<p>Loading...</p>
	}
	else
	{
		<div style="margin: 10px 0;">
			<strong>User Data:</strong>
			@if (user != null)
			{
				<ul>
					<li>User ID: @user.userId</li>
					<li>First Name: @user.user_fname</li>
					<li>Email: @user.user_email</li>
					<li>Role: @user.roleName</li>
				</ul>
			}
			else
			{
				<p>? User not found</p>
			}
		</div>

		<div style="margin: 10px 0;">
			<strong>Client Record Check:</strong>
			@if (!string.IsNullOrEmpty(clientStatus))
			{
				<p>@clientStatus</p>
			}
		</div>

		<div style="margin: 10px 0;">
			<strong>Current Booking:</strong>
			@if (currentBooking != null)
			{
				<ul>
					<li>Booking ID: @currentBooking.booking_id</li>
					<li>Room: @currentBooking.room_name</li>
					<li>Check-in: @currentBooking.check_in_date</li>
					<li>Check-out: @currentBooking.check_out_date</li>
				</ul>
			}
			else
			{
				<p>No current booking</p>
			}
		</div>

		<div style="margin: 10px 0;">
			<strong>Booking History:</strong>
			@if (bookingHistory != null && bookingHistory.Any())
			{
				<p>Found @bookingHistory.Count booking(s)</p>
				@foreach (var booking in bookingHistory)
				{
					<p>- Booking #@booking.booking_id: @booking.room_name (@booking.booking_status)</p>
				}
			}
			else
			{
				<p>No booking history</p>
			}
		</div>

		@if (!string.IsNullOrEmpty(errorMessages))
		{
			<div style="background: #ffebee; padding: 10px; margin: 10px 0; border-left: 4px solid #f44336;">
				<strong>Errors:</strong>
				<pre>@errorMessages</pre>
			</div>
		}

		<div style="margin: 20px 0;">
			<a href="/client/profile/@id" style="padding: 10px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px;">
				? Back to Client Profile
			</a>
		</div>
	}
</div>

@code {
	[Parameter] public int id { get; set; }

	Hospitality.Models.User? user;
	Hospitality.Models.Booking? currentBooking;
	List<Hospitality.Models.Booking> bookingHistory = new();
	bool loading = true;
	string errorMessages = "";
	string clientStatus = "";

	protected override async Task OnInitializedAsync()
	{
		loading = true;
		var errors = new List<string>();

		try
		{
			Console.WriteLine($"Test: Loading user ID: {id}");
			user = await UserService.GetUserByIdAsync(id);
			Console.WriteLine($"Test: User result: {(user != null ? $"{user.user_fname} ({user.user_email})" : "null")}");
		}
		catch (Exception ex)
		{
			errors.Add($"User loading error: {ex.Message}");
			Console.WriteLine($"Test: User error: {ex.Message}");
		}

		if (user != null)
		{
			// Check client record
			try
			{
				using var con = Hospitality.Database.DbConnection.GetConnection();
				await con.OpenAsync();

				string checkSql = "SELECT client_id FROM Clients WHERE user_id = @userId";
				using var checkCmd = new Microsoft.Data.SqlClient.SqlCommand(checkSql, con);
				checkCmd.Parameters.AddWithValue("@userId", id);
				var result = await checkCmd.ExecuteScalarAsync();

				if (result == null)
				{
					clientStatus = "? No client record found - this is likely the issue!";
				}
				else
				{
					clientStatus = $"? Client record exists with ID: {result}";
				}
			}
			catch (Exception ex)
			{
				clientStatus = $"? Error checking client record: {ex.Message}";
			}

			try
			{
				Console.WriteLine($"Test: Loading current booking for user ID: {id}");
				currentBooking = await BookingService.GetCurrentBookingByUserIdAsync(id);
				Console.WriteLine($"Test: Current booking result: {(currentBooking != null ? $"Booking #{currentBooking.booking_id}" : "null")}");
			}
			catch (Exception ex)
			{
				errors.Add($"Current booking error: {ex.Message}");
				Console.WriteLine($"Test: Current booking error: {ex.Message}");
			}

			try
			{
				Console.WriteLine($"Test: Loading booking history for user ID: {id}");
				bookingHistory = await BookingService.GetBookingsByUserIdAsync(id);
				Console.WriteLine($"Test: Booking history result: {bookingHistory.Count} bookings");
			}
			catch (Exception ex)
			{
				errors.Add($"Booking history error: {ex.Message}");
				Console.WriteLine($"Test: Booking history error: {ex.Message}");
			}
		}

		errorMessages = string.Join("\n", errors);
		loading = false;
		StateHasChanged();
	}
}