@page "/booking/confirmation/{clientId:int}/{bookingId:int}"
@inject NavigationManager Navigation
@inject Hospitality.Services.BookingService BookingService
@inject Hospitality.Services.UserService UserService

<link rel="stylesheet" href="css/confirmation.css" />

<div class="confirmation-page">
	<!-- Payment Success Animation Overlay -->
	<div class="success-overlay @(fadeOut ? "fade-out" : "")">
		<div class="success-animation">
			<div class="checkmark-circle">
				<svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
					<circle class="checkmark-circle-bg" cx="26" cy="26" r="25" fill="none"/>
					<path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
				</svg>
			</div>
			<h2 class="success-animation-title">Payment successfully received!</h2>
			<p class="success-animation-subtitle">@statusMessage</p>
			
			<!-- Countdown indicator -->
			<div class="redirect-countdown">
				<div class="countdown-bar">
					<div class="countdown-progress"></div>
				</div>
				<p class="countdown-text">Redirecting in @countdownSeconds second@(countdownSeconds != 1 ? "s" : "")...</p>
			</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public int clientId { get; set; }
	[Parameter] public int bookingId { get; set; }

	bool fadeOut = false;
	string statusMessage = "Updating your booking...";
	int countdownSeconds = 3;

	protected override async Task OnInitializedAsync()
	{
		try
		{
			Console.WriteLine($"? Payment confirmation page loaded");
			Console.WriteLine($"   Client ID: {clientId}");
			Console.WriteLine($"   Booking ID: {bookingId}");
			
			// Update booking status to confirmed
			statusMessage = "Confirming your booking...";
			StateHasChanged();
			
			var success = await BookingService.UpdateBookingStatusAsync(bookingId, "confirmed");
			
			if (success)
			{
				Console.WriteLine($"? Booking #{bookingId} status updated to confirmed");
				statusMessage = "Booking confirmed! Redirecting to dashboard...";
			}
			else
			{
				Console.WriteLine($"?? Could not update booking status (might already be confirmed)");
				statusMessage = "Redirecting to your dashboard...";
			}
			StateHasChanged();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"? Error updating booking: {ex.Message}");
			statusMessage = "Redirecting to your dashboard...";
			StateHasChanged();
		}
		
		// Countdown animation
		for (int i = 3; i > 0; i--)
		{
			countdownSeconds = i;
			StateHasChanged();
			await Task.Delay(1000);
		}
		
		// Start fade out
		fadeOut = true;
		StateHasChanged();
		
		// Wait for fade animation
		await Task.Delay(500);
		
		// Redirect to dashboard
		Console.WriteLine($"?? Redirecting to dashboard: /client/profile/{clientId}");
		Navigation.NavigateTo($"/client/profile/{clientId}", forceLoad: true);
	}
}